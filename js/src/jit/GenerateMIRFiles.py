#
This
Source
Code
Form
is
subject
to
the
terms
of
the
Mozilla
Public
#
License
v
.
2
.
0
.
If
a
copy
of
the
MPL
was
not
distributed
with
this
#
file
You
can
obtain
one
at
http
:
/
/
mozilla
.
org
/
MPL
/
2
.
0
/
.
#
This
script
generates
jit
/
MIROpsGenerated
.
h
(
list
of
MIR
instructions
)
#
from
MIROps
.
yaml
.
import
buildconfig
import
yaml
import
six
from
collections
import
OrderedDict
from
mozbuild
.
preprocessor
import
Preprocessor
HEADER_TEMPLATE
=
"
"
"
\
/
*
This
Source
Code
Form
is
subject
to
the
terms
of
the
Mozilla
Public
 
*
License
v
.
2
.
0
.
If
a
copy
of
the
MPL
was
not
distributed
with
this
 
*
file
You
can
obtain
one
at
http
:
/
/
mozilla
.
org
/
MPL
/
2
.
0
/
.
*
/
#
ifndef
%
(
includeguard
)
s
#
define
%
(
includeguard
)
s
/
*
This
file
is
generated
by
jit
/
GenerateMIRFiles
.
py
.
Do
not
edit
!
*
/
%
(
contents
)
s
#
endif
/
/
%
(
includeguard
)
s
"
"
"
def
generate_header
(
c_out
includeguard
contents
)
:
    
c_out
.
write
(
        
HEADER_TEMPLATE
        
%
{
            
"
includeguard
"
:
includeguard
            
"
contents
"
:
contents
        
}
    
)
def
load_yaml
(
yaml_path
)
:
    
#
First
invoke
preprocessor
.
py
so
that
we
can
use
#
ifdef
JS_SIMULATOR
in
    
#
the
YAML
file
.
    
pp
=
Preprocessor
(
)
    
pp
.
context
.
update
(
buildconfig
.
defines
[
"
ALLDEFINES
"
]
)
    
pp
.
out
=
six
.
StringIO
(
)
    
pp
.
do_filter
(
"
substitution
"
)
    
pp
.
do_include
(
yaml_path
)
    
contents
=
pp
.
out
.
getvalue
(
)
    
#
Load
into
an
OrderedDict
to
ensure
order
is
preserved
.
Note
:
Python
3
.
7
+
    
#
also
preserves
ordering
for
normal
dictionaries
.
    
#
Code
based
on
https
:
/
/
stackoverflow
.
com
/
a
/
21912744
.
    
class
OrderedLoader
(
yaml
.
Loader
)
:
        
pass
    
def
construct_mapping
(
loader
node
)
:
        
loader
.
flatten_mapping
(
node
)
        
return
OrderedDict
(
loader
.
construct_pairs
(
node
)
)
    
tag
=
yaml
.
resolver
.
BaseResolver
.
DEFAULT_MAPPING_TAG
    
OrderedLoader
.
add_constructor
(
tag
construct_mapping
)
    
return
yaml
.
load
(
contents
OrderedLoader
)
def
generate_mir_header
(
c_out
yaml_path
)
:
    
"
"
"
Generate
MIROpsGenerated
.
h
from
MIROps
.
yaml
.
The
generated
file
    
has
a
list
of
MIR
ops
.
    
"
"
"
    
data
=
load_yaml
(
yaml_path
)
    
#
MIR_OPCODE_LIST
items
.
Stores
the
name
of
each
MIR
op
.
    
ops_items
=
[
]
    
for
op
in
data
:
        
name
=
op
[
"
name
"
]
        
ops_items
.
append
(
"
_
(
{
}
)
"
.
format
(
name
)
)
    
contents
=
"
#
define
MIR_OPCODE_LIST
(
_
)
\
\
\
n
"
    
contents
+
=
"
\
\
\
n
"
.
join
(
ops_items
)
    
contents
+
=
"
\
n
\
n
"
    
generate_header
(
c_out
"
jit_MIROpsGenerated_h
"
contents
)
