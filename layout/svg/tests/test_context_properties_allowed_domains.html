<
head
>
<
meta
charset
=
"
utf
-
8
"
>
<
title
>
Bug
1699892
-
SVG
context
properties
for
allowed
domains
<
/
title
>
<
script
src
=
"
/
tests
/
SimpleTest
/
SimpleTest
.
js
"
>
<
/
script
>
<
script
src
=
"
/
tests
/
SimpleTest
/
WindowSnapshot
.
js
"
>
<
/
script
>
<
link
rel
=
"
stylesheet
"
href
=
"
/
tests
/
SimpleTest
/
test
.
css
"
/
>
<
script
>
/
*
*
*
Returns
a
Promise
that
resolves
when
target
fires
a
load
event
.
*
/
function
waitForLoad
(
target
)
{
return
new
Promise
(
resolve
=
>
{
target
.
addEventListener
(
"
load
"
(
)
=
>
{
if
(
event
.
target
=
=
target
)
{
resolve
(
)
;
}
}
{
once
:
true
}
)
;
}
)
;
}
/
*
*
*
Returns
a
promise
that
resolves
when
we
receive
the
message
*
"
painted
"
from
a
child
iframe
.
(
It
sends
this
message
to
indicate
*
that
it
has
loaded
and
then
performed
at
least
one
paint
.
)
*
/
function
waitForLoadAndPaint
(
)
{
return
new
Promise
(
resolve
=
>
{
window
.
addEventListener
(
'
message
'
(
)
=
>
{
if
(
event
.
data
=
=
"
painted
"
)
{
resolve
(
)
;
}
}
{
once
:
true
}
)
;
}
)
;
}
/
*
*
*
Given
an
iframe
loads
src
in
it
and
waits
for
the
load
event
*
for
the
iframe
to
fire
.
Then
it
snapshots
the
iframe
and
returns
*
the
snapshot
.
*
*
src
can
be
a
URL
starting
with
http
or
is
otherwise
assumed
to
be
*
a
srcdoc
string
.
*
/
async
function
loadSrcImageAndSnapshot
(
frame
src
)
{
frame
.
removeAttribute
(
"
src
"
)
;
frame
.
removeAttribute
(
"
srcdoc
"
)
;
if
(
!
src
.
startsWith
(
"
http
"
)
)
{
frame
.
srcdoc
=
src
;
await
waitForLoad
(
frame
)
;
}
else
{
frame
.
src
=
src
;
await
waitForLoadAndPaint
(
)
;
}
/
/
Wait
through
two
rAF
ticks
to
be
sure
we
'
ve
gotten
at
least
one
paint
/
/
in
the
outer
document
after
the
iframe
told
us
it
was
ready
to
be
/
/
snapshotted
.
/
/
XXXdholbert
(
This
might
be
overkill
;
we
could
probably
remove
this
part
/
/
once
the
test
is
reliably
passing
.
)
await
new
Promise
(
resolve
=
>
requestAnimationFrame
(
resolve
)
)
;
await
new
Promise
(
resolve
=
>
requestAnimationFrame
(
resolve
)
)
;
return
await
snapshotWindow
(
frame
false
)
;
}
add_task
(
async
(
)
=
>
{
const
ALLOWED_DOMAIN
=
"
example
.
org
"
;
const
DISALLOWED_DOMAIN
=
"
example
.
com
"
;
const
CONTEXT_FILL_SVG
=
"
tests
/
layout
/
svg
/
tests
/
file_context_fill_fallback_red
.
html
"
;
const
ALLOWED
=
http
:
/
/
{
ALLOWED_DOMAIN
}
/
{
CONTEXT_FILL_SVG
}
;
const
DISALLOWED
=
http
:
/
/
{
DISALLOWED_DOMAIN
}
/
{
CONTEXT_FILL_SVG
}
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
svg
.
context
-
properties
.
content
.
allowed
-
domains
"
ALLOWED_DOMAIN
]
]
}
)
;
let
frame
=
document
.
getElementById
(
"
frame
"
)
;
/
/
When
the
context
properties
are
allowed
we
expect
a
green
square
.
When
they
are
/
/
not
allowed
we
expected
a
red
square
.
let
redReference
=
await
loadSrcImageAndSnapshot
(
frame
<
div
style
=
"
width
:
100px
;
height
:
100px
;
background
:
red
"
>
<
/
div
>
)
;
let
greenReference
=
await
loadSrcImageAndSnapshot
(
frame
<
div
style
=
"
width
:
100px
;
height
:
100px
;
background
:
green
"
>
<
/
div
>
)
;
let
allowedSnapshot
=
await
loadSrcImageAndSnapshot
(
frame
ALLOWED
)
;
let
disallowedSnapshot
=
await
loadSrcImageAndSnapshot
(
frame
DISALLOWED
)
;
const
kNoFuzz
=
null
;
info
(
"
Sanity
-
check
"
)
;
assertSnapshots
(
redReference
greenReference
false
kNoFuzz
"
red
"
"
green
"
)
;
info
(
"
Allowed
domain
should
be
green
"
)
;
assertSnapshots
(
allowedSnapshot
greenReference
true
kNoFuzz
ALLOWED
"
green
"
)
;
info
(
"
Disallowed
domain
should
be
red
"
)
;
assertSnapshots
(
disallowedSnapshot
redReference
true
kNoFuzz
DISALLOWED
"
red
"
)
;
}
)
;
<
/
script
>
<
/
head
>
<
body
>
<
iframe
id
=
"
frame
"
>
<
/
iframe
>
<
/
body
>
<
/
html
>
