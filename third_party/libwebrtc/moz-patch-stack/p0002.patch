From
:
Michael
Froman
<
mjfroman
mac
.
com
>
Date
:
Tue
16
Sep
2025
10
:
14
:
55
-
0500
Subject
:
(
tmp
-
cherry
-
pick
)
Revert
"
Pipe
CSRCs
down
through
the
audio
and
video
send
streams
"
(
35f6195080
)
MIME
-
Version
:
1
.
0
Content
-
Type
:
text
/
plain
;
charset
=
UTF
-
8
Content
-
Transfer
-
Encoding
:
8bit
This
reverts
commit
bf33699a2d8eeff670bc1150f7e05eec4818c398
.
Reason
for
revert
:
Part
of
CL
chain
that
breaks
downstream
projects
Bug
:
b
/
410811496
Original
change
'
s
description
:
>
Pipe
CSRCs
down
through
the
audio
and
video
send
streams
>
>
This
CL
is
part
of
a
chain
.
It
exposes
methods
on
the
audio
and
video
>
send
streams
to
set
the
CSRCs
on
the
underlying
senders
(
support
for
>
this
is
added
in
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
392940
)
.
>
These
methods
are
used
in
>
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
392980
.
>
>
Bug
:
b
/
410811496
>
Change
-
Id
:
I5e2445c70152724a9837634112e148e71d180ef5
>
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
392961
>
Reviewed
-
by
:
Harald
Alvestrand
<
hta
webrtc
.
org
>
>
Reviewed
-
by
:
Ilya
Nikolaevskiy
<
ilnik
webrtc
.
org
>
>
Commit
-
Queue
:
Helmer
Nyl
n
<
helmern
google
.
com
>
>
Reviewed
-
by
:
Jonas
Oreland
<
jonaso
webrtc
.
org
>
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
44825
}
Bug
:
b
/
410811496
No
-
Presubmit
:
true
No
-
Tree
-
Checks
:
true
No
-
Try
:
true
Change
-
Id
:
I640031b3f42f660968818ad1f04507458b57bbdb
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
395180
Bot
-
Commit
:
rubber
-
stamper
appspot
.
gserviceaccount
.
com
<
rubber
-
stamper
appspot
.
gserviceaccount
.
com
>
Reviewed
-
by
:
Jakob
Ivarsson
<
jakobi
webrtc
.
org
>
Reviewed
-
by
:
Harald
Alvestrand
<
hta
webrtc
.
org
>
Commit
-
Queue
:
Helmer
Nyl
n
<
helmern
google
.
com
>
Reviewed
-
by
:
Ilya
Nikolaevskiy
<
ilnik
webrtc
.
org
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
44837
}
-
-
-
audio
/
BUILD
.
gn
|
4
-
-
-
audio
/
audio_send_stream
.
cc
|
34
+
+
+
+
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
audio
/
audio_send_stream_unittest
.
cc
|
25
+
+
+
-
-
-
-
-
-
-
-
-
-
-
-
-
-
call
/
BUILD
.
gn
|
1
-
call
/
audio_send_stream
.
cc
|
10
+
-
-
-
-
-
-
call
/
audio_send_stream
.
h
|
3
-
-
-
call
/
video_send_stream
.
h
|
4
-
-
-
media
/
BUILD
.
gn
|
1
-
media
/
engine
/
fake_webrtc_call
.
cc
|
4
+
-
-
media
/
engine
/
fake_webrtc_call
.
h
|
3
-
-
-
video
/
video_send_stream_impl
.
cc
|
6
-
-
-
-
-
video
/
video_send_stream_impl
.
h
|
3
-
-
-
video
/
video_send_stream_impl_unittest
.
cc
|
8
-
-
-
-
-
-
13
files
changed
10
insertions
(
+
)
96
deletions
(
-
)
diff
-
-
git
a
/
audio
/
BUILD
.
gn
b
/
audio
/
BUILD
.
gn
index
07ada2d50c
.
.
0492dd24e5
100644
-
-
-
a
/
audio
/
BUILD
.
gn
+
+
+
b
/
audio
/
BUILD
.
gn
-
45
11
+
45
9
rtc_library
(
"
audio
"
)
{
"
.
.
/
api
:
frame_transformer_interface
"
"
.
.
/
api
:
function_view
"
"
.
.
/
api
:
make_ref_counted
"
-
"
.
.
/
api
:
rtc_error
"
"
.
.
/
api
:
rtp_headers
"
"
.
.
/
api
:
rtp_packet_info
"
"
.
.
/
api
:
rtp_parameters
"
-
"
.
.
/
api
:
rtp_sender_interface
"
"
.
.
/
api
:
scoped_refptr
"
"
.
.
/
api
:
sequence_checker
"
"
.
.
/
api
:
transport_api
"
-
84
7
+
82
6
rtc_library
(
"
audio
"
)
{
"
.
.
/
logging
:
rtc_stream_config
"
"
.
.
/
media
:
media_channel
"
"
.
.
/
media
:
media_channel_impl
"
-
"
.
.
/
media
:
media_constants
"
"
.
.
/
modules
/
async_audio_processing
"
"
.
.
/
modules
/
audio_coding
"
"
.
.
/
modules
/
audio_coding
:
audio_coding_module_typedefs
"
-
123
7
+
120
6
rtc_library
(
"
audio
"
)
{
"
utility
:
audio_frame_operations
"
"
/
/
third_party
/
abseil
-
cpp
/
absl
/
functional
:
any_invocable
"
"
/
/
third_party
/
abseil
-
cpp
/
absl
/
memory
"
-
"
/
/
third_party
/
abseil
-
cpp
/
absl
/
strings
"
"
/
/
third_party
/
abseil
-
cpp
/
absl
/
strings
:
string_view
"
]
}
diff
-
-
git
a
/
audio
/
audio_send_stream
.
cc
b
/
audio
/
audio_send_stream
.
cc
index
a5bca668cb
.
.
94991f76e4
100644
-
-
-
a
/
audio
/
audio_send_stream
.
cc
+
+
+
b
/
audio
/
audio_send_stream
.
cc
-
10
54
+
10
34
#
include
"
audio
/
audio_send_stream
.
h
"
-
#
include
<
cstddef
>
-
#
include
<
cstdint
>
#
include
<
memory
>
-
#
include
<
optional
>
#
include
<
string
>
#
include
<
utility
>
#
include
<
vector
>
-
#
include
"
absl
/
strings
/
str_cat
.
h
"
-
#
include
"
absl
/
strings
/
string_view
.
h
"
-
#
include
"
api
/
audio
/
audio_frame
.
h
"
#
include
"
api
/
audio
/
audio_processing
.
h
"
#
include
"
api
/
audio_codecs
/
audio_encoder
.
h
"
#
include
"
api
/
audio_codecs
/
audio_encoder_factory
.
h
"
#
include
"
api
/
audio_codecs
/
audio_format
.
h
"
-
#
include
"
api
/
call
/
bitrate_allocation
.
h
"
-
#
include
"
api
/
environment
/
environment
.
h
"
-
#
include
"
api
/
field_trials_view
.
h
"
+
#
include
"
api
/
call
/
transport
.
h
"
+
#
include
"
api
/
crypto
/
frame_encryptor_interface
.
h
"
#
include
"
api
/
function_view
.
h
"
-
#
include
"
api
/
rtc_error
.
h
"
#
include
"
api
/
rtc_event_log
/
rtc_event_log
.
h
"
-
#
include
"
api
/
rtp_parameters
.
h
"
-
#
include
"
api
/
rtp_sender_interface
.
h
"
-
#
include
"
api
/
scoped_refptr
.
h
"
-
#
include
"
api
/
sequence_checker
.
h
"
-
#
include
"
api
/
units
/
data_rate
.
h
"
-
#
include
"
api
/
units
/
data_size
.
h
"
-
#
include
"
api
/
units
/
time_delta
.
h
"
+
#
include
"
api
/
task_queue
/
task_queue_base
.
h
"
#
include
"
audio
/
audio_state
.
h
"
#
include
"
audio
/
channel_send
.
h
"
-
#
include
"
call
/
audio_state
.
h
"
-
#
include
"
call
/
bitrate_allocator
.
h
"
+
#
include
"
audio
/
conversion
.
h
"
+
#
include
"
call
/
rtp_config
.
h
"
#
include
"
call
/
rtp_transport_controller_send_interface
.
h
"
#
include
"
common_audio
/
vad
/
include
/
vad
.
h
"
#
include
"
logging
/
rtc_event_log
/
events
/
rtc_event_audio_send_stream_config
.
h
"
#
include
"
logging
/
rtc_event_log
/
rtc_stream_config
.
h
"
#
include
"
media
/
base
/
media_channel
.
h
"
-
#
include
"
media
/
base
/
media_constants
.
h
"
#
include
"
modules
/
audio_coding
/
codecs
/
cng
/
audio_encoder_cng
.
h
"
#
include
"
modules
/
audio_coding
/
codecs
/
red
/
audio_encoder_copy_red
.
h
"
-
#
include
"
modules
/
rtp_rtcp
/
include
/
report_block_data
.
h
"
-
#
include
"
modules
/
rtp_rtcp
/
include
/
rtp_rtcp_defines
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_header_extensions
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
-
#
include
"
rtc_base
/
experiments
/
struct_parameters_parser
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
-
#
include
"
rtc_base
/
race_checker
.
h
"
-
#
include
"
rtc_base
/
synchronization
/
mutex
.
h
"
#
include
"
rtc_base
/
trace_event
.
h
"
namespace
webrtc
{
-
264
10
+
244
6
void
AudioSendStream
:
:
ConfigureStream
(
rtp_rtcp_module_
-
>
SetExtmapAllowMixed
(
new_config
.
rtp
.
extmap_allow_mixed
)
;
}
-
if
(
first_time
|
|
new_config
.
rtp
.
csrcs
!
=
old_config
.
rtp
.
csrcs
)
{
-
channel_send_
-
>
SetCsrcs
(
new_config
.
rtp
.
csrcs
)
;
-
}
-
const
ExtensionIds
old_ids
=
FindExtensionIds
(
old_config
.
rtp
.
extensions
)
;
const
ExtensionIds
new_ids
=
FindExtensionIds
(
new_config
.
rtp
.
extensions
)
;
diff
-
-
git
a
/
audio
/
audio_send_stream_unittest
.
cc
b
/
audio
/
audio_send_stream_unittest
.
cc
index
be03018ccf
.
.
336323e1e5
100644
-
-
-
a
/
audio
/
audio_send_stream_unittest
.
cc
+
+
+
b
/
audio
/
audio_send_stream_unittest
.
cc
-
10
7
+
10
6
#
include
"
audio
/
audio_send_stream
.
h
"
-
#
include
<
array
>
#
include
<
cstddef
>
#
include
<
cstdint
>
#
include
<
memory
>
-
64
7
+
63
6
namespace
{
using
:
:
testing
:
:
_
;
using
:
:
testing
:
:
AnyNumber
;
-
using
:
:
testing
:
:
ElementsAreArray
;
using
:
:
testing
:
:
Eq
;
using
:
:
testing
:
:
Field
;
using
:
:
testing
:
:
InSequence
;
-
79
7
+
77
6
static
const
float
kTolerance
=
0
.
0001f
;
const
uint32_t
kSsrc
=
1234
;
const
char
*
kCName
=
"
foo_name
"
;
-
const
std
:
:
array
<
uint32_t
2
>
kCsrcs
=
{
5678
9012
}
;
const
int
kAudioLevelId
=
2
;
const
int
kTransportSequenceNumberId
=
4
;
const
int32_t
kEchoDelayMedian
=
254
;
-
190
7
+
187
6
struct
ConfigHelper
{
stream_config_
.
send_codec_spec
=
AudioSendStream
:
:
Config
:
:
SendCodecSpec
(
kIsacPayloadType
kIsacFormat
)
;
stream_config_
.
rtp
.
ssrc
=
kSsrc
;
-
stream_config_
.
rtp
.
csrcs
.
assign
(
kCsrcs
.
begin
(
)
kCsrcs
.
end
(
)
)
;
stream_config_
.
rtp
.
c_name
=
kCName
;
stream_config_
.
rtp
.
extensions
.
push_back
(
RtpExtension
(
RtpExtension
:
:
kAudioLevelUri
kAudioLevelId
)
)
;
-
238
7
+
234
6
struct
ConfigHelper
{
EXPECT_CALL
(
*
channel_send_
SetEncoderToPacketizerFrameTransformer
(
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
rtp_rtcp_
SetExtmapAllowMixed
(
false
)
)
.
Times
(
1
)
;
-
EXPECT_CALL
(
*
channel_send_
SetCsrcs
(
ElementsAreArray
(
kCsrcs
)
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
*
channel_send_
SetSendAudioLevelIndicationStatus
(
true
kAudioLevelId
)
)
.
Times
(
1
)
;
-
370
7
+
365
6
std
:
:
unique_ptr
<
AudioFrame
>
CreateAudioFrame1kHzSineWave
(
int16_t
audio_level
TEST
(
AudioSendStreamTest
ConfigToString
)
{
AudioSendStream
:
:
Config
config
(
/
*
send_transport
=
*
/
nullptr
)
;
config
.
rtp
.
ssrc
=
kSsrc
;
-
config
.
rtp
.
csrcs
.
assign
(
kCsrcs
.
begin
(
)
kCsrcs
.
end
(
)
)
;
config
.
rtp
.
c_name
=
kCName
;
config
.
min_bitrate_bps
=
12000
;
config
.
max_bitrate_bps
=
34000
;
-
386
9
+
380
9
TEST
(
AudioSendStreamTest
ConfigToString
)
{
RtpExtension
(
RtpExtension
:
:
kAudioLevelUri
kAudioLevelId
)
)
;
config
.
rtcp_report_interval_ms
=
2500
;
EXPECT_EQ
(
-
"
{
rtp
:
{
ssrc
:
1234
csrcs
:
[
5678
9012
]
extmap
-
allow
-
mixed
:
true
"
-
"
extensions
:
[
{
uri
:
urn
:
ietf
:
params
:
rtp
-
hdrext
:
ssrc
-
audio
-
level
"
-
"
id
:
2
}
]
c_name
:
foo_name
}
rtcp_report_interval_ms
:
2500
"
+
"
{
rtp
:
{
ssrc
:
1234
extmap
-
allow
-
mixed
:
true
extensions
:
[
{
uri
:
"
+
"
urn
:
ietf
:
params
:
rtp
-
hdrext
:
ssrc
-
audio
-
level
id
:
2
}
]
"
+
"
c_name
:
foo_name
}
rtcp_report_interval_ms
:
2500
"
"
send_transport
:
null
"
"
min_bitrate_bps
:
12000
max_bitrate_bps
:
34000
has
"
"
audio_network_adaptor_config
:
false
has_dscp
:
true
"
-
427
19
+
421
6
TEST
(
AudioSendStreamTest
SetMuted
)
{
}
}
-
TEST
(
AudioSendStreamTest
SetCsrcs
)
{
-
for
(
bool
use_null_audio_processing
:
{
false
true
}
)
{
-
ConfigHelper
helper
(
false
true
use_null_audio_processing
)
;
-
auto
send_stream
=
helper
.
CreateAudioSendStream
(
)
;
-
-
std
:
:
vector
<
uint32_t
>
updated_csrcs
=
{
4
5
6
}
;
-
helper
.
config
(
)
.
rtp
.
csrcs
=
updated_csrcs
;
-
EXPECT_CALL
(
*
helper
.
channel_send
(
)
-
SetCsrcs
(
ElementsAreArray
(
updated_csrcs
)
)
)
;
-
send_stream
-
>
Reconfigure
(
helper
.
config
(
)
nullptr
)
;
-
}
-
}
-
TEST
(
AudioSendStreamTest
AudioBweCorrectObjectsOnChannelProxy
)
{
for
(
bool
use_null_audio_processing
:
{
false
true
}
)
{
ConfigHelper
helper
(
true
true
use_null_audio_processing
)
;
diff
-
-
git
a
/
call
/
BUILD
.
gn
b
/
call
/
BUILD
.
gn
index
7334d82cf1
.
.
0e553eabe7
100644
-
-
-
a
/
call
/
BUILD
.
gn
+
+
+
b
/
call
/
BUILD
.
gn
-
79
7
+
79
6
rtc_library
(
"
call_interfaces
"
)
{
"
.
.
/
rtc_base
/
network
:
sent_packet
"
"
.
.
/
video
/
config
:
encoder_config
"
"
/
/
third_party
/
abseil
-
cpp
/
absl
/
functional
:
any_invocable
"
-
"
/
/
third_party
/
abseil
-
cpp
/
absl
/
strings
"
"
/
/
third_party
/
abseil
-
cpp
/
absl
/
strings
:
string_view
"
]
}
diff
-
-
git
a
/
call
/
audio_send_stream
.
cc
b
/
call
/
audio_send_stream
.
cc
index
e2f3862f54
.
.
612d27a60c
100644
-
-
-
a
/
call
/
audio_send_stream
.
cc
+
+
+
b
/
call
/
audio_send_stream
.
cc
-
14
9
+
14
9
#
include
<
string
>
-
#
include
"
absl
/
strings
/
str_cat
.
h
"
#
include
"
api
/
audio_codecs
/
audio_format
.
h
"
#
include
"
api
/
call
/
transport
.
h
"
+
#
include
"
rtc_base
/
string_encode
.
h
"
#
include
"
rtc_base
/
strings
/
string_builder
.
h
"
namespace
webrtc
{
-
59
14
+
59
6
std
:
:
string
AudioSendStream
:
:
Config
:
:
Rtp
:
:
ToString
(
)
const
{
if
(
!
mid
.
empty
(
)
)
{
ss
<
<
"
mid
:
"
<
<
mid
;
}
-
ss
<
<
"
csrcs
:
[
"
;
-
for
(
size_t
i
=
0
;
i
<
csrcs
.
size
(
)
;
+
+
i
)
{
-
ss
<
<
csrcs
[
i
]
;
-
if
(
i
!
=
csrcs
.
size
(
)
-
1
)
{
-
ss
<
<
"
"
;
-
}
-
}
-
ss
<
<
'
]
'
;
ss
<
<
"
extmap
-
allow
-
mixed
:
"
<
<
(
extmap_allow_mixed
?
"
true
"
:
"
false
"
)
;
ss
<
<
"
extensions
:
[
"
;
for
(
size_t
i
=
0
;
i
<
extensions
.
size
(
)
;
+
+
i
)
{
diff
-
-
git
a
/
call
/
audio_send_stream
.
h
b
/
call
/
audio_send_stream
.
h
index
2cc5397e31
.
.
d1b3e64ba3
100644
-
-
-
a
/
call
/
audio_send_stream
.
h
+
+
+
b
/
call
/
audio_send_stream
.
h
-
99
9
+
99
6
class
AudioSendStream
:
public
AudioSender
{
/
/
included
in
the
list
of
extensions
.
std
:
:
string
mid
;
-
/
/
The
list
of
CSRCs
to
be
included
in
the
RTP
header
.
-
std
:
:
vector
<
uint32_t
>
csrcs
;
-
/
/
Corresponds
to
the
SDP
attribute
extmap
-
allow
-
mixed
.
bool
extmap_allow_mixed
=
false
;
diff
-
-
git
a
/
call
/
video_send_stream
.
h
b
/
call
/
video_send_stream
.
h
index
bfcc15cc88
.
.
906d79598b
100644
-
-
-
a
/
call
/
video_send_stream
.
h
+
+
+
b
/
call
/
video_send_stream
.
h
-
19
7
+
19
6
#
include
<
vector
>
#
include
"
api
/
adaptation
/
resource
.
h
"
-
#
include
"
api
/
array_view
.
h
"
#
include
"
api
/
call
/
transport
.
h
"
#
include
"
api
/
crypto
/
crypto_options
.
h
"
#
include
"
api
/
frame_transformer_interface
.
h
"
-
260
9
+
259
6
class
VideoSendStream
{
/
/
TODO
:
webrtc
:
40644448
-
Make
this
pure
virtual
.
virtual
void
SetStats
(
const
Stats
&
stats
)
{
RTC_CHECK_NOTREACHED
(
)
;
}
-
/
/
Sets
the
list
of
CSRCs
to
be
included
in
every
packet
.
-
virtual
void
SetCsrcs
(
ArrayView
<
const
uint32_t
>
csrcs
)
=
0
;
-
virtual
void
GenerateKeyFrame
(
const
std
:
:
vector
<
std
:
:
string
>
&
rids
)
=
0
;
protected
:
diff
-
-
git
a
/
media
/
BUILD
.
gn
b
/
media
/
BUILD
.
gn
index
f6359d4fe7
.
.
7f92e45b4a
100644
-
-
-
a
/
media
/
BUILD
.
gn
+
+
+
b
/
media
/
BUILD
.
gn
-
810
7
+
810
6
if
(
rtc_include_tests
)
{
"
.
.
/
api
:
audio_options_api
"
"
.
.
/
api
:
call_api
"
"
.
.
/
api
:
fec_controller_api
"
-
"
.
.
/
api
:
field_trials_view
"
"
.
.
/
api
:
frame_transformer_interface
"
"
.
.
/
api
:
make_ref_counted
"
"
.
.
/
api
:
rtc_error
"
diff
-
-
git
a
/
media
/
engine
/
fake_webrtc_call
.
cc
b
/
media
/
engine
/
fake_webrtc_call
.
cc
index
64a7dc61f6
.
.
523ce610c4
100644
-
-
-
a
/
media
/
engine
/
fake_webrtc_call
.
cc
+
+
+
b
/
media
/
engine
/
fake_webrtc_call
.
cc
-
20
7
+
20
6
#
include
"
absl
/
algorithm
/
container
.
h
"
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
adaptation
/
resource
.
h
"
-
#
include
"
api
/
array_view
.
h
"
#
include
"
api
/
audio_codecs
/
audio_format
.
h
"
#
include
"
api
/
call
/
audio_sink
.
h
"
#
include
"
api
/
crypto
/
frame_decryptor_interface
.
h
"
-
47
6
+
46
7
#
include
"
call
/
video_send_stream
.
h
"
#
include
"
media
/
base
/
media_channel
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_packet_received
.
h
"
+
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_util
.
h
"
#
include
"
rtc_base
/
buffer
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
copy_on_write_buffer
.
h
"
-
294
8
+
294
6
VideoSendStream
:
:
Stats
FakeVideoSendStream
:
:
GetStats
(
)
{
return
stats_
;
}
-
void
FakeVideoSendStream
:
:
SetCsrcs
(
ArrayView
<
const
uint32_t
>
csrcs
)
{
}
-
void
FakeVideoSendStream
:
:
ReconfigureVideoEncoder
(
VideoEncoderConfig
config
)
{
ReconfigureVideoEncoder
(
std
:
:
move
(
config
)
nullptr
)
;
}
diff
-
-
git
a
/
media
/
engine
/
fake_webrtc_call
.
h
b
/
media
/
engine
/
fake_webrtc_call
.
h
index
dd93eaf512
.
.
aec1fc1626
100644
-
-
-
a
/
media
/
engine
/
fake_webrtc_call
.
h
+
+
+
b
/
media
/
engine
/
fake_webrtc_call
.
h
-
31
13
+
31
11
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
adaptation
/
resource
.
h
"
-
#
include
"
api
/
array_view
.
h
"
#
include
"
api
/
audio
/
audio_frame
.
h
"
#
include
"
api
/
audio
/
audio_mixer
.
h
"
#
include
"
api
/
audio_codecs
/
audio_format
.
h
"
#
include
"
api
/
crypto
/
frame_decryptor_interface
.
h
"
#
include
"
api
/
environment
/
environment
.
h
"
-
#
include
"
api
/
field_trials_view
.
h
"
#
include
"
api
/
frame_transformer_interface
.
h
"
#
include
"
api
/
media_types
.
h
"
#
include
"
api
/
rtp_headers
.
h
"
-
207
7
+
205
6
class
FakeVideoSendStream
final
:
public
VideoSendStream
int
GetLastHeight
(
)
const
;
int64_t
GetLastTimestamp
(
)
const
;
void
SetStats
(
const
VideoSendStream
:
:
Stats
&
stats
)
;
-
void
SetCsrcs
(
ArrayView
<
const
uint32_t
>
csrcs
)
override
;
int
num_encoder_reconfigurations
(
)
const
{
return
num_encoder_reconfigurations_
;
}
diff
-
-
git
a
/
video
/
video_send_stream_impl
.
cc
b
/
video
/
video_send_stream_impl
.
cc
index
40fb3b21a6
.
.
c0c8dff453
100644
-
-
-
a
/
video
/
video_send_stream_impl
.
cc
+
+
+
b
/
video
/
video_send_stream_impl
.
cc
-
22
7
+
22
6
#
include
"
absl
/
algorithm
/
container
.
h
"
#
include
"
api
/
adaptation
/
resource
.
h
"
-
#
include
"
api
/
array_view
.
h
"
#
include
"
api
/
call
/
bitrate_allocation
.
h
"
#
include
"
api
/
crypto
/
crypto_options
.
h
"
#
include
"
api
/
environment
/
environment
.
h
"
-
581
11
+
580
6
void
VideoSendStreamImpl
:
:
SetStats
(
const
Stats
&
stats
)
{
stats_proxy_
.
SetStats
(
stats
)
;
}
-
void
VideoSendStreamImpl
:
:
SetCsrcs
(
ArrayView
<
const
uint32_t
>
csrcs
)
{
-
RTC_DCHECK_RUN_ON
(
&
thread_checker_
)
;
-
rtp_video_sender_
-
>
SetCsrcs
(
csrcs
)
;
-
}
-
std
:
:
optional
<
float
>
VideoSendStreamImpl
:
:
GetPacingFactorOverride
(
)
const
{
return
configured_pacing_factor_
;
}
diff
-
-
git
a
/
video
/
video_send_stream_impl
.
h
b
/
video
/
video_send_stream_impl
.
h
index
a8e7858042
.
.
646d4e4c53
100644
-
-
-
a
/
video
/
video_send_stream_impl
.
h
+
+
+
b
/
video
/
video_send_stream_impl
.
h
-
21
7
+
21
6
#
include
<
vector
>
#
include
"
api
/
adaptation
/
resource
.
h
"
-
#
include
"
api
/
array_view
.
h
"
#
include
"
api
/
call
/
bitrate_allocation
.
h
"
#
include
"
api
/
environment
/
environment
.
h
"
#
include
"
api
/
fec_controller
.
h
"
-
123
8
+
122
6
class
VideoSendStreamImpl
:
public
webrtc
:
:
VideoSendStream
Stats
GetStats
(
)
override
;
void
SetStats
(
const
Stats
&
stats
)
override
;
-
void
SetCsrcs
(
ArrayView
<
const
uint32_t
>
csrcs
)
override
;
-
void
StopPermanentlyAndGetRtpStates
(
RtpStateMap
*
rtp_state_map
RtpPayloadStateMap
*
payload_state_map
)
;
void
GenerateKeyFrame
(
const
std
:
:
vector
<
std
:
:
string
>
&
rids
)
override
;
diff
-
-
git
a
/
video
/
video_send_stream_impl_unittest
.
cc
b
/
video
/
video_send_stream_impl_unittest
.
cc
index
d4c39ae18c
.
.
00b45f4637
100644
-
-
-
a
/
video
/
video_send_stream_impl_unittest
.
cc
+
+
+
b
/
video
/
video_send_stream_impl_unittest
.
cc
-
71
7
+
71
6
namespace
{
using
:
:
testing
:
:
_
;
using
:
:
testing
:
:
AllOf
;
using
:
:
testing
:
:
AnyNumber
;
-
using
:
:
testing
:
:
ElementsAreArray
;
using
:
:
testing
:
:
Eq
;
using
:
:
testing
:
:
Field
;
using
:
:
testing
:
:
Invoke
;
-
1005
13
+
1004
6
TEST_F
(
VideoSendStreamImplTest
CallsVideoStreamEncoderOnBitrateUpdate
)
{
vss_impl
-
>
Stop
(
)
;
}
-
TEST_F
(
VideoSendStreamImplTest
ForwardsCsrcsToRtpVideoSender
)
{
-
auto
vss_impl
=
CreateVideoSendStreamImpl
(
TestVideoEncoderConfig
(
)
)
;
-
std
:
:
vector
<
uint32_t
>
csrcs
=
{
1
2
3
}
;
-
EXPECT_CALL
(
rtp_video_sender_
SetCsrcs
(
ElementsAreArray
(
csrcs
)
)
)
;
-
vss_impl
-
>
SetCsrcs
(
csrcs
)
;
-
}
-
TEST_F
(
VideoSendStreamImplTest
DisablesPaddingOnPausedEncoder
)
{
int
padding_bitrate
=
0
;
auto
vss_impl
=
CreateVideoSendStreamImpl
(
TestVideoEncoderConfig
(
)
)
;
