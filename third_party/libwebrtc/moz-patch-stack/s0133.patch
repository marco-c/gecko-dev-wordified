From
:
Michael
Froman
<
mfroman
mozilla
.
com
>
Date
:
Thu
11
Sep
2025
13
:
23
:
00
-
0500
Subject
:
Bug
1988042
-
Cherry
-
pick
upstream
libwebrtc
commit
5bed8aa1d1
r
?
me
Upstream
commit
:
https
:
/
/
webrtc
.
googlesource
.
com
/
src
/
+
/
5bed8aa1d12410f58babde9c6ee8abbd490ac9bf
Remove
GetCPUFeaturesARM
(
)
Fold
GetCPUFeaturesARM
(
)
functionality
into
webrtc
:
:
cpu_info
:
:
Supports
(
)
since
it
was
only
used
to
test
for
Neon
support
.
Bug
:
webrtc
:
42228262
Change
-
Id
:
If72a90e4d4edd695256cb36f8e074e7c15f43f75
No
-
iwyu
:
Avoid
unrelated
changes
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
393783
Auto
-
Submit
:
Fredrik
Solenberg
<
solenberg
webrtc
.
org
>
Reviewed
-
by
:
Tomas
Gunnarsson
<
tommi
webrtc
.
org
>
Commit
-
Queue
:
Tomas
Gunnarsson
<
tommi
webrtc
.
org
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
44783
}
Mercurial
Revision
:
https
:
/
/
hg
.
mozilla
.
org
/
mozilla
-
central
/
rev
/
d601e431acab50f2a35d4e3e337d5d840eb8192c
-
-
-
common_audio
/
BUILD
.
gn
|
7
+
-
.
.
.
/
resampler
/
sinc_resampler_unittest
.
cc
|
5
+
-
rtc_base
/
BUILD
.
gn
|
3
+
rtc_base
/
cpu_info
.
cc
|
68
+
+
+
+
+
+
+
+
+
+
+
+
-
system_wrappers
/
BUILD
.
gn
|
30
+
-
-
-
-
-
.
.
.
/
include
/
cpu_features_wrapper
.
h
|
33
-
-
-
-
-
-
-
.
.
.
/
source
/
cpu_features_android
.
cc
|
19
-
-
-
-
system_wrappers
/
source
/
cpu_features_linux
.
cc
|
97
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
8
files
changed
71
insertions
(
+
)
191
deletions
(
-
)
delete
mode
100644
system_wrappers
/
include
/
cpu_features_wrapper
.
h
delete
mode
100644
system_wrappers
/
source
/
cpu_features_android
.
cc
delete
mode
100644
system_wrappers
/
source
/
cpu_features_linux
.
cc
diff
-
-
git
a
/
common_audio
/
BUILD
.
gn
b
/
common_audio
/
BUILD
.
gn
index
bb8a56ec06
.
.
0d14961968
100644
-
-
-
a
/
common_audio
/
BUILD
.
gn
+
+
+
b
/
common_audio
/
BUILD
.
gn
-
184
7
+
184
6
rtc_library
(
"
common_audio_c
"
)
{
"
.
.
/
rtc_base
:
compile_assert_c
"
"
.
.
/
rtc_base
:
sanitizer
"
"
.
.
/
rtc_base
/
system
:
arch
"
-
"
.
.
/
system_wrappers
"
"
third_party
/
ooura
:
fft_size_256
"
"
third_party
/
spl_sqrt_floor
"
]
-
197
10
+
196
7
rtc_library
(
"
common_audio_cc
"
)
{
"
signal_processing
/
dot_product_with_scale
.
h
"
]
-
deps
=
[
-
"
.
.
/
rtc_base
:
safe_conversions
"
-
"
.
.
/
system_wrappers
"
-
]
+
deps
=
[
"
.
.
/
rtc_base
:
safe_conversions
"
]
}
rtc_source_set
(
"
sinc_resampler
"
)
{
-
380
7
+
376
6
if
(
rtc_include_tests
&
&
!
build_with_chromium
)
{
"
.
.
/
rtc_base
:
stringutils
"
"
.
.
/
rtc_base
:
timeutils
"
"
.
.
/
rtc_base
/
system
:
arch
"
-
"
.
.
/
system_wrappers
"
"
.
.
/
test
:
fileutils
"
"
.
.
/
test
:
rtc_expect_death
"
"
.
.
/
test
:
test_main
"
diff
-
-
git
a
/
common_audio
/
resampler
/
sinc_resampler_unittest
.
cc
b
/
common_audio
/
resampler
/
sinc_resampler_unittest
.
cc
index
a6eb34d6b9
.
.
a35bd6dcf9
100644
-
-
-
a
/
common_audio
/
resampler
/
sinc_resampler_unittest
.
cc
+
+
+
b
/
common_audio
/
resampler
/
sinc_resampler_unittest
.
cc
-
26
7
+
26
6
#
include
"
rtc_base
/
cpu_info
.
h
"
#
include
"
rtc_base
/
system
/
arch
.
h
"
#
include
"
rtc_base
/
time_utils
.
h
"
-
#
include
"
system_wrappers
/
include
/
cpu_features_wrapper
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
-
122
7
+
121
7
TEST
(
SincResamplerTest
Convolve
)
{
#
if
defined
(
WEBRTC_ARCH_X86_FAMILY
)
ASSERT_TRUE
(
cpu_info
:
:
Supports
(
cpu_info
:
:
ISA
:
:
kSSE2
)
)
;
#
elif
defined
(
WEBRTC_ARCH_ARM_V7
)
-
ASSERT_TRUE
(
GetCPUFeaturesARM
(
)
&
kCPUFeatureNEON
)
;
+
ASSERT_TRUE
(
cpu_info
:
:
Supports
(
cpu_info
:
:
ISA
:
:
kNeon
)
)
;
#
endif
/
/
Initialize
a
dummy
resampler
.
-
182
7
+
181
7
TEST
(
SincResamplerTest
ConvolveBenchmark
)
{
#
if
defined
(
WEBRTC_ARCH_X86_FAMILY
)
ASSERT_TRUE
(
cpu_info
:
:
Supports
(
cpu_info
:
:
ISA
:
:
kSSE2
)
)
;
#
elif
defined
(
WEBRTC_ARCH_ARM_V7
)
-
ASSERT_TRUE
(
GetCPUFeaturesARM
(
)
&
kCPUFeatureNEON
)
;
+
ASSERT_TRUE
(
cpu_info
:
:
Supports
(
cpu_info
:
:
ISA
:
:
kNeon
)
)
;
#
endif
/
/
Benchmark
with
unaligned
input
pointer
.
diff
-
-
git
a
/
rtc_base
/
BUILD
.
gn
b
/
rtc_base
/
BUILD
.
gn
index
430318dc27
.
.
32d76a8bc8
100644
-
-
-
a
/
rtc_base
/
BUILD
.
gn
+
+
+
b
/
rtc_base
/
BUILD
.
gn
-
1941
6
+
1941
9
rtc_library
(
"
cpu_info
"
)
{
"
system
:
arch
"
"
system
:
unused
"
]
+
if
(
is_android
)
{
+
deps
+
=
[
"
/
/
third_party
/
cpu_features
:
ndk_compat
"
]
+
}
}
if
(
rtc_include_tests
)
{
diff
-
-
git
a
/
rtc_base
/
cpu_info
.
cc
b
/
rtc_base
/
cpu_info
.
cc
index
b8a1040704
.
.
a35b19042d
100644
-
-
-
a
/
rtc_base
/
cpu_info
.
cc
+
+
+
b
/
rtc_base
/
cpu_info
.
cc
-
14
14
+
14
34
#
if
defined
(
WEBRTC_WIN
)
#
include
<
windows
.
h
>
-
#
elif
defined
(
WEBRTC_LINUX
)
|
|
defined
(
WEBRTC_BSD
)
-
#
include
<
unistd
.
h
>
#
elif
defined
(
WEBRTC_MAC
)
#
include
<
sys
/
sysctl
.
h
>
+
#
elif
defined
(
WEBRTC_ANDROID
)
+
#
include
<
cpu
-
features
.
h
>
+
#
include
<
unistd
.
h
>
#
elif
defined
(
WEBRTC_FUCHSIA
)
#
include
<
zircon
/
syscalls
.
h
>
+
#
elif
defined
(
WEBRTC_LINUX
)
+
#
include
<
features
.
h
>
+
#
include
<
stdlib
.
h
>
+
#
include
<
string
.
h
>
/
/
IWYU
pragma
:
keep
+
#
include
<
unistd
.
h
>
+
+
#
ifdef
__GLIBC_PREREQ
+
#
define
WEBRTC_GLIBC_PREREQ
(
a
b
)
__GLIBC_PREREQ
(
a
b
)
+
#
else
+
#
define
WEBRTC_GLIBC_PREREQ
(
a
b
)
0
#
endif
+
#
if
WEBRTC_GLIBC_PREREQ
(
2
16
)
+
#
include
<
sys
/
auxv
.
h
>
/
/
IWYU
pragma
:
keep
+
#
else
+
#
include
<
errno
.
h
>
+
#
include
<
fcntl
.
h
>
+
#
include
<
link
.
h
>
+
#
endif
+
#
endif
/
/
WEBRTC_LINUX
+
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
#
include
"
rtc_base
/
system
/
arch
.
h
"
-
30
6
+
50
9
#
if
defined
(
WEBRTC_ARCH_X86_FAMILY
)
&
&
defined
(
_MSC_VER
)
#
include
<
intrin
.
h
>
#
endif
+
#
if
defined
(
WEBRTC_ARCH_ARM_FAMILY
)
&
&
defined
(
WEBRTC_LINUX
)
+
#
include
<
asm
/
hwcap
.
h
>
+
#
endif
/
/
Parts
of
this
file
derived
from
Chromium
'
s
base
/
cpu
.
cc
.
-
162
9
+
185
46
bool
Supports
(
ISA
instruction_set_architecture
)
{
if
(
instruction_set_architecture
=
=
ISA
:
:
kFMA3
)
{
return
0
!
=
(
cpu_info
[
2
]
&
0x00001000
)
;
}
-
#
else
/
/
WEBRTC_ARCH_X86_FAMILY
-
RTC_UNUSED
(
instruction_set_architecture
)
;
+
#
elif
defined
(
WEBRTC_ARCH_ARM_FAMILY
)
+
if
(
instruction_set_architecture
=
=
ISA
:
:
kNeon
)
{
+
#
if
defined
(
WEBRTC_ANDROID
)
+
return
0
!
=
(
android_getCpuFeatures
(
)
&
ANDROID_CPU_ARM_FEATURE_NEON
)
;
+
#
elif
defined
(
WEBRTC_LINUX
)
+
uint64_t
hwcap
=
0
;
+
#
if
WEBRTC_GLIBC_PREREQ
(
2
16
)
+
hwcap
=
getauxval
(
AT_HWCAP
)
;
+
#
else
+
ElfW
(
auxv_t
)
auxv
;
+
int
fd
=
open
(
"
/
proc
/
self
/
auxv
"
O_RDONLY
)
;
+
if
(
fd
>
=
0
)
{
+
while
(
hwcap
=
=
0
)
{
+
if
(
read
(
fd
&
auxv
sizeof
(
auxv
)
)
<
(
ssize_t
)
sizeof
(
auxv
)
)
{
+
if
(
errno
=
=
EINTR
)
{
+
continue
;
+
}
+
break
;
+
}
+
if
(
AT_HWCAP
=
=
auxv
.
a_type
)
{
+
hwcap
=
auxv
.
a_un
.
a_val
;
+
}
+
}
+
close
(
fd
)
;
+
}
+
#
endif
/
/
WEBRTC_GLIBC_PREREQ
(
2
16
)
+
#
if
defined
(
__aarch64__
)
+
if
(
(
hwcap
&
HWCAP_ASIMD
)
!
=
0
)
{
+
return
true
;
+
}
+
#
else
+
if
(
(
hwcap
&
HWCAP_NEON
)
!
=
0
)
{
+
return
true
;
+
}
#
endif
+
#
endif
/
/
WEBRTC_LINUX
+
}
+
#
else
+
RTC_UNUSED
(
instruction_set_architecture
)
;
+
#
endif
/
/
WEBRTC_ARCH_ARM_FAMILY
return
false
;
}
diff
-
-
git
a
/
system_wrappers
/
BUILD
.
gn
b
/
system_wrappers
/
BUILD
.
gn
index
6f6bc18200
.
.
913382709e
100644
-
-
-
a
/
system_wrappers
/
BUILD
.
gn
+
+
+
b
/
system_wrappers
/
BUILD
.
gn
-
16
7
+
16
6
rtc_library
(
"
system_wrappers
"
)
{
visibility
=
[
"
*
"
]
sources
=
[
"
include
/
clock
.
h
"
-
"
include
/
cpu_features_wrapper
.
h
"
"
include
/
ntp_time
.
h
"
"
source
/
clock
.
cc
"
]
-
26
39
+
25
14
rtc_library
(
"
system_wrappers
"
)
{
deps
=
[
"
.
.
/
api
:
array_view
"
"
.
.
/
api
/
units
:
timestamp
"
-
"
.
.
/
modules
:
module_api_public
"
"
.
.
/
rtc_base
:
checks
"
"
.
.
/
rtc_base
:
logging
"
+
"
.
.
/
rtc_base
:
rtc_numerics
"
"
.
.
/
rtc_base
:
safe_conversions
"
"
.
.
/
rtc_base
:
timeutils
"
"
.
.
/
rtc_base
/
synchronization
:
mutex
"
-
"
.
.
/
rtc_base
/
system
:
arch
"
"
.
.
/
rtc_base
/
system
:
rtc_export
"
]
-
-
if
(
is_android
)
{
-
if
(
build_with_mozilla
)
{
-
include_dirs
=
[
-
"
/
config
/
external
/
nspr
"
-
"
/
nsprpub
/
lib
/
ds
"
-
"
/
nsprpub
/
pr
/
include
"
-
]
-
}
else
{
-
sources
+
=
[
"
source
/
cpu_features_android
.
cc
"
]
-
deps
+
=
[
"
/
/
third_party
/
cpu_features
:
ndk_compat
"
]
-
}
-
-
libs
+
=
[
"
log
"
]
-
}
-
-
if
(
is_linux
|
|
is_chromeos
)
{
-
if
(
!
build_with_chromium
)
{
-
sources
+
=
[
"
source
/
cpu_features_linux
.
cc
"
]
-
}
-
-
libs
+
=
[
"
rt
"
]
-
}
-
if
(
is_win
)
{
libs
+
=
[
"
winmm
.
lib
"
]
-
66
8
+
40
6
rtc_library
(
"
system_wrappers
"
)
{
#
webrtc
/
rtc_base
/
win32
.
h
in
source
/
clock
.
cc
.
deps
+
=
[
"
.
.
/
rtc_base
:
win32
"
]
}
-
-
deps
+
=
[
"
.
.
/
rtc_base
:
rtc_numerics
"
]
}
rtc_library
(
"
field_trial
"
)
{
diff
-
-
git
a
/
system_wrappers
/
include
/
cpu_features_wrapper
.
h
b
/
system_wrappers
/
include
/
cpu_features_wrapper
.
h
deleted
file
mode
100644
index
8e0ba1ab88
.
.
0000000000
-
-
-
a
/
system_wrappers
/
include
/
cpu_features_wrapper
.
h
+
+
+
/
dev
/
null
-
1
33
+
0
0
-
/
*
-
*
Copyright
(
c
)
2011
The
WebRTC
project
authors
.
All
Rights
Reserved
.
-
*
-
*
Use
of
this
source
code
is
governed
by
a
BSD
-
style
license
-
*
that
can
be
found
in
the
LICENSE
file
in
the
root
of
the
source
-
*
tree
.
An
additional
intellectual
property
rights
grant
can
be
found
-
*
in
the
file
PATENTS
.
All
contributing
project
authors
may
-
*
be
found
in
the
AUTHORS
file
in
the
root
of
the
source
tree
.
-
*
/
-
-
#
ifndef
SYSTEM_WRAPPERS_INCLUDE_CPU_FEATURES_WRAPPER_H_
-
#
define
SYSTEM_WRAPPERS_INCLUDE_CPU_FEATURES_WRAPPER_H_
-
-
#
include
<
cstdint
>
-
-
namespace
webrtc
{
-
-
/
/
List
of
features
in
ARM
.
-
enum
{
-
kCPUFeatureARMv7
=
(
1
<
<
0
)
-
kCPUFeatureVFPv3
=
(
1
<
<
1
)
-
kCPUFeatureNEON
=
(
1
<
<
2
)
-
kCPUFeatureLDREXSTREX
=
(
1
<
<
3
)
-
}
;
-
-
/
/
Return
the
features
in
an
ARM
device
.
-
/
/
It
detects
the
features
in
the
hardware
platform
and
returns
supported
-
/
/
values
in
the
above
enum
definition
as
a
bitmask
.
-
uint64_t
GetCPUFeaturesARM
(
void
)
;
-
-
}
/
/
namespace
webrtc
-
-
#
endif
/
/
SYSTEM_WRAPPERS_INCLUDE_CPU_FEATURES_WRAPPER_H_
diff
-
-
git
a
/
system_wrappers
/
source
/
cpu_features_android
.
cc
b
/
system_wrappers
/
source
/
cpu_features_android
.
cc
deleted
file
mode
100644
index
95cc609b09
.
.
0000000000
-
-
-
a
/
system_wrappers
/
source
/
cpu_features_android
.
cc
+
+
+
/
dev
/
null
-
1
19
+
0
0
-
/
*
-
*
Copyright
(
c
)
2012
The
WebRTC
project
authors
.
All
Rights
Reserved
.
-
*
-
*
Use
of
this
source
code
is
governed
by
a
BSD
-
style
license
-
*
that
can
be
found
in
the
LICENSE
file
in
the
root
of
the
source
-
*
tree
.
An
additional
intellectual
property
rights
grant
can
be
found
-
*
in
the
file
PATENTS
.
All
contributing
project
authors
may
-
*
be
found
in
the
AUTHORS
file
in
the
root
of
the
source
tree
.
-
*
/
-
-
#
include
<
cpu
-
features
.
h
>
-
-
namespace
webrtc
{
-
-
uint64_t
GetCPUFeaturesARM
(
void
)
{
-
return
android_getCpuFeatures
(
)
;
-
}
-
-
}
/
/
namespace
webrtc
diff
-
-
git
a
/
system_wrappers
/
source
/
cpu_features_linux
.
cc
b
/
system_wrappers
/
source
/
cpu_features_linux
.
cc
deleted
file
mode
100644
index
2d79dde111
.
.
0000000000
-
-
-
a
/
system_wrappers
/
source
/
cpu_features_linux
.
cc
+
+
+
/
dev
/
null
-
1
97
+
0
0
-
/
*
-
*
Copyright
(
c
)
2016
The
WebRTC
project
authors
.
All
Rights
Reserved
.
-
*
-
*
Use
of
this
source
code
is
governed
by
a
BSD
-
style
license
-
*
that
can
be
found
in
the
LICENSE
file
in
the
root
of
the
source
-
*
tree
.
An
additional
intellectual
property
rights
grant
can
be
found
-
*
in
the
file
PATENTS
.
All
contributing
project
authors
may
-
*
be
found
in
the
AUTHORS
file
in
the
root
of
the
source
tree
.
-
*
/
-
-
#
include
<
features
.
h
>
-
#
include
<
stdlib
.
h
>
-
#
include
<
string
.
h
>
-
-
#
ifdef
__GLIBC_PREREQ
-
#
define
WEBRTC_GLIBC_PREREQ
(
a
b
)
__GLIBC_PREREQ
(
a
b
)
-
#
else
-
#
define
WEBRTC_GLIBC_PREREQ
(
a
b
)
0
-
#
endif
-
-
#
if
WEBRTC_GLIBC_PREREQ
(
2
16
)
-
#
include
<
sys
/
auxv
.
h
>
-
#
else
-
#
include
<
errno
.
h
>
-
#
include
<
fcntl
.
h
>
-
#
include
<
link
.
h
>
-
#
include
<
unistd
.
h
>
-
#
endif
-
-
#
include
"
rtc_base
/
system
/
arch
.
h
"
-
#
include
"
system_wrappers
/
include
/
cpu_features_wrapper
.
h
"
-
-
#
if
defined
(
WEBRTC_ARCH_ARM_FAMILY
)
-
#
include
<
asm
/
hwcap
.
h
>
-
-
namespace
webrtc
{
-
-
uint64_t
GetCPUFeaturesARM
(
void
)
{
-
uint64_t
result
=
0
;
-
int
architecture
=
0
;
-
uint64_t
hwcap
=
0
;
-
const
char
*
platform
=
NULL
;
-
#
if
WEBRTC_GLIBC_PREREQ
(
2
16
)
-
hwcap
=
getauxval
(
AT_HWCAP
)
;
-
platform
=
(
const
char
*
)
getauxval
(
AT_PLATFORM
)
;
-
#
else
-
ElfW
(
auxv_t
)
auxv
;
-
int
fd
=
open
(
"
/
proc
/
self
/
auxv
"
O_RDONLY
)
;
-
if
(
fd
>
=
0
)
{
-
while
(
hwcap
=
=
0
|
|
platform
=
=
NULL
)
{
-
if
(
read
(
fd
&
auxv
sizeof
(
auxv
)
)
<
(
ssize_t
)
sizeof
(
auxv
)
)
{
-
if
(
errno
=
=
EINTR
)
-
continue
;
-
break
;
-
}
-
switch
(
auxv
.
a_type
)
{
-
case
AT_HWCAP
:
-
hwcap
=
auxv
.
a_un
.
a_val
;
-
break
;
-
case
AT_PLATFORM
:
-
platform
=
(
const
char
*
)
auxv
.
a_un
.
a_val
;
-
break
;
-
}
-
}
-
close
(
fd
)
;
-
}
-
#
endif
/
/
WEBRTC_GLIBC_PREREQ
(
2
16
)
-
#
if
defined
(
__aarch64__
)
-
(
void
)
platform
;
-
architecture
=
8
;
-
if
(
(
hwcap
&
HWCAP_FP
)
!
=
0
)
-
result
|
=
kCPUFeatureVFPv3
;
-
if
(
(
hwcap
&
HWCAP_ASIMD
)
!
=
0
)
-
result
|
=
kCPUFeatureNEON
;
-
#
else
-
if
(
platform
!
=
NULL
)
{
-
/
*
expect
a
string
in
the
form
"
v6l
"
or
"
v7l
"
etc
.
-
*
/
-
if
(
platform
[
0
]
=
=
'
v
'
&
&
'
0
'
<
=
platform
[
1
]
&
&
platform
[
1
]
<
=
'
9
'
&
&
-
(
platform
[
2
]
=
=
'
l
'
|
|
platform
[
2
]
=
=
'
b
'
)
)
{
-
architecture
=
platform
[
1
]
-
'
0
'
;
-
}
-
}
-
if
(
(
hwcap
&
HWCAP_VFPv3
)
!
=
0
)
-
result
|
=
kCPUFeatureVFPv3
;
-
if
(
(
hwcap
&
HWCAP_NEON
)
!
=
0
)
-
result
|
=
kCPUFeatureNEON
;
-
#
endif
-
if
(
architecture
>
=
7
)
-
result
|
=
kCPUFeatureARMv7
;
-
if
(
architecture
>
=
6
)
-
result
|
=
kCPUFeatureLDREXSTREX
;
-
return
result
;
-
}
-
-
}
/
/
namespace
webrtc
-
#
endif
/
/
WEBRTC_ARCH_ARM_FAMILY
