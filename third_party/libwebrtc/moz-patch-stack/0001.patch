From
:
Michael
Froman
<
mjfroman
mac
.
com
>
Date
:
Fri
7
Mar
2025
16
:
07
:
53
-
0600
Subject
:
(
tmp
-
cherry
-
pick
)
Revert
"
Fix
tests
not
building
/
failing
when
rtc_libvpx_build_vp9
=
false
"
(
45c998d1aa
)
MIME
-
Version
:
1
.
0
Content
-
Type
:
text
/
plain
;
charset
=
UTF
-
8
Content
-
Transfer
-
Encoding
:
8bit
This
reverts
commit
23cef4ecd127269d05da039d6d74cc0668dddac6
.
Reason
for
revert
:
Breaks
downstream
projects
.
AV1
is
not
always
available
either
.
Original
change
'
s
description
:
>
Fix
tests
not
building
/
failing
when
rtc_libvpx_build_vp9
=
false
>
>
Bug
:
webrtc
:
392652316
>
Change
-
Id
:
I9213a448b8c97052d043f6a46f598d16a8806825
>
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
376221
>
Reviewed
-
by
:
Harald
Alvestrand
<
hta
webrtc
.
org
>
>
Reviewed
-
by
:
Ilya
Nikolaevskiy
<
ilnik
webrtc
.
org
>
>
Commit
-
Queue
:
Philipp
Hancke
<
phancke
meta
.
com
>
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
43970
}
Bug
:
webrtc
:
392652316
Change
-
Id
:
I71c583e23191566d65b11ee7002b220f6281ec8c
No
-
Presubmit
:
true
No
-
Tree
-
Checks
:
true
No
-
Try
:
true
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
378820
Auto
-
Submit
:
Ilya
Nikolaevskiy
<
ilnik
webrtc
.
org
>
Commit
-
Queue
:
Ilya
Nikolaevskiy
<
ilnik
webrtc
.
org
>
Owners
-
Override
:
Ilya
Nikolaevskiy
<
ilnik
webrtc
.
org
>
Bot
-
Commit
:
rubber
-
stamper
appspot
.
gserviceaccount
.
com
<
rubber
-
stamper
appspot
.
gserviceaccount
.
com
>
Reviewed
-
by
:
Bj
rn
Terelius
<
terelius
webrtc
.
org
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
43974
}
-
-
-
.
.
.
/
video_decoder_factory_template_tests
.
cc
|
2
-
.
.
.
/
video_encoder_factory_template_tests
.
cc
|
2
-
media
/
engine
/
webrtc_video_engine_unittest
.
cc
|
8
+
-
-
modules
/
video_coding
/
BUILD
.
gn
|
1
-
.
.
.
/
codecs
/
test
/
videocodec_test_libvpx
.
cc
|
12
+
-
-
-
.
.
.
er_connection_encodings_integrationtest
.
cc
|
63
+
+
+
+
+
+
+
+
-
-
-
-
-
-
-
-
-
-
-
pc
/
peer_connection_svc_integrationtest
.
cc
|
8
+
-
-
pc
/
sdp_offer_answer_unittest
.
cc
|
2
-
test
/
BUILD
.
gn
|
3
-
test
/
pc
/
e2e
/
BUILD
.
gn
|
6
-
-
test
/
pc
/
e2e
/
peer_connection_e2e_smoke_test
.
cc
|
52
+
+
-
-
-
-
-
-
-
-
-
-
-
-
-
test
/
scenario
/
BUILD
.
gn
|
5
-
-
test
/
scenario
/
video_stream_unittest
.
cc
|
16
+
-
-
-
-
.
.
.
/
ivf_video_frame_generator_unittest
.
cc
|
17
+
-
-
-
-
.
.
.
/
multi_codec_receive_tests
.
cc
|
26
+
-
-
-
-
-
-
-
video
/
quality_scaling_tests
.
cc
|
33
+
-
-
-
-
-
-
-
-
-
video
/
video_send_stream_tests
.
cc
|
14
+
-
-
-
-
video
/
video_stream_encoder_unittest
.
cc
|
7
+
-
-
18
files
changed
52
insertions
(
+
)
225
deletions
(
-
)
diff
-
-
git
a
/
api
/
video_codecs
/
test
/
video_decoder_factory_template_tests
.
cc
b
/
api
/
video_codecs
/
test
/
video_decoder_factory_template_tests
.
cc
index
aeb6049331
.
.
8cae8be0bf
100644
-
-
-
a
/
api
/
video_codecs
/
test
/
video_decoder_factory_template_tests
.
cc
+
+
+
b
/
api
/
video_codecs
/
test
/
video_decoder_factory_template_tests
.
cc
-
102
7
+
102
6
TEST
(
VideoDecoderFactoryTemplate
LibvpxVp8
)
{
EXPECT_THAT
(
factory
.
Create
(
env
formats
[
0
]
)
NotNull
(
)
)
;
}
-
#
if
defined
(
RTC_ENABLE_VP9
)
TEST
(
VideoDecoderFactoryTemplate
LibvpxVp9
)
{
const
Environment
env
=
CreateEnvironment
(
)
;
VideoDecoderFactoryTemplate
<
LibvpxVp9DecoderTemplateAdapter
>
factory
;
-
111
7
+
110
6
TEST
(
VideoDecoderFactoryTemplate
LibvpxVp9
)
{
EXPECT_THAT
(
formats
Each
(
Field
(
&
SdpVideoFormat
:
:
name
"
VP9
"
)
)
)
;
EXPECT_THAT
(
factory
.
Create
(
env
formats
[
0
]
)
NotNull
(
)
)
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
/
/
TODO
(
bugs
.
webrtc
.
org
/
13573
)
:
When
OpenH264
is
no
longer
a
conditional
build
/
/
target
remove
this
#
ifdef
.
diff
-
-
git
a
/
api
/
video_codecs
/
test
/
video_encoder_factory_template_tests
.
cc
b
/
api
/
video_codecs
/
test
/
video_encoder_factory_template_tests
.
cc
index
bd96a77311
.
.
9860104417
100644
-
-
-
a
/
api
/
video_codecs
/
test
/
video_encoder_factory_template_tests
.
cc
+
+
+
b
/
api
/
video_codecs
/
test
/
video_encoder_factory_template_tests
.
cc
-
152
7
+
152
6
TEST
(
VideoEncoderFactoryTemplate
LibvpxVp8
)
{
EXPECT_THAT
(
factory
.
Create
(
env
formats
[
0
]
)
NotNull
(
)
)
;
}
-
#
if
defined
(
RTC_ENABLE_VP9
)
TEST
(
VideoEncoderFactoryTemplate
LibvpxVp9
)
{
const
Environment
env
=
CreateEnvironment
(
)
;
VideoEncoderFactoryTemplate
<
LibvpxVp9EncoderTemplateAdapter
>
factory
;
-
163
7
+
162
6
TEST
(
VideoEncoderFactoryTemplate
LibvpxVp9
)
{
Contains
(
ScalabilityMode
:
:
kL3T3_KEY
)
)
)
)
;
EXPECT_THAT
(
factory
.
Create
(
env
formats
[
0
]
)
NotNull
(
)
)
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
/
/
TODO
(
bugs
.
webrtc
.
org
/
13573
)
:
When
OpenH264
is
no
longer
a
conditional
build
/
/
target
remove
this
#
ifdef
.
diff
-
-
git
a
/
media
/
engine
/
webrtc_video_engine_unittest
.
cc
b
/
media
/
engine
/
webrtc_video_engine_unittest
.
cc
index
fbb833b22a
.
.
693369326a
100644
-
-
-
a
/
media
/
engine
/
webrtc_video_engine_unittest
.
cc
+
+
+
b
/
media
/
engine
/
webrtc_video_engine_unittest
.
cc
-
10104
11
+
10104
11
TEST_F
(
WebRtcVideoChannelTest
SetsRidsOnSendStream
)
{
}
TEST_F
(
WebRtcVideoChannelBaseTest
EncoderSelectorSwitchCodec
)
{
-
Codec
av1
=
GetEngineCodec
(
"
AV1
"
)
;
+
Codec
vp9
=
GetEngineCodec
(
"
VP9
"
)
;
cricket
:
:
VideoSenderParameters
parameters
;
parameters
.
codecs
.
push_back
(
GetEngineCodec
(
"
VP8
"
)
)
;
-
parameters
.
codecs
.
push_back
(
av1
)
;
+
parameters
.
codecs
.
push_back
(
vp9
)
;
EXPECT_TRUE
(
send_channel_
-
>
SetSenderParameters
(
parameters
)
)
;
send_channel_
-
>
SetSend
(
true
)
;
-
10118
14
+
10118
14
TEST_F
(
WebRtcVideoChannelBaseTest
EncoderSelectorSwitchCodec
)
{
webrtc
:
:
MockEncoderSelector
encoder_selector
;
EXPECT_CALL
(
encoder_selector
OnAvailableBitrate
)
-
.
WillRepeatedly
(
Return
(
webrtc
:
:
SdpVideoFormat
:
:
AV1Profile0
(
)
)
)
;
+
.
WillRepeatedly
(
Return
(
webrtc
:
:
SdpVideoFormat
:
:
VP9Profile0
(
)
)
)
;
send_channel_
-
>
SetEncoderSelector
(
kSsrc
&
encoder_selector
)
;
time_controller_
.
AdvanceTime
(
kFrameDuration
)
;
codec
=
send_channel_
-
>
GetSendCodec
(
)
;
ASSERT_TRUE
(
codec
)
;
-
EXPECT_EQ
(
"
AV1
"
codec
-
>
name
)
;
+
EXPECT_EQ
(
"
VP9
"
codec
-
>
name
)
;
/
/
Deregister
the
encoder
selector
in
case
it
'
s
called
during
test
tear
-
down
.
send_channel_
-
>
SetEncoderSelector
(
kSsrc
nullptr
)
;
diff
-
-
git
a
/
modules
/
video_coding
/
BUILD
.
gn
b
/
modules
/
video_coding
/
BUILD
.
gn
index
e0c8ac2a03
.
.
7e044d26c3
100644
-
-
-
a
/
modules
/
video_coding
/
BUILD
.
gn
+
+
+
b
/
modules
/
video_coding
/
BUILD
.
gn
-
1067
7
+
1067
6
if
(
rtc_include_tests
)
{
"
.
.
/
.
.
/
media
:
media_constants
"
"
.
.
/
.
.
/
media
:
rtc_internal_video_codecs
"
"
.
.
/
.
.
/
media
:
rtc_simulcast_encoder_adapter
"
-
"
.
.
/
.
.
/
rtc_base
:
checks
"
"
.
.
/
.
.
/
rtc_base
:
refcount
"
"
.
.
/
.
.
/
rtc_base
:
stringutils
"
"
.
.
/
.
.
/
rtc_base
:
timeutils
"
diff
-
-
git
a
/
modules
/
video_coding
/
codecs
/
test
/
videocodec_test_libvpx
.
cc
b
/
modules
/
video_coding
/
codecs
/
test
/
videocodec_test_libvpx
.
cc
index
48bbd5b47e
.
.
a3f8daf1f6
100644
-
-
-
a
/
modules
/
video_coding
/
codecs
/
test
/
videocodec_test_libvpx
.
cc
+
+
+
b
/
modules
/
video_coding
/
codecs
/
test
/
videocodec_test_libvpx
.
cc
-
8
20
+
8
11
*
be
found
in
the
AUTHORS
file
in
the
root
of
the
source
tree
.
*
/
-
#
include
<
cstddef
>
-
#
include
<
cstdio
>
-
#
include
<
map
>
#
include
<
memory
>
-
#
include
<
utility
>
#
include
<
vector
>
-
#
include
"
api
/
environment
/
environment
.
h
"
#
include
"
api
/
test
/
create_videocodec_test_fixture
.
h
"
#
include
"
api
/
test
/
video
/
function_video_encoder_factory
.
h
"
-
#
include
"
api
/
test
/
videocodec_test_fixture
.
h
"
-
#
include
"
api
/
test
/
videocodec_test_stats
.
h
"
-
#
include
"
api
/
video
/
encoded_image
.
h
"
-
#
include
"
api
/
video
/
video_codec_type
.
h
"
#
include
"
api
/
video_codecs
/
sdp_video_format
.
h
"
#
include
"
media
/
base
/
media_constants
.
h
"
#
include
"
media
/
engine
/
internal_decoder_factory
.
h
"
-
29
7
+
20
6
#
include
"
media
/
engine
/
simulcast_encoder_adapter
.
h
"
#
include
"
modules
/
video_coding
/
utility
/
vp8_header_parser
.
h
"
#
include
"
modules
/
video_coding
/
utility
/
vp9_uncompressed_header_parser
.
h
"
-
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
testsupport
/
file_utils
.
h
"
-
393
7
+
383
7
TEST
(
VideoCodecTestLibvpx
MAYBE_SimulcastVP8
)
{
fixture
-
>
RunTest
(
rate_profiles
&
rc_thresholds
&
quality_thresholds
nullptr
)
;
}
-
#
if
defined
(
WEBRTC_ANDROID
)
or
!
defined
(
RTC_ENABLE_VP9
)
+
#
if
defined
(
WEBRTC_ANDROID
)
#
define
MAYBE_SvcVP9
DISABLED_SvcVP9
#
else
#
define
MAYBE_SvcVP9
SvcVP9
diff
-
-
git
a
/
pc
/
peer_connection_encodings_integrationtest
.
cc
b
/
pc
/
peer_connection_encodings_integrationtest
.
cc
index
2a254abc4a
.
.
d095bbac5c
100644
-
-
-
a
/
pc
/
peer_connection_encodings_integrationtest
.
cc
+
+
+
b
/
pc
/
peer_connection_encodings_integrationtest
.
cc
-
16
6
+
16
7
#
include
<
optional
>
#
include
<
set
>
#
include
<
string
>
+
#
include
<
string_view
>
#
include
<
utility
>
#
include
<
vector
>
-
26
7
+
27
6
#
include
"
api
/
audio_codecs
/
builtin_audio_encoder_factory
.
h
"
#
include
"
api
/
audio_options
.
h
"
#
include
"
api
/
field_trials
.
h
"
-
#
include
"
api
/
field_trials_view
.
h
"
#
include
"
api
/
jsep
.
h
"
#
include
"
api
/
make_ref_counted
.
h
"
#
include
"
api
/
media_stream_interface
.
h
"
-
42
8
+
42
6
#
include
"
api
/
test
/
rtc_error_matchers
.
h
"
#
include
"
api
/
units
/
data_rate
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
-
#
include
"
api
/
video_codecs
/
scalability_mode
.
h
"
-
#
include
"
api
/
video_codecs
/
sdp_video_format
.
h
"
#
include
"
media
/
base
/
codec
.
h
"
#
include
"
media
/
engine
/
fake_webrtc_video_engine
.
h
"
#
include
"
pc
/
sdp_utils
.
h
"
-
96
7
+
94
6
namespace
{
/
/
by
using
simulated
time
.
constexpr
TimeDelta
kLongTimeoutForRampingUp
=
TimeDelta
:
:
Minutes
(
1
)
;
-
#
ifdef
RTC_ENABLE_VP9
/
/
The
max
bitrate
1500
kbps
may
be
subject
to
change
in
the
future
.
What
we
'
re
/
/
interested
in
here
is
that
all
code
paths
that
result
in
L1T3
result
in
the
/
/
same
target
bitrate
which
does
not
exceed
this
limit
.
-
108
7
+
105
7
auto
EncoderImplementationIs
(
absl
:
:
string_view
impl
)
{
&
RTCOutboundRtpStreamStats
:
:
encoder_implementation
Optional
(
StrEq
(
impl
)
)
)
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
+
template
<
typename
M
>
auto
ScalabilityModeIs
(
M
matcher
)
{
return
Field
(
"
scalability_mode
"
&
RTCOutboundRtpStreamStats
:
:
scalability_mode
-
210
7
+
207
6
std
:
:
string
GetCurrentCodecMimeType
(
:
"
"
;
}
-
#
if
defined
(
RTC_ENABLE_VP9
)
const
RTCOutboundRtpStreamStats
*
FindOutboundRtpByRid
(
const
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
&
outbound_rtps
const
absl
:
:
string_view
&
rid
)
{
-
221
7
+
217
6
const
RTCOutboundRtpStreamStats
*
FindOutboundRtpByRid
(
}
return
nullptr
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
}
/
/
namespace
-
647
7
+
642
6
TEST_F
(
PeerConnectionEncodingsIntegrationTest
/
/
TODO
(
https
:
/
/
crbug
.
com
/
webrtc
/
14889
)
:
When
legacy
VP9
SVC
path
has
been
/
/
deprecated
and
removed
update
this
test
to
assert
that
simulcast
is
used
/
/
(
i
.
e
.
VP9
is
not
treated
differently
than
VP8
)
.
-
#
ifdef
RTC_ENABLE_VP9
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_LegacySvcWhenScalabilityModeNotSpecified
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
-
1320
7
+
1314
6
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_TargetBitrate_StandardL1T3
)
{
DataRate
target_bitrate
=
DataRate
:
:
BitsPerSec
(
*
outbound_rtp
-
>
target_bitrate
)
;
EXPECT_LE
(
target_bitrate
.
kbps
(
)
kVp9ExpectedMaxBitrateForL1T3
.
kbps
(
)
)
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
TEST_F
(
PeerConnectionEncodingsIntegrationTest
SimulcastProducesUniqueSsrcAndRtxSsrcs
)
{
-
1440
15
+
1433
15
TEST_F
(
PeerConnectionEncodingsIntegrationTest
/
*
audio
=
*
/
false
{
}
/
*
video
=
*
/
true
{
.
width
=
1280
.
height
=
720
}
)
;
rtc
:
:
scoped_refptr
<
VideoTrackInterface
>
track
=
stream
-
>
GetVideoTracks
(
)
[
0
]
;
-
std
:
:
optional
<
RtpCodecCapability
>
av1
=
+
std
:
:
optional
<
RtpCodecCapability
>
vp9
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
-
"
av1
"
)
;
-
ASSERT_TRUE
(
av1
)
;
+
"
vp9
"
)
;
+
ASSERT_TRUE
(
vp9
)
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
RtpEncodingParameters
encoding_parameters
;
-
encoding_parameters
.
codec
=
av1
;
+
encoding_parameters
.
codec
=
vp9
;
encoding_parameters
.
scalability_mode
=
"
L3T3
"
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
-
1457
7
+
1450
7
TEST_F
(
PeerConnectionEncodingsIntegrationTest
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
audio_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
RtpParameters
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
-
EXPECT_EQ
(
*
parameters
.
encodings
[
0
]
.
codec
*
av1
)
;
+
EXPECT_EQ
(
*
parameters
.
encodings
[
0
]
.
codec
*
vp9
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
-
1472
7
+
1465
7
TEST_F
(
PeerConnectionEncodingsIntegrationTest
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
std
:
:
string
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
-
EXPECT_STRCASEEQ
(
(
"
video
/
"
+
av1
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
+
EXPECT_STRCASEEQ
(
(
"
video
/
"
+
vp9
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
EXPECT_EQ
(
outbound_rtps
[
0
]
-
>
scalability_mode
.
value
(
)
"
L3T3
"
)
;
}
-
1573
20
+
1566
20
TEST_F
(
PeerConnectionEncodingsIntegrationTest
/
*
audio
=
*
/
false
{
}
/
*
video
=
*
/
true
{
.
width
=
1280
.
height
=
720
}
)
;
rtc
:
:
scoped_refptr
<
VideoTrackInterface
>
track
=
stream
-
>
GetVideoTracks
(
)
[
0
]
;
-
std
:
:
optional
<
RtpCodecCapability
>
av1
=
+
std
:
:
optional
<
RtpCodecCapability
>
vp9
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
-
"
av1
"
)
;
+
"
vp9
"
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
track
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
video_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
RtpParameters
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
-
parameters
.
encodings
[
0
]
.
codec
=
av1
;
+
parameters
.
encodings
[
0
]
.
codec
=
vp9
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3
"
;
EXPECT_TRUE
(
video_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
-
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
av1
)
;
+
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
vp9
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
scalability_mode
"
L3T3
"
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
-
1602
7
+
1595
7
TEST_F
(
PeerConnectionEncodingsIntegrationTest
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
std
:
:
string
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
-
EXPECT_STRCASEEQ
(
(
"
video
/
"
+
av1
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
+
EXPECT_STRCASEEQ
(
(
"
video
/
"
+
vp9
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
EXPECT_EQ
(
outbound_rtps
[
0
]
-
>
scalability_mode
.
value_or
(
"
"
)
"
L3T3
"
)
;
}
-
1617
9
+
1610
9
TEST_F
(
PeerConnectionEncodingsIntegrationTest
/
*
audio
=
*
/
false
{
}
/
*
video
=
*
/
true
{
.
width
=
1280
.
height
=
720
}
)
;
rtc
:
:
scoped_refptr
<
VideoTrackInterface
>
track
=
stream
-
>
GetVideoTracks
(
)
[
0
]
;
-
std
:
:
optional
<
RtpCodecCapability
>
av1
=
+
std
:
:
optional
<
RtpCodecCapability
>
vp9
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
-
"
av1
"
)
;
+
"
vp9
"
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
track
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
video_transceiver
=
-
1634
16
+
1627
16
TEST_F
(
PeerConnectionEncodingsIntegrationTest
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
std
:
:
string
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
-
EXPECT_STRCASENE
(
(
"
audio
/
"
+
av1
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
+
EXPECT_STRCASENE
(
(
"
audio
/
"
+
vp9
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
std
:
:
string
last_codec_id
=
outbound_rtps
[
0
]
-
>
codec_id
.
value
(
)
;
RtpParameters
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
-
parameters
.
encodings
[
0
]
.
codec
=
av1
;
+
parameters
.
encodings
[
0
]
.
codec
=
vp9
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3
"
;
EXPECT_TRUE
(
video_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
-
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
av1
)
;
+
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
vp9
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
scalability_mode
"
L3T3
"
)
;
auto
error_or_stats
=
GetStatsUntil
(
-
1655
7
+
1648
7
TEST_F
(
PeerConnectionEncodingsIntegrationTest
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
-
EXPECT_STRCASEEQ
(
(
"
video
/
"
+
av1
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
+
EXPECT_STRCASEEQ
(
(
"
video
/
"
+
vp9
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
EXPECT_EQ
(
outbound_rtps
[
0
]
-
>
scalability_mode
.
value
(
)
"
L3T3
"
)
;
}
-
2217
10
+
2210
10
TEST_F
(
PeerConnectionEncodingsIntegrationTest
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp8
"
)
;
ASSERT_TRUE
(
vp8
)
;
-
std
:
:
optional
<
RtpCodecCapability
>
av1
=
+
std
:
:
optional
<
RtpCodecCapability
>
vp9
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
-
"
av1
"
)
;
-
ASSERT_TRUE
(
av1
)
;
+
"
vp9
"
)
;
+
ASSERT_TRUE
(
vp9
)
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
-
2230
7
+
2223
7
TEST_F
(
PeerConnectionEncodingsIntegrationTest
encoding_parameters
.
scale_resolution_down_by
=
2
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
encoding_parameters
.
rid
=
"
f
"
;
-
encoding_parameters
.
codec
=
av1
;
+
encoding_parameters
.
codec
=
vp9
;
encoding_parameters
.
scale_resolution_down_by
=
1
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
-
2255
10
+
2248
10
TEST_F
(
PeerConnectionEncodingsIntegrationTest
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp8
"
)
;
ASSERT_TRUE
(
vp8
)
;
-
std
:
:
optional
<
RtpCodecCapability
>
av1
=
+
std
:
:
optional
<
RtpCodecCapability
>
vp9
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
-
"
av1
"
)
;
-
ASSERT_TRUE
(
av1
)
;
+
"
vp9
"
)
;
+
ASSERT_TRUE
(
vp9
)
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
-
2268
7
+
2261
7
TEST_F
(
PeerConnectionEncodingsIntegrationTest
encoding_parameters
.
scale_resolution_down_by
=
2
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
encoding_parameters
.
rid
=
"
f
"
;
-
encoding_parameters
.
codec
=
av1
;
+
encoding_parameters
.
codec
=
vp9
;
encoding_parameters
.
scale_resolution_down_by
=
1
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
-
3066
9
+
3059
7
TEST_P
(
PeerConnectionEncodingsIntegrationParameterizedTest
INSTANTIATE_TEST_SUITE_P
(
StandardPath
PeerConnectionEncodingsIntegrationParameterizedTest
:
:
testing
:
:
Values
(
"
VP8
"
-
#
ifdef
RTC_ENABLE_VP9
"
VP9
"
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
#
if
defined
(
WEBRTC_USE_H264
)
"
H264
"
#
endif
/
/
defined
(
WEBRTC_USE_H264
)
diff
-
-
git
a
/
pc
/
peer_connection_svc_integrationtest
.
cc
b
/
pc
/
peer_connection_svc_integrationtest
.
cc
index
29617aec5c
.
.
5366fc59fd
100644
-
-
-
a
/
pc
/
peer_connection_svc_integrationtest
.
cc
+
+
+
b
/
pc
/
peer_connection_svc_integrationtest
.
cc
-
150
7
+
150
6
TEST_F
(
PeerConnectionSVCIntegrationTest
EXPECT_TRUE
(
result
.
ok
(
)
)
;
}
-
#
if
defined
(
RTC_ENABLE_VP9
)
TEST_F
(
PeerConnectionSVCIntegrationTest
SetParametersAcceptsL3T3WithVP9AfterNegotiation
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
-
176
7
+
175
6
TEST_F
(
PeerConnectionSVCIntegrationTest
auto
result
=
transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
;
EXPECT_TRUE
(
result
.
ok
(
)
)
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
TEST_F
(
PeerConnectionSVCIntegrationTest
SetParametersRejectsL3T3WithVP8AfterNegotiation
)
{
-
248
17
+
246
17
TEST_F
(
PeerConnectionSVCIntegrationTest
FallbackToL1Tx
)
{
caller
(
)
-
>
pc_factory
(
)
-
>
GetRtpReceiverCapabilities
(
cricket
:
:
MEDIA_TYPE_VIDEO
)
;
std
:
:
vector
<
RtpCodecCapability
>
send_codecs
=
capabilities
.
codecs
;
-
/
/
Only
keep
AV1
in
the
caller
+
/
/
Only
keep
VP9
in
the
caller
send_codecs
.
erase
(
std
:
:
partition
(
send_codecs
.
begin
(
)
send_codecs
.
end
(
)
[
]
(
const
auto
&
codec
)
-
>
bool
{
return
codec
.
name
=
=
-
cricket
:
:
kAv1CodecName
;
+
cricket
:
:
kVp9CodecName
;
}
)
send_codecs
.
end
(
)
)
;
ASSERT_FALSE
(
send_codecs
.
empty
(
)
)
;
caller_transceiver
-
>
SetCodecPreferences
(
send_codecs
)
;
-
/
/
L3T3
should
be
supported
by
AV1
+
/
/
L3T3
should
be
supported
by
VP9
RtpParameters
parameters
=
caller_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3
"
;
diff
-
-
git
a
/
pc
/
sdp_offer_answer_unittest
.
cc
b
/
pc
/
sdp_offer_answer_unittest
.
cc
index
aa5d42c303
.
.
2a7e9ce5cb
100644
-
-
-
a
/
pc
/
sdp_offer_answer_unittest
.
cc
+
+
+
b
/
pc
/
sdp_offer_answer_unittest
.
cc
-
654
7
+
654
6
TEST_F
(
SdpOfferAnswerTest
SimulcastAnswerWithNoRidsIsRejected
)
{
EXPECT_TRUE
(
pc
-
>
SetRemoteDescription
(
std
:
:
move
(
rejected_answer
)
)
)
;
}
-
#
if
defined
(
RTC_ENABLE_VP9
)
/
/
TODO
:
bugs
.
webrtc
.
org
/
362277533
-
reenable
before
launch
.
TEST_F
(
SdpOfferAnswerTest
DISABLED_SimulcastOfferWithMixedCodec
)
{
auto
pc
=
CreatePeerConnection
(
-
755
7
+
754
6
TEST_F
(
SdpOfferAnswerTest
SimulcastAnswerWithPayloadType
)
{
EXPECT_TRUE
(
pc
-
>
SetLocalDescription
(
std
:
:
move
(
answer
)
)
)
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
TEST_F
(
SdpOfferAnswerTest
ExpectAllSsrcsSpecifiedInSsrcGroupFid
)
{
auto
pc
=
CreatePeerConnection
(
)
;
diff
-
-
git
a
/
test
/
BUILD
.
gn
b
/
test
/
BUILD
.
gn
index
e59c0bb8e8
.
.
598c196bad
100644
-
-
-
a
/
test
/
BUILD
.
gn
+
+
+
b
/
test
/
BUILD
.
gn
-
737
7
+
737
6
if
(
rtc_include_tests
)
{
"
.
.
/
api
/
units
:
time_delta
"
"
.
.
/
api
/
units
:
timestamp
"
"
.
.
/
api
/
video
:
encoded_image
"
-
"
.
.
/
api
/
video
:
video_bitrate_allocation
"
"
.
.
/
api
/
video
:
video_frame
"
"
.
.
/
api
/
video_codecs
:
builtin_video_decoder_factory
"
"
.
.
/
api
/
video_codecs
:
builtin_video_encoder_factory
"
-
755
9
+
754
7
if
(
rtc_include_tests
)
{
"
.
.
/
modules
/
video_coding
:
webrtc_vp8
"
"
.
.
/
modules
/
video_coding
:
webrtc_vp9
"
"
.
.
/
modules
/
video_coding
/
svc
:
scalability_mode_util
"
-
"
.
.
/
rtc_base
:
checks
"
"
.
.
/
rtc_base
:
criticalsection
"
-
"
.
.
/
rtc_base
:
macromagic
"
"
.
.
/
rtc_base
:
rtc_base_tests_utils
"
"
.
.
/
rtc_base
:
rtc_event
"
"
.
.
/
rtc_base
:
threading
"
diff
-
-
git
a
/
test
/
pc
/
e2e
/
BUILD
.
gn
b
/
test
/
pc
/
e2e
/
BUILD
.
gn
index
c7cc29923f
.
.
92f6b41a4b
100644
-
-
-
a
/
test
/
pc
/
e2e
/
BUILD
.
gn
+
+
+
b
/
test
/
pc
/
e2e
/
BUILD
.
gn
-
315
24
+
315
18
if
(
!
build_with_chromium
)
{
"
.
.
/
.
.
/
.
.
/
api
:
create_network_emulation_manager
"
"
.
.
/
.
.
/
.
.
/
api
:
create_peer_connection_quality_test_frame_generator
"
"
.
.
/
.
.
/
.
.
/
api
:
create_peerconnection_quality_test_fixture
"
-
"
.
.
/
.
.
/
.
.
/
api
:
function_view
"
"
.
.
/
.
.
/
.
.
/
api
:
libjingle_peerconnection_api
"
"
.
.
/
.
.
/
.
.
/
api
:
media_stream_interface
"
"
.
.
/
.
.
/
.
.
/
api
:
network_emulation_manager_api
"
"
.
.
/
.
.
/
.
.
/
api
:
peer_connection_quality_test_fixture_api
"
-
"
.
.
/
.
.
/
.
.
/
api
:
rtp_parameters
"
"
.
.
/
.
.
/
.
.
/
api
:
scoped_refptr
"
"
.
.
/
.
.
/
.
.
/
api
:
simulated_network_api
"
"
.
.
/
.
.
/
.
.
/
api
/
audio_codecs
:
builtin_audio_decoder_factory
"
"
.
.
/
.
.
/
.
.
/
api
/
audio_codecs
:
builtin_audio_encoder_factory
"
"
.
.
/
.
.
/
.
.
/
api
/
test
/
metrics
:
global_metrics_logger_and_exporter
"
-
"
.
.
/
.
.
/
.
.
/
api
/
test
/
network_emulation
:
network_emulation
"
"
.
.
/
.
.
/
.
.
/
api
/
test
/
pclf
:
media_configuration
"
"
.
.
/
.
.
/
.
.
/
api
/
test
/
pclf
:
media_quality_test_params
"
"
.
.
/
.
.
/
.
.
/
api
/
test
/
pclf
:
peer_configurer
"
-
"
.
.
/
.
.
/
.
.
/
api
/
transport
:
bitrate_settings
"
-
"
.
.
/
.
.
/
.
.
/
api
/
units
:
data_rate
"
-
"
.
.
/
.
.
/
.
.
/
api
/
units
:
time_delta
"
"
.
.
/
.
.
/
.
.
/
api
/
video_codecs
:
builtin_video_decoder_factory
"
"
.
.
/
.
.
/
.
.
/
api
/
video_codecs
:
builtin_video_encoder_factory
"
"
.
.
/
.
.
/
.
.
/
media
:
media_constants
"
diff
-
-
git
a
/
test
/
pc
/
e2e
/
peer_connection_e2e_smoke_test
.
cc
b
/
test
/
pc
/
e2e
/
peer_connection_e2e_smoke_test
.
cc
index
93bffa7b6b
.
.
e36e4d74f0
100644
-
-
-
a
/
test
/
pc
/
e2e
/
peer_connection_e2e_smoke_test
.
cc
+
+
+
b
/
test
/
pc
/
e2e
/
peer_connection_e2e_smoke_test
.
cc
-
9
31
+
9
25
*
/
#
include
<
cstdint
>
-
#
include
<
map
>
#
include
<
memory
>
#
include
<
string
>
-
#
include
<
utility
>
-
#
include
<
vector
>
-
#
include
"
api
/
function_view
.
h
"
#
include
"
api
/
media_stream_interface
.
h
"
-
#
include
"
api
/
rtp_parameters
.
h
"
#
include
"
api
/
test
/
create_network_emulation_manager
.
h
"
#
include
"
api
/
test
/
create_peer_connection_quality_test_frame_generator
.
h
"
#
include
"
api
/
test
/
create_peerconnection_quality_test_fixture
.
h
"
#
include
"
api
/
test
/
metrics
/
global_metrics_logger_and_exporter
.
h
"
-
#
include
"
api
/
test
/
network_emulation
/
network_emulation_interfaces
.
h
"
#
include
"
api
/
test
/
network_emulation_manager
.
h
"
#
include
"
api
/
test
/
pclf
/
media_configuration
.
h
"
#
include
"
api
/
test
/
pclf
/
media_quality_test_params
.
h
"
#
include
"
api
/
test
/
pclf
/
peer_configurer
.
h
"
#
include
"
api
/
test
/
peerconnection_quality_test_fixture
.
h
"
-
#
include
"
api
/
test
/
simulated_network
.
h
"
-
#
include
"
api
/
transport
/
bitrate_settings
.
h
"
-
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
media
/
base
/
media_constants
.
h
"
+
#
include
"
system_wrappers
/
include
/
field_trial
.
h
"
+
#
include
"
test
/
field_trial
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
network
/
simulated_network
.
h
"
+
#
include
"
test
/
pc
/
e2e
/
analyzer
/
audio
/
default_audio_quality_analyzer
.
h
"
#
include
"
test
/
pc
/
e2e
/
analyzer
/
video
/
default_video_quality_analyzer
.
h
"
#
include
"
test
/
pc
/
e2e
/
analyzer
/
video
/
default_video_quality_analyzer_shared_objects
.
h
"
#
include
"
test
/
pc
/
e2e
/
stats_based_network_quality_metrics_reporter
.
h
"
-
149
12
+
143
9
TEST_F
(
PeerConnectionE2EQualityTestSmokeTest
MAYBE_Smoke
)
{
audio
.
sampling_frequency_in_hz
=
48000
;
audio
.
sync_group
=
"
alice
-
media
"
;
alice
-
>
SetAudioConfig
(
std
:
:
move
(
audio
)
)
;
-
#
if
defined
(
RTC_ENABLE_VP9
)
alice
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp9CodecName
{
{
"
profile
-
id
"
"
0
"
}
}
)
}
)
;
-
#
else
-
alice
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp8CodecName
{
}
)
}
)
;
-
#
endif
+
alice
-
>
SetUseFlexFEC
(
true
)
;
alice
-
>
SetUseUlpFEC
(
true
)
;
alice
-
>
SetVideoEncoderBitrateMultiplier
(
1
.
1
)
;
-
171
12
+
162
9
TEST_F
(
PeerConnectionE2EQualityTestSmokeTest
MAYBE_Smoke
)
{
audio
.
input_file_name
=
test
:
:
ResourcePath
(
"
pc_quality_smoke_test_bob_source
"
"
wav
"
)
;
charlie
-
>
SetAudioConfig
(
std
:
:
move
(
audio
)
)
;
-
#
if
defined
(
RTC_ENABLE_VP9
)
charlie
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp9CodecName
{
{
"
profile
-
id
"
"
0
"
}
}
)
}
)
;
-
#
else
-
charlie
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp8CodecName
{
}
)
}
)
;
-
#
endif
+
charlie
-
>
SetUseFlexFEC
(
true
)
;
charlie
-
>
SetUseUlpFEC
(
true
)
;
charlie
-
>
SetVideoEncoderBitrateMultiplier
(
1
.
1
)
;
-
283
26
+
271
16
TEST_F
(
PeerConnectionE2EQualityTestSmokeTest
MAYBE_ChangeNetworkConditions
)
{
video
.
stream_label
=
"
alice
-
video
"
;
video
.
sync_group
=
"
alice
-
media
"
;
alice
-
>
AddVideoConfig
(
std
:
:
move
(
video
)
)
;
-
#
if
defined
(
RTC_ENABLE_VP9
)
alice
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp9CodecName
{
{
"
profile
-
id
"
"
0
"
}
}
)
}
)
;
-
#
else
-
alice
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp8CodecName
{
}
)
}
)
;
-
#
endif
alice
-
>
SetUseFlexFEC
(
true
)
;
alice
-
>
SetUseUlpFEC
(
true
)
;
alice
-
>
SetVideoEncoderBitrateMultiplier
(
1
.
1
)
;
}
)
;
AddPeer
(
bob_network
[
]
(
PeerConfigurer
*
bob
)
{
-
/
/
clang
-
format
off
-
#
if
defined
(
RTC_ENABLE_VP9
)
bob
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp9CodecName
{
{
"
profile
-
id
"
"
0
"
}
}
)
}
)
;
-
#
else
-
bob
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp8CodecName
{
}
)
}
)
;
-
#
endif
-
/
/
clang
-
format
on
bob
-
>
SetUseFlexFEC
(
true
)
;
bob
-
>
SetUseUlpFEC
(
true
)
;
-
430
20
+
408
10
TEST_F
(
PeerConnectionE2EQualityTestSmokeTest
MAYBE_Svc
)
{
.
input_file_name
=
test
:
:
ResourcePath
(
"
pc_quality_smoke_test_alice_source
"
"
wav
"
)
}
)
;
-
#
if
defined
(
RTC_ENABLE_VP9
)
alice
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp9CodecName
)
}
)
;
-
#
else
-
alice
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp8CodecName
)
}
)
;
-
#
endif
}
)
;
AddPeer
(
network_links
.
second
[
]
(
PeerConfigurer
*
bob
)
{
-
/
/
clang
-
format
off
-
#
if
defined
(
RTC_ENABLE_VP9
)
bob
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp9CodecName
)
}
)
;
-
#
else
-
bob
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp8CodecName
)
}
)
;
-
#
endif
-
/
/
clang
-
format
on
}
)
;
RunParams
run_params
(
TimeDelta
:
:
Seconds
(
2
)
)
;
RunAndCheckEachVideoStreamReceivedFrames
(
run_params
)
;
-
477
22
+
445
12
TEST_F
(
PeerConnectionE2EQualityTestSmokeTest
MAYBE_HighBitrate
)
{
test
:
:
ResourcePath
(
"
pc_quality_smoke_test_alice_source
"
"
wav
"
)
;
audio
.
sampling_frequency_in_hz
=
48000
;
alice
-
>
SetAudioConfig
(
std
:
:
move
(
audio
)
)
;
-
#
if
defined
(
RTC_ENABLE_VP9
)
alice
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp9CodecName
{
{
"
profile
-
id
"
"
0
"
}
}
)
}
)
;
-
#
else
-
alice
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp8CodecName
{
}
)
}
)
;
-
#
endif
}
)
;
AddPeer
(
network_links
.
second
[
]
(
PeerConfigurer
*
bob
)
{
-
/
/
clang
-
format
off
-
#
if
defined
(
RTC_ENABLE_VP9
)
bob
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp9CodecName
{
{
"
profile
-
id
"
"
0
"
}
}
)
}
)
;
-
#
else
-
bob
-
>
SetVideoCodecs
(
{
VideoCodecConfig
(
cricket
:
:
kVp8CodecName
{
}
)
}
)
;
-
#
endif
-
/
/
clang
-
format
on
}
)
;
RunParams
run_params
(
TimeDelta
:
:
Seconds
(
2
)
)
;
RunAndCheckEachVideoStreamReceivedFrames
(
run_params
)
;
diff
-
-
git
a
/
test
/
scenario
/
BUILD
.
gn
b
/
test
/
scenario
/
BUILD
.
gn
index
3690b95a3d
.
.
f5c5cd5d9b
100644
-
-
-
a
/
test
/
scenario
/
BUILD
.
gn
+
+
+
b
/
test
/
scenario
/
BUILD
.
gn
-
191
11
+
191
6
if
(
rtc_include_tests
&
&
!
build_with_chromium
)
{
"
:
scenario
"
"
.
.
/
.
.
/
api
/
test
/
network_emulation
"
"
.
.
/
.
.
/
api
/
test
/
network_emulation
:
create_cross_traffic
"
-
"
.
.
/
.
.
/
api
/
units
:
data_rate
"
-
"
.
.
/
.
.
/
api
/
units
:
time_delta
"
-
"
.
.
/
.
.
/
api
/
units
:
timestamp
"
-
"
.
.
/
.
.
/
api
/
video_codecs
:
scalability_mode
"
-
"
.
.
/
.
.
/
call
:
video_send_stream_api
"
"
.
.
/
.
.
/
logging
:
mocks
"
"
.
.
/
.
.
/
rtc_base
:
checks
"
"
.
.
/
.
.
/
system_wrappers
"
diff
-
-
git
a
/
test
/
scenario
/
video_stream_unittest
.
cc
b
/
test
/
scenario
/
video_stream_unittest
.
cc
index
946231d7f6
.
.
c55dbf2d47
100644
-
-
-
a
/
test
/
scenario
/
video_stream_unittest
.
cc
+
+
+
b
/
test
/
scenario
/
video_stream_unittest
.
cc
-
8
24
+
8
12
*
be
found
in
the
AUTHORS
file
in
the
root
of
the
source
tree
.
*
/
#
include
<
atomic
>
-
#
include
<
cstdio
>
-
#
include
<
deque
>
-
#
include
<
vector
>
-
#
if
defined
(
RTC_ENABLE_VP9
)
#
include
"
api
/
test
/
network_emulation
/
create_cross_traffic
.
h
"
#
include
"
api
/
test
/
network_emulation
/
cross_traffic
.
h
"
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
-
#
include
"
api
/
units
/
data_rate
.
h
"
-
#
include
"
api
/
units
/
time_delta
.
h
"
-
#
include
"
api
/
units
/
timestamp
.
h
"
-
#
include
"
api
/
video_codecs
/
scalability_mode
.
h
"
-
#
include
"
call
/
video_send_stream
.
h
"
-
#
include
"
rtc_base
/
checks
.
h
"
+
#
include
"
test
/
field_trial
.
h
"
#
include
"
test
/
gtest
.
h
"
-
#
include
"
test
/
scenario
/
performance_stats
.
h
"
#
include
"
test
/
scenario
/
scenario
.
h
"
-
#
include
"
test
/
scenario
/
scenario_config
.
h
"
namespace
webrtc
{
namespace
test
{
-
191
7
+
179
6
TEST
(
VideoStreamTest
SendsFecWithFlexFec
)
{
EXPECT_GT
(
video_stats
.
substreams
.
begin
(
)
-
>
second
.
rtp_stats
.
fec
.
packets
0u
)
;
}
-
#
if
defined
(
RTC_ENABLE_VP9
)
TEST
(
VideoStreamTest
ResolutionAdaptsToAvailableBandwidth
)
{
/
/
Declared
before
scenario
to
avoid
use
after
free
.
std
:
:
atomic
<
size_t
>
num_qvga_frames_
(
0
)
;
-
265
7
+
252
6
TEST
(
VideoStreamTest
ResolutionAdaptsToAvailableBandwidth
)
{
EXPECT_GT
(
num_qvga_frames_
0u
)
;
EXPECT_GT
(
num_vga_frames_
0u
)
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
TEST
(
VideoStreamTest
SuspendsBelowMinBitrate
)
{
const
DataRate
kMinVideoBitrate
=
DataRate
:
:
KilobitsPerSec
(
30
)
;
diff
-
-
git
a
/
test
/
testsupport
/
ivf_video_frame_generator_unittest
.
cc
b
/
test
/
testsupport
/
ivf_video_frame_generator_unittest
.
cc
index
a86c6679c7
.
.
100b47e765
100644
-
-
-
a
/
test
/
testsupport
/
ivf_video_frame_generator_unittest
.
cc
+
+
+
b
/
test
/
testsupport
/
ivf_video_frame_generator_unittest
.
cc
-
10
38
+
10
27
#
include
"
test
/
testsupport
/
ivf_video_frame_generator
.
h
"
-
#
include
<
cstddef
>
-
#
include
<
cstdint
>
#
include
<
memory
>
#
include
<
optional
>
-
#
include
<
string
>
#
include
<
vector
>
#
include
"
api
/
environment
/
environment
.
h
"
#
include
"
api
/
environment
/
environment_factory
.
h
"
-
#
include
"
api
/
scoped_refptr
.
h
"
#
include
"
api
/
test
/
create_frame_generator
.
h
"
-
#
include
"
api
/
test
/
frame_generator_interface
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
video
/
encoded_image
.
h
"
-
#
include
"
api
/
video
/
video_bitrate_allocation
.
h
"
#
include
"
api
/
video
/
video_codec_type
.
h
"
-
#
include
"
api
/
video
/
video_frame
.
h
"
-
#
include
"
api
/
video
/
video_frame_buffer
.
h
"
#
include
"
api
/
video_codecs
/
video_codec
.
h
"
#
include
"
api
/
video_codecs
/
video_encoder
.
h
"
#
include
"
common_video
/
libyuv
/
include
/
webrtc_libyuv
.
h
"
+
#
include
"
media
/
base
/
codec
.
h
"
+
#
include
"
media
/
base
/
media_constants
.
h
"
#
include
"
modules
/
rtp_rtcp
/
include
/
rtp_rtcp_defines
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
vp8
/
include
/
vp8
.
h
"
-
#
ifdef
RTC_ENABLE_VP9
#
include
"
modules
/
video_coding
/
codecs
/
vp9
/
include
/
vp9
.
h
"
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
#
include
"
modules
/
video_coding
/
include
/
video_error_codes
.
h
"
#
include
"
modules
/
video_coding
/
utility
/
ivf_file_writer
.
h
"
-
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
event
.
h
"
-
#
include
"
rtc_base
/
system
/
file_wrapper
.
h
"
-
#
include
"
rtc_base
/
thread_annotations
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
testsupport
/
file_utils
.
h
"
#
include
"
test
/
video_codec_settings
.
h
"
-
210
7
+
199
6
TEST_F
(
IvfVideoFrameGeneratorTest
Vp8DoubleRead
)
{
}
}
-
#
ifdef
RTC_ENABLE_VP9
TEST_F
(
IvfVideoFrameGeneratorTest
Vp9
)
{
CreateTestVideoFile
(
VideoCodecType
:
:
kVideoCodecVP9
CreateVp9Encoder
(
env_
)
)
;
IvfVideoFrameGenerator
generator
(
env_
file_name_
/
*
fps_hint
=
*
/
std
:
:
nullopt
)
;
-
220
7
+
208
6
TEST_F
(
IvfVideoFrameGeneratorTest
Vp9
)
{
EXPECT_GT
(
I420PSNR
(
&
expected_frame
&
actual_frame
)
kExpectedMinPsnr
)
;
}
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
#
if
defined
(
WEBRTC_USE_H264
)
TEST_F
(
IvfVideoFrameGeneratorTest
H264
)
{
diff
-
-
git
a
/
video
/
end_to_end_tests
/
multi_codec_receive_tests
.
cc
b
/
video
/
end_to_end_tests
/
multi_codec_receive_tests
.
cc
index
01c2bec381
.
.
e9c8bc4637
100644
-
-
-
a
/
video
/
end_to_end_tests
/
multi_codec_receive_tests
.
cc
+
+
+
b
/
video
/
end_to_end_tests
/
multi_codec_receive_tests
.
cc
-
8
42
+
8
22
*
be
found
in
the
AUTHORS
file
in
the
root
of
the
source
tree
.
*
/
-
#
include
<
cstddef
>
-
#
include
<
cstdint
>
#
include
<
memory
>
-
#
include
<
optional
>
-
#
include
<
set
>
-
#
include
<
string
>
-
#
include
<
vector
>
-
#
include
"
api
/
array_view
.
h
"
-
#
include
"
api
/
environment
/
environment
.
h
"
#
include
"
api
/
test
/
simulated_network
.
h
"
-
#
include
"
api
/
test
/
video
/
function_video_decoder_factory
.
h
"
#
include
"
api
/
test
/
video
/
function_video_encoder_factory
.
h
"
-
#
include
"
api
/
video
/
video_frame
.
h
"
-
#
include
"
api
/
video
/
video_sink_interface
.
h
"
-
#
include
"
api
/
video_codecs
/
sdp_video_format
.
h
"
-
#
include
"
api
/
video_codecs
/
video_codec
.
h
"
-
#
include
"
api
/
video_codecs
/
video_decoder
.
h
"
-
#
include
"
api
/
video_codecs
/
video_decoder_factory
.
h
"
-
#
include
"
api
/
video_codecs
/
video_encoder
.
h
"
-
#
include
"
api
/
video_codecs
/
video_encoder_factory
.
h
"
-
#
include
"
call
/
video_receive_stream
.
h
"
+
#
include
"
call
/
fake_network_pipe
.
h
"
#
include
"
modules
/
include
/
module_common_types_public
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_packet
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
h264
/
include
/
h264
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
vp8
/
include
/
vp8
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
vp9
/
include
/
vp9
.
h
"
-
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
synchronization
/
mutex
.
h
"
#
include
"
rtc_base
/
task_queue_for_test
.
h
"
-
#
include
"
rtc_base
/
thread_annotations
.
h
"
#
include
"
test
/
call_test
.
h
"
-
#
include
"
test
/
encoder_settings
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
-
#
include
"
test
/
rtp_rtcp_observer
.
h
"
+
#
include
"
test
/
network
/
simulated_network
.
h
"
#
include
"
test
/
video_test_constants
.
h
"
using
:
:
testing
:
:
Contains
;
-
287
7
+
267
6
void
MultiCodecReceiveTest
:
:
RunTestWithCodecs
(
}
)
;
}
-
#
if
defined
(
RTC_ENABLE_VP9
)
TEST_F
(
MultiCodecReceiveTest
SingleStreamReceivesVp8Vp9
)
{
RunTestWithCodecs
(
{
{
"
VP8
"
1
}
{
"
VP9
"
1
}
{
"
VP8
"
1
}
}
)
;
}
-
295
7
+
274
6
TEST_F
(
MultiCodecReceiveTest
SingleStreamReceivesVp8Vp9
)
{
TEST_F
(
MultiCodecReceiveTest
SingleStreamReceivesVp8Vp9WithTl
)
{
RunTestWithCodecs
(
{
{
"
VP8
"
2
}
{
"
VP9
"
2
}
{
"
VP8
"
2
}
}
)
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
#
if
defined
(
WEBRTC_USE_H264
)
TEST_F
(
MultiCodecReceiveTest
SingleStreamReceivesVp8H264
)
{
diff
-
-
git
a
/
video
/
quality_scaling_tests
.
cc
b
/
video
/
quality_scaling_tests
.
cc
index
a09669fb81
.
.
12b5650463
100644
-
-
-
a
/
video
/
quality_scaling_tests
.
cc
+
+
+
b
/
video
/
quality_scaling_tests
.
cc
-
8
44
+
8
19
*
be
found
in
the
AUTHORS
file
in
the
root
of
the
source
tree
.
*
/
-
#
include
<
algorithm
>
-
#
include
<
cstddef
>
-
#
include
<
cstdint
>
-
#
include
<
limits
>
-
#
include
<
memory
>
-
#
include
<
optional
>
#
include
<
string
>
-
#
include
<
vector
>
-
#
include
"
api
/
array_view
.
h
"
-
#
include
"
api
/
environment
/
environment
.
h
"
-
#
include
"
api
/
make_ref_counted
.
h
"
-
#
include
"
api
/
rtp_parameters
.
h
"
#
include
"
api
/
test
/
video
/
function_video_encoder_factory
.
h
"
-
#
include
"
api
/
transport
/
bitrate_settings
.
h
"
-
#
include
"
api
/
units
/
time_delta
.
h
"
-
#
include
"
api
/
video
/
video_codec_type
.
h
"
-
#
include
"
api
/
video
/
video_frame
.
h
"
-
#
include
"
api
/
video
/
video_sink_interface
.
h
"
-
#
include
"
api
/
video
/
video_source_interface
.
h
"
-
#
include
"
api
/
video_codecs
/
scalability_mode
.
h
"
-
#
include
"
api
/
video_codecs
/
sdp_video_format
.
h
"
-
#
include
"
api
/
video_codecs
/
video_codec
.
h
"
-
#
include
"
api
/
video_codecs
/
video_encoder
.
h
"
-
#
include
"
call
/
video_receive_stream
.
h
"
-
#
include
"
call
/
video_send_stream
.
h
"
+
#
include
"
media
/
engine
/
internal_encoder_factory
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
h264
/
include
/
h264
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
vp8
/
include
/
vp8
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
vp9
/
include
/
vp9
.
h
"
-
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
experiments
/
encoder_info_settings
.
h
"
#
include
"
test
/
call_test
.
h
"
+
#
include
"
test
/
field_trial
.
h
"
#
include
"
test
/
frame_generator_capturer
.
h
"
-
#
include
"
test
/
gtest
.
h
"
-
#
include
"
test
/
rtp_rtcp_observer
.
h
"
-
#
include
"
test
/
scoped_key_value_config
.
h
"
#
include
"
test
/
video_test_constants
.
h
"
-
#
include
"
video
/
config
/
video_encoder_config
.
h
"
+
#
include
"
video
/
config
/
encoder_stream_factory
.
h
"
namespace
webrtc
{
namespace
{
-
476
7
+
451
6
TEST_F
(
QualityScalingTest
NoAdaptDownForLowStartBitrateIfScalingOff_Vp8
)
{
RunBaseTest
(
&
test
)
;
}
-
#
if
defined
(
RTC_ENABLE_VP9
)
TEST_F
(
QualityScalingTest
AdaptsDownForHighQp_Vp9
)
{
/
/
qp_low
:
1
qp_high
:
1
-
>
kHighQp
test
:
:
ScopedKeyValueConfig
field_trials
(
field_trials_
-
618
7
+
592
6
TEST_F
(
QualityScalingTest
/
*
expect_downscale
=
*
/
false
)
;
RunBaseTest
(
&
test
)
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
#
if
defined
(
WEBRTC_USE_H264
)
TEST_F
(
QualityScalingTest
AdaptsDownForHighQp_H264
)
{
diff
-
-
git
a
/
video
/
video_send_stream_tests
.
cc
b
/
video
/
video_send_stream_tests
.
cc
index
90eaf98bec
.
.
add6480211
100644
-
-
-
a
/
video
/
video_send_stream_tests
.
cc
+
+
+
b
/
video
/
video_send_stream_tests
.
cc
-
15
6
+
15
7
#
include
<
memory
>
#
include
<
numeric
>
#
include
<
optional
>
+
#
include
<
set
>
#
include
<
string
>
#
include
<
tuple
>
#
include
<
utility
>
-
40
7
+
41
6
#
include
"
api
/
transport
/
bitrate_settings
.
h
"
#
include
"
api
/
units
/
data_rate
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
-
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
api
/
video
/
builtin_video_bitrate_allocator_factory
.
h
"
#
include
"
api
/
video
/
encoded_image
.
h
"
#
include
"
api
/
video
/
video_bitrate_allocation
.
h
"
-
78
26
+
78
22
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_rtcp_interface
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_util
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
video_rtp_depacketizer
.
h
"
-
#
include
"
modules
/
video_coding
/
svc
/
scalable_video_controller
.
h
"
-
#
include
"
rtc_base
/
strings
/
string_builder
.
h
"
-
#
if
defined
(
RTC_ENABLE_VP9
)
#
include
"
modules
/
rtp_rtcp
/
source
/
video_rtp_depacketizer_vp9
.
h
"
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
#
include
"
modules
/
video_coding
/
codecs
/
interface
/
common_constants
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
vp8
/
include
/
vp8
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
vp8
/
include
/
vp8_globals
.
h
"
-
#
if
defined
(
RTC_ENABLE_VP9
)
#
include
"
modules
/
video_coding
/
codecs
/
vp9
/
include
/
vp9
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
vp9
/
include
/
vp9_globals
.
h
"
#
include
"
modules
/
video_coding
/
svc
/
create_scalability_structure
.
h
"
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
#
include
"
modules
/
video_coding
/
svc
/
scalability_mode_util
.
h
"
+
#
include
"
modules
/
video_coding
/
svc
/
scalable_video_controller
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
event
.
h
"
#
include
"
rtc_base
/
experiments
/
alr_experiment
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
#
include
"
rtc_base
/
network_route
.
h
"
#
include
"
rtc_base
/
rate_limiter
.
h
"
+
#
include
"
rtc_base
/
strings
/
string_builder
.
h
"
#
include
"
rtc_base
/
synchronization
/
mutex
.
h
"
#
include
"
rtc_base
/
task_queue_for_test
.
h
"
#
include
"
rtc_base
/
thread
.
h
"
-
174
7
+
170
6
struct
Vp9TestParams
{
using
ParameterizationType
=
std
:
:
tuple
<
Vp9TestParams
bool
>
;
-
#
if
defined
(
RTC_ENABLE_VP9
)
std
:
:
string
ParamInfoToStr
(
const
testing
:
:
TestParamInfo
<
ParameterizationType
>
&
info
)
{
StringBuilder
sb
;
-
182
7
+
177
6
std
:
:
string
ParamInfoToStr
(
<
<
(
std
:
:
get
<
1
>
(
info
.
param
)
?
"
WithIdentifier
"
:
"
WithoutIdentifier
"
)
;
return
sb
.
str
(
)
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
}
/
/
namespace
-
4361
7
+
4355
6
TEST_F
(
VideoSendStreamTest
TestScalabilityModeVp8SimulcastWithoutSimAdapter
)
{
{
ScalabilityMode
:
:
kL1T2
ScalabilityMode
:
:
kL1T2
}
)
;
}
-
#
if
defined
(
RTC_ENABLE_VP9
)
TEST_F
(
VideoSendStreamTest
TestTemporalLayersVp9
)
{
test
:
:
FunctionVideoEncoderFactory
encoder_factory
(
[
]
(
const
Environment
&
env
const
SdpVideoFormat
&
format
)
{
-
4372
6
+
4365
5
TEST_F
(
VideoSendStreamTest
TestTemporalLayersVp9
)
{
/
*
num_temporal_layers
=
*
/
{
2
}
/
*
scalability_mode
=
*
/
{
}
)
;
}
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
}
/
/
namespace
webrtc
diff
-
-
git
a
/
video
/
video_stream_encoder_unittest
.
cc
b
/
video
/
video_stream_encoder_unittest
.
cc
index
e7bbe57a3c
.
.
721d309339
100644
-
-
-
a
/
video
/
video_stream_encoder_unittest
.
cc
+
+
+
b
/
video
/
video_stream_encoder_unittest
.
cc
-
94
6
+
94
7
#
include
"
rtc_base
/
event
.
h
"
#
include
"
rtc_base
/
experiments
/
encoder_info_settings
.
h
"
#
include
"
rtc_base
/
experiments
/
rate_control_settings
.
h
"
+
#
include
"
rtc_base
/
gunit
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
#
include
"
rtc_base
/
ref_counted_object
.
h
"
#
include
"
rtc_base
/
strings
/
string_builder
.
h
"
-
9592
10
+
9593
8
std
:
:
string
TestParametersVideoCodecAndAllowI420ConversionToString
(
constexpr
std
:
:
pair
<
VideoCodecType
bool
>
kVP8DisallowConversion
=
std
:
:
make_pair
(
kVideoCodecVP8
/
*
allow_i420_conversion
=
*
/
false
)
;
-
#
if
defined
(
RTC_ENABLE_VP9
)
constexpr
std
:
:
pair
<
VideoCodecType
bool
>
kVP9DisallowConversion
=
std
:
:
make_pair
(
kVideoCodecVP9
/
*
allow_i420_conversion
=
*
/
false
)
;
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
constexpr
std
:
:
pair
<
VideoCodecType
bool
>
kAV1AllowConversion
=
std
:
:
make_pair
(
kVideoCodecAV1
/
*
allow_i420_conversion
=
*
/
false
)
;
#
if
defined
(
WEBRTC_USE_H264
)
-
9609
9
+
9608
7
INSTANTIATE_TEST_SUITE_P
(
All
VideoStreamEncoderWithRealEncoderTest
:
:
testing
:
:
Values
(
kVP8DisallowConversion
-
#
if
defined
(
RTC_ENABLE_VP9
)
kVP9DisallowConversion
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
kAV1AllowConversion
kH264AllowConversion
)
TestParametersVideoCodecAndAllowI420ConversionToString
)
;
-
9620
9
+
9617
7
INSTANTIATE_TEST_SUITE_P
(
All
VideoStreamEncoderWithRealEncoderTest
:
:
testing
:
:
Values
(
kVP8DisallowConversion
-
#
if
defined
(
RTC_ENABLE_VP9
)
kVP9DisallowConversion
-
#
endif
/
/
defined
(
RTC_ENABLE_VP9
)
kAV1AllowConversion
)
TestParametersVideoCodecAndAllowI420ConversionToString
)
;
#
endif
