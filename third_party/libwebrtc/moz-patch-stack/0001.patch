From
:
Michael
Froman
<
mjfroman
mac
.
com
>
Date
:
Thu
17
Jul
2025
14
:
27
:
29
-
0500
Subject
:
(
tmp
-
cherry
-
pick
)
Revert
"
Stop
using
the
UsedPayloadTypes
class
"
(
ebb67395c1
)
This
reverts
commit
adb68d04d78f63d61f4544b087b931391af0d9f8
.
Reason
for
revert
:
Breaks
downstream
project
.
Original
change
'
s
description
:
>
Stop
using
the
UsedPayloadTypes
class
>
>
This
means
that
all
assignment
of
payload
types
is
now
used
>
using
the
PayloadTypeSuggester
.
>
>
Bug
:
webrtc
:
360058654
>
Change
-
Id
:
Ib668f637fb79aacf6327b7c71008ae3fb9df630d
>
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
385340
>
Reviewed
-
by
:
Evan
Shrubsole
<
eshr
webrtc
.
org
>
>
Commit
-
Queue
:
Harald
Alvestrand
<
hta
webrtc
.
org
>
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
44329
}
Bug
:
webrtc
:
360058654
No
-
Presubmit
:
true
No
-
Tree
-
Checks
:
true
No
-
Try
:
true
Change
-
Id
:
Ib3f5bc2abc49845cda4debb2cabc9664cdb2baed
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
385580
Owners
-
Override
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
Commit
-
Queue
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
Bot
-
Commit
:
rubber
-
stamper
appspot
.
gserviceaccount
.
com
<
rubber
-
stamper
appspot
.
gserviceaccount
.
com
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
44334
}
-
-
-
pc
/
codec_vendor
.
cc
|
16
+
+
+
+
+
+
+
+
+
+
+
-
-
-
-
-
pc
/
used_ids
.
h
|
38
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
2
files
changed
49
insertions
(
+
)
5
deletions
(
-
)
diff
-
-
git
a
/
pc
/
codec_vendor
.
cc
b
/
pc
/
codec_vendor
.
cc
index
f9c9125562
.
.
75e5ab0973
100644
-
-
-
a
/
pc
/
codec_vendor
.
cc
+
+
+
b
/
pc
/
codec_vendor
.
cc
-
39
6
+
39
7
#
include
"
pc
/
rtp_media_utils
.
h
"
#
include
"
pc
/
session_description
.
h
"
#
include
"
pc
/
typed_codec_vendor
.
h
"
+
#
include
"
pc
/
used_ids
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
#
include
"
rtc_base
/
string_encode
.
h
"
-
632
6
+
633
14
RTCErrorOr
<
std
:
:
vector
<
Codec
>
>
CodecVendor
:
:
GetNegotiatedCodecsForOffer
(
}
}
}
+
/
/
Note
what
PTs
are
already
in
use
.
+
UsedPayloadTypes
+
used_pltypes
;
/
/
Used
to
avoid
pt
collisions
in
filtered_codecs
+
for
(
auto
&
codec
:
filtered_codecs
)
{
+
/
/
Note
:
This
may
change
PTs
.
Doing
so
woud
indicate
an
error
but
+
/
/
UsedPayloadTypes
doesn
'
t
offer
a
means
to
make
the
distinction
.
+
used_pltypes
.
FindAndSetIdUsed
(
&
codec
)
;
+
}
/
/
Add
other
supported
codecs
.
for
(
const
Codec
&
codec
:
supported_codecs
)
{
std
:
:
optional
<
Codec
>
found_codec
=
-
658
11
+
667
8
RTCErrorOr
<
std
:
:
vector
<
Codec
>
>
CodecVendor
:
:
GetNegotiatedCodecsForOffer
(
changed_referenced_codec
-
>
id
)
;
}
}
-
auto
pt_or_error
=
pt_suggester
.
SuggestPayloadType
(
mid
*
found_codec
)
;
-
if
(
!
pt_or_error
.
ok
(
)
)
{
-
return
pt_or_error
.
MoveError
(
)
;
-
}
-
found_codec
-
>
id
=
pt_or_error
.
value
(
)
;
+
/
/
Quick
fix
for
b
/
395077842
:
Remap
the
codec
if
it
collides
.
+
used_pltypes
.
FindAndSetIdUsed
(
&
(
*
found_codec
)
)
;
filtered_codecs
.
push_back
(
*
found_codec
)
;
}
}
diff
-
-
git
a
/
pc
/
used_ids
.
h
b
/
pc
/
used_ids
.
h
index
ddd88ce4a4
.
.
b719a04a06
100644
-
-
-
a
/
pc
/
used_ids
.
h
+
+
+
b
/
pc
/
used_ids
.
h
-
14
7
+
14
9
#
include
<
vector
>
#
include
"
api
/
rtp_parameters
.
h
"
+
#
include
"
media
/
base
/
codec
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
+
#
include
"
rtc_base
/
logging
.
h
"
namespace
webrtc
{
template
<
typename
IdStruct
>
-
86
6
+
88
41
class
UsedIds
{
std
:
:
set
<
int
>
id_set_
;
}
;
+
/
/
Helper
class
used
for
finding
duplicate
RTP
payload
types
among
audio
video
+
/
/
and
data
codecs
.
When
bundle
is
used
the
payload
types
may
not
collide
.
+
class
UsedPayloadTypes
:
public
UsedIds
<
Codec
>
{
+
public
:
+
UsedPayloadTypes
(
)
+
:
UsedIds
<
Codec
>
(
kFirstDynamicPayloadTypeLowerRange
+
kLastDynamicPayloadTypeUpperRange
)
{
}
+
+
/
/
Check
if
a
payload
type
is
valid
.
The
range
[
64
-
95
]
is
forbidden
+
/
/
when
rtcp
-
mux
is
used
.
+
static
bool
IsIdValid
(
Codec
codec
bool
rtcp_mux
)
{
+
if
(
rtcp_mux
&
&
(
codec
.
id
>
kLastDynamicPayloadTypeLowerRange
&
&
+
codec
.
id
<
kFirstDynamicPayloadTypeUpperRange
)
)
{
+
return
false
;
+
}
+
return
codec
.
id
>
=
0
&
&
codec
.
id
<
=
kLastDynamicPayloadTypeUpperRange
;
+
}
+
+
protected
:
+
bool
IsIdUsed
(
int
new_id
)
override
{
+
/
/
Range
marked
for
RTCP
avoidance
is
"
used
"
.
+
if
(
new_id
>
kLastDynamicPayloadTypeLowerRange
&
&
+
new_id
<
kFirstDynamicPayloadTypeUpperRange
)
+
return
true
;
+
return
UsedIds
<
Codec
>
:
:
IsIdUsed
(
new_id
)
;
+
}
+
+
private
:
+
static
const
int
kFirstDynamicPayloadTypeLowerRange
=
35
;
+
static
const
int
kLastDynamicPayloadTypeLowerRange
=
63
;
+
+
static
const
int
kFirstDynamicPayloadTypeUpperRange
=
96
;
+
static
const
int
kLastDynamicPayloadTypeUpperRange
=
127
;
+
}
;
+
/
/
Helper
class
used
for
finding
duplicate
RTP
Header
extension
ids
among
/
/
audio
and
video
extensions
.
class
UsedRtpHeaderExtensionIds
:
public
UsedIds
<
RtpExtension
>
{
-
152
6
+
189
7
class
UsedRtpHeaderExtensionIds
:
public
UsedIds
<
RtpExtension
>
{
/
/
TODO
(
bugs
.
webrtc
.
org
/
4222596
)
:
Remove
once
all
references
are
updated
.
namespace
cricket
{
using
:
:
webrtc
:
:
UsedIds
;
+
using
:
:
webrtc
:
:
UsedPayloadTypes
;
using
:
:
webrtc
:
:
UsedRtpHeaderExtensionIds
;
}
/
/
namespace
cricket
