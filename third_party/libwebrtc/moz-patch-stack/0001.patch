From
:
Michael
Froman
<
mjfroman
mac
.
com
>
Date
:
Tue
15
Oct
2024
17
:
49
:
17
-
0500
Subject
:
(
tmp
-
cherry
-
pick
)
Revert
"
TaskQueueStdlib
:
Stop
spamming
on
idle
.
"
(
9463095df8
)
MIME
-
Version
:
1
.
0
Content
-
Type
:
text
/
plain
;
charset
=
UTF
-
8
Content
-
Transfer
-
Encoding
:
8bit
This
reverts
commit
2fbaa8e3a3ef7d7f26e82bc3325fdca33f60c1d3
.
Reason
for
revert
:
Breaks
tests
Original
change
'
s
description
:
>
TaskQueueStdlib
:
Stop
spamming
on
idle
.
>
>
When
the
stdlib
task
queue
has
no
work
for
>
=
3s
on
>
Android
it
will
emit
bogus
deadlock
warnings
.
Fix
>
this
by
ensuring
we
'
re
not
triggering
this
behavior
.
>
>
Fixed
:
b
/
364436627
>
Change
-
Id
:
I3fe02e13993cbb4a59d5669df06c4c293d237bc4
>
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
361721
>
Commit
-
Queue
:
Markus
Handell
<
handellm
webrtc
.
org
>
>
Reviewed
-
by
:
Jonas
Oreland
<
jonaso
webrtc
.
org
>
>
Reviewed
-
by
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
42955
}
Change
-
Id
:
Ie80d86f6aa0cdff3bc5ee1d79fa4c8144009e33f
No
-
Presubmit
:
true
No
-
Tree
-
Checks
:
true
No
-
Try
:
true
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
361741
Auto
-
Submit
:
Markus
Handell
<
handellm
webrtc
.
org
>
Reviewed
-
by
:
Bj
rn
Terelius
<
terelius
webrtc
.
org
>
Commit
-
Queue
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
Reviewed
-
by
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
Bot
-
Commit
:
rubber
-
stamper
appspot
.
gserviceaccount
.
com
<
rubber
-
stamper
appspot
.
gserviceaccount
.
com
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
42960
}
-
-
-
rtc_base
/
BUILD
.
gn
|
5
-
-
-
-
-
rtc_base
/
event
.
h
|
4
+
-
-
-
rtc_base
/
task_queue_stdlib
.
cc
|
2
+
-
rtc_base
/
task_queue_stdlib_unittest
.
cc
|
30
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
4
files
changed
2
insertions
(
+
)
39
deletions
(
-
)
diff
-
-
git
a
/
rtc_base
/
BUILD
.
gn
b
/
rtc_base
/
BUILD
.
gn
index
86a0e81f2b
.
.
bbe25fdd14
100644
-
-
-
a
/
rtc_base
/
BUILD
.
gn
+
+
+
b
/
rtc_base
/
BUILD
.
gn
-
739
13
+
739
8
if
(
rtc_include_tests
)
{
sources
=
[
"
task_queue_stdlib_unittest
.
cc
"
]
deps
=
[
"
:
gunit_helpers
"
-
"
:
logging
"
-
"
:
rtc_event
"
"
:
rtc_task_queue_stdlib
"
-
"
.
.
/
api
/
task_queue
"
"
.
.
/
api
/
task_queue
:
task_queue_test
"
-
"
.
.
/
api
/
units
:
time_delta
"
-
"
.
.
/
system_wrappers
"
"
.
.
/
test
:
test_main
"
"
.
.
/
test
:
test_support
"
]
diff
-
-
git
a
/
rtc_base
/
event
.
h
b
/
rtc_base
/
event
.
h
index
78b3c16646
.
.
12f6a7dca2
100644
-
-
-
a
/
rtc_base
/
event
.
h
+
+
+
b
/
rtc_base
/
event
.
h
-
58
8
+
58
6
class
Event
{
/
/
TODO
(
bugs
.
webrtc
.
org
/
14366
)
:
Consider
removing
this
redundant
alias
.
static
constexpr
webrtc
:
:
TimeDelta
kForever
=
webrtc
:
:
TimeDelta
:
:
PlusInfinity
(
)
;
-
static
constexpr
webrtc
:
:
TimeDelta
kDefaultWarnDuration
=
-
webrtc
:
:
TimeDelta
:
:
Seconds
(
3
)
;
Event
(
)
;
Event
(
bool
manual_reset
bool
initially_signaled
)
;
-
85
7
+
83
7
class
Event
{
/
/
Waits
with
the
given
timeout
and
a
reasonable
default
warning
timeout
.
bool
Wait
(
webrtc
:
:
TimeDelta
give_up_after
)
{
return
Wait
(
give_up_after
give_up_after
.
IsPlusInfinity
(
)
-
?
kDefaultWarnDuration
+
?
webrtc
:
:
TimeDelta
:
:
Seconds
(
3
)
:
kForever
)
;
}
diff
-
-
git
a
/
rtc_base
/
task_queue_stdlib
.
cc
b
/
rtc_base
/
task_queue_stdlib
.
cc
index
8b9e554cdb
.
.
1ac01e1830
100644
-
-
-
a
/
rtc_base
/
task_queue_stdlib
.
cc
+
+
+
b
/
rtc_base
/
task_queue_stdlib
.
cc
-
249
7
+
249
7
void
TaskQueueStdlib
:
:
ProcessTasks
(
)
{
continue
;
}
-
flag_notify_
.
Wait
(
task
.
sleep_time
task
.
sleep_time
)
;
+
flag_notify_
.
Wait
(
task
.
sleep_time
)
;
}
/
/
Ensure
remaining
deleted
tasks
are
destroyed
with
Current
(
)
set
up
to
this
diff
-
-
git
a
/
rtc_base
/
task_queue_stdlib_unittest
.
cc
b
/
rtc_base
/
task_queue_stdlib_unittest
.
cc
index
fdfe346c0b
.
.
0654e9719c
100644
-
-
-
a
/
rtc_base
/
task_queue_stdlib_unittest
.
cc
+
+
+
b
/
rtc_base
/
task_queue_stdlib_unittest
.
cc
-
10
12
+
10
7
#
include
"
rtc_base
/
task_queue_stdlib
.
h
"
-
#
include
"
api
/
task_queue
/
task_queue_factory
.
h
"
#
include
"
api
/
task_queue
/
task_queue_test
.
h
"
-
#
include
"
api
/
units
/
time_delta
.
h
"
-
#
include
"
rtc_base
/
event
.
h
"
-
#
include
"
rtc_base
/
logging
.
h
"
-
#
include
"
system_wrappers
/
include
/
sleep
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
-
30
30
+
25
5
INSTANTIATE_TEST_SUITE_P
(
TaskQueueStdlib
TaskQueueTest
:
:
testing
:
:
Values
(
CreateTaskQueueFactory
)
)
;
-
class
StringPtrLogSink
:
public
rtc
:
:
LogSink
{
-
public
:
-
explicit
StringPtrLogSink
(
std
:
:
string
*
log_data
)
:
log_data_
(
log_data
)
{
}
-
-
private
:
-
void
OnLogMessage
(
const
std
:
:
string
&
message
)
override
{
-
OnLogMessage
(
absl
:
:
string_view
(
message
)
)
;
-
}
-
void
OnLogMessage
(
absl
:
:
string_view
message
)
override
{
-
log_data_
-
>
append
(
message
.
begin
(
)
message
.
end
(
)
)
;
-
}
-
std
:
:
string
*
const
log_data_
;
-
}
;
-
-
TEST
(
TaskQueueStdlib
AvoidsSpammingLogOnInactivity
)
{
-
std
:
:
string
log_output
;
-
StringPtrLogSink
stream
(
&
log_output
)
;
-
rtc
:
:
LogMessage
:
:
AddLogToStream
(
&
stream
rtc
:
:
LS_VERBOSE
)
;
-
auto
task_queue
=
CreateTaskQueueStdlibFactory
(
)
-
>
CreateTaskQueue
(
-
"
test
"
TaskQueueFactory
:
:
Priority
:
:
NORMAL
)
;
-
auto
wait_duration
=
rtc
:
:
Event
:
:
kDefaultWarnDuration
+
TimeDelta
:
:
Seconds
(
1
)
;
-
SleepMs
(
wait_duration
.
ms
(
)
)
;
-
EXPECT_EQ
(
log_output
.
length
(
)
0u
)
;
-
}
-
}
/
/
namespace
}
/
/
namespace
webrtc
