From
:
Michael
Froman
<
mjfroman
mac
.
com
>
Date
:
Fri
8
Aug
2025
12
:
49
:
40
-
0500
Subject
:
(
tmp
-
cherry
-
pick
)
Revert
"
[
iOS
]
Update
RTCCameraPreviewView
to
conform
to
iOS
17
"
(
3f48fd6070
)
MIME
-
Version
:
1
.
0
Content
-
Type
:
text
/
plain
;
charset
=
UTF
-
8
Content
-
Transfer
-
Encoding
:
8bit
This
reverts
commit
887a6b9f7fb88291413ccc454651cb5e571740b2
.
Reason
for
revert
:
The
build
guard
is
incorrect
.
Bug
:
chromium
:
348649285
Original
change
'
s
description
:
>
[
iOS
]
Update
RTCCameraPreviewView
to
conform
to
iOS
17
>
>
In
iOS
17
the
video
orientation
API
is
deprecated
.
This
CL
updates
the
>
RTCCameraPreviewView
file
to
use
the
video
rotation
angle
API
instead
.
>
>
This
file
is
being
updated
now
to
support
Chrome
for
iOS
effort
to
raise
>
its
minimum
deployment
target
to
iOS
17
.
>
>
Bug
:
chromium
:
348649285
>
Change
-
Id
:
Icf72911e9a3431a9a91fefc3d85f9ea02597c5f4
>
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
390080
>
Reviewed
-
by
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
>
Commit
-
Queue
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
>
Reviewed
-
by
:
K
ri
Helgason
<
kthelgason
webrtc
.
org
>
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
44603
}
Bug
:
chromium
:
348649285
No
-
Presubmit
:
true
No
-
Tree
-
Checks
:
true
No
-
Try
:
true
Change
-
Id
:
I69482894536b6d8b67e733e2745f73ed34236662
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
391220
Bot
-
Commit
:
rubber
-
stamper
appspot
.
gserviceaccount
.
com
<
rubber
-
stamper
appspot
.
gserviceaccount
.
com
>
Reviewed
-
by
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
Commit
-
Queue
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
Owners
-
Override
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
44607
}
-
-
-
sdk
/
objc
/
helpers
/
RTCCameraPreviewView
.
m
|
70
+
+
+
+
+
+
+
+
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
1
file
changed
21
insertions
(
+
)
49
deletions
(
-
)
diff
-
-
git
a
/
sdk
/
objc
/
helpers
/
RTCCameraPreviewView
.
m
b
/
sdk
/
objc
/
helpers
/
RTCCameraPreviewView
.
m
index
77d5e8823d
.
.
92c3cd2635
100644
-
-
-
a
/
sdk
/
objc
/
helpers
/
RTCCameraPreviewView
.
m
+
+
+
b
/
sdk
/
objc
/
helpers
/
RTCCameraPreviewView
.
m
-
80
54
+
80
6
}
-
(
void
)
setCorrectVideoOrientation
{
-
if
(
available
(
iOS
17
*
)
)
{
-
[
self
modifyVideoAngle
]
;
-
return
;
-
}
-
-
[
self
modifyVideoOrientation
]
;
-
}
-
-
#
pragma
mark
-
Private
-
-
-
(
void
)
addOrientationObserver
{
-
[
[
NSNotificationCenter
defaultCenter
]
-
addObserver
:
self
-
selector
:
selector
(
orientationChanged
:
)
-
name
:
UIDeviceOrientationDidChangeNotification
-
object
:
nil
]
;
-
}
-
-
-
(
void
)
removeOrientationObserver
{
-
[
[
NSNotificationCenter
defaultCenter
]
-
removeObserver
:
self
-
name
:
UIDeviceOrientationDidChangeNotification
-
object
:
nil
]
;
-
}
-
-
-
(
AVCaptureVideoPreviewLayer
*
)
previewLayer
{
-
return
(
AVCaptureVideoPreviewLayer
*
)
self
.
layer
;
-
}
-
-
-
(
void
)
modifyVideoAngle
API_AVAILABLE
(
ios
(
17
.
0
)
)
{
-
AVCaptureDeviceInput
*
captureSessionInput
=
-
_captureSession
.
inputs
.
firstObject
;
-
AVCaptureDevice
*
camera
=
captureSessionInput
.
device
;
-
AVCaptureVideoPreviewLayer
*
previewLayer
=
[
self
previewLayer
]
;
-
AVCaptureConnection
*
videoConnection
=
previewLayer
.
connection
;
-
AVCaptureDeviceRotationCoordinator
*
rotationCoordiantor
=
-
[
[
AVCaptureDeviceRotationCoordinator
alloc
]
-
initWithDevice
:
camera
-
previewLayer
:
previewLayer
]
;
-
CGFloat
angle
=
-
rotationCoordiantor
.
videoRotationAngleForHorizonLevelCapture
;
-
if
(
[
videoConnection
isVideoRotationAngleSupported
:
angle
]
)
{
-
[
videoConnection
setVideoRotationAngle
:
angle
]
;
-
}
-
}
-
-
#
if
defined
(
__IPHONE_17_0
)
&
&
__IPHONE_OS_VERSION_MAX_ALLOWED
>
=
__IPHONE_17_0
-
-
(
void
)
modifyVideoOrientation
{
/
/
Get
current
device
orientation
.
UIDeviceOrientation
deviceOrientation
=
[
UIDevice
currentDevice
]
.
orientation
;
AVCaptureVideoPreviewLayer
*
previewLayer
=
[
self
previewLayer
]
;
-
152
6
+
104
26
/
/
orientation
.
}
}
-
#
endif
+
+
#
pragma
mark
-
Private
+
+
-
(
void
)
addOrientationObserver
{
+
[
[
NSNotificationCenter
defaultCenter
]
+
addObserver
:
self
+
selector
:
selector
(
orientationChanged
:
)
+
name
:
UIDeviceOrientationDidChangeNotification
+
object
:
nil
]
;
+
}
+
+
-
(
void
)
removeOrientationObserver
{
+
[
[
NSNotificationCenter
defaultCenter
]
+
removeObserver
:
self
+
name
:
UIDeviceOrientationDidChangeNotification
+
object
:
nil
]
;
+
}
+
+
-
(
AVCaptureVideoPreviewLayer
*
)
previewLayer
{
+
return
(
AVCaptureVideoPreviewLayer
*
)
self
.
layer
;
+
}
end
