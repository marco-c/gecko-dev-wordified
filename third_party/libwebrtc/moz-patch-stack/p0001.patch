From
:
Daniel
Baker
<
dbaker
mozilla
.
com
>
Date
:
Fri
24
Oct
2025
14
:
18
:
02
-
0600
Subject
:
(
tmp
-
cherry
-
pick
)
Revert
"
sigslot
:
make
PortInterface
:
:
SignalRoleConflict
a
CallbackLst
"
(
a275d3e4af
)
This
reverts
commit
1c0ba91c855f26868a6864ff048ca7ebf03ce724
.
Reason
for
revert
:
Break
downstream
project
Bug
:
webrtc
:
42222066
Original
change
'
s
description
:
>
sigslot
:
make
PortInterface
:
:
SignalRoleConflict
a
CallbackLst
>
>
Bug
:
webrtc
:
42222066
>
Change
-
Id
:
I15dab9209a58fec8c42b4096dc5682e46a844e19
>
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
403220
>
Reviewed
-
by
:
Evan
Shrubsole
<
eshr
webrtc
.
org
>
>
Reviewed
-
by
:
Harald
Alvestrand
<
hta
webrtc
.
org
>
>
Commit
-
Queue
:
Philipp
Hancke
<
phancke
meta
.
com
>
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
45406
}
Bug
:
webrtc
:
42222066
No
-
Presubmit
:
true
No
-
Tree
-
Checks
:
true
No
-
Try
:
true
Change
-
Id
:
I51121efd42f49b172fd5f0fd1b562010ec6242af
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
405660
Owners
-
Override
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
Bot
-
Commit
:
Rubber
Stamper
<
rubber
-
stamper
appspot
.
gserviceaccount
.
com
>
Commit
-
Queue
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
45410
}
-
-
-
p2p
/
BUILD
.
gn
|
1
-
p2p
/
base
/
connection
.
cc
|
2
+
-
p2p
/
base
/
p2p_transport_channel
.
cc
|
10
+
+
+
+
+
-
-
-
-
-
p2p
/
base
/
p2p_transport_channel
.
h
|
2
+
-
p2p
/
base
/
port
.
cc
|
13
+
+
-
-
-
-
-
-
-
-
-
-
-
p2p
/
base
/
port
.
h
|
7
-
-
-
-
-
-
-
p2p
/
base
/
port_interface
.
h
|
4
+
-
-
-
p2p
/
base
/
port_unittest
.
cc
|
8
+
+
+
-
-
-
-
-
8
files
changed
13
insertions
(
+
)
34
deletions
(
-
)
diff
-
-
git
a
/
p2p
/
BUILD
.
gn
b
/
p2p
/
BUILD
.
gn
index
8431c4ce1b
.
.
f101a540b9
100644
-
-
-
a
/
p2p
/
BUILD
.
gn
+
+
+
b
/
p2p
/
BUILD
.
gn
-
649
7
+
649
6
rtc_library
(
"
port_interface
"
)
{
"
.
.
/
rtc_base
:
socket_address
"
"
.
.
/
rtc_base
/
network
:
sent_packet
"
"
.
.
/
rtc_base
/
third_party
/
sigslot
"
-
"
/
/
third_party
/
abseil
-
cpp
/
absl
/
functional
:
any_invocable
"
"
/
/
third_party
/
abseil
-
cpp
/
absl
/
strings
:
string_view
"
]
}
diff
-
-
git
a
/
p2p
/
base
/
connection
.
cc
b
/
p2p
/
base
/
connection
.
cc
index
659afe7c26
.
.
18288daf47
100644
-
-
-
a
/
p2p
/
base
/
connection
.
cc
+
+
+
b
/
p2p
/
base
/
connection
.
cc
-
1611
7
+
1611
7
void
Connection
:
:
OnConnectionRequestErrorResponse
(
ConnectionRequest
*
request
error_code
=
=
STUN_ERROR_UNAUTHORIZED
)
{
/
/
Recoverable
error
retry
}
else
if
(
error_code
=
=
STUN_ERROR_ROLE_CONFLICT
)
{
-
port_
-
>
NotifyRoleConflict
(
)
;
+
port_
-
>
SignalRoleConflict
(
port_
.
get
(
)
)
;
}
else
if
(
request
-
>
msg
(
)
-
>
type
(
)
=
=
GOOG_PING_REQUEST
)
{
/
/
Race
retry
.
}
else
{
diff
-
-
git
a
/
p2p
/
base
/
p2p_transport_channel
.
cc
b
/
p2p
/
base
/
p2p_transport_channel
.
cc
index
6c928bc8a9
.
.
323cdd26ab
100644
-
-
-
a
/
p2p
/
base
/
p2p_transport_channel
.
cc
+
+
+
b
/
p2p
/
base
/
p2p_transport_channel
.
cc
-
921
15
+
921
15
void
P2PTransportChannel
:
:
OnPortReady
(
PortAllocatorSession
*
/
*
session
*
/
ports_
.
push_back
(
port
)
;
port
-
>
SignalUnknownAddress
.
connect
(
this
&
P2PTransportChannel
:
:
OnUnknownAddress
)
;
-
port
-
>
SignalSentPacket
.
connect
(
this
&
P2PTransportChannel
:
:
OnSentPacket
)
;
-
port
-
>
SubscribePortDestroyed
(
[
this
]
(
PortInterface
*
port
)
{
OnPortDestroyed
(
port
)
;
}
)
;
-
port
-
>
SubscribeRoleConflict
(
-
[
this
]
(
PortInterface
*
/
*
unused
*
/
)
{
NotifyRoleConflict
(
)
;
}
)
;
+
+
port
-
>
SignalRoleConflict
.
connect
(
this
&
P2PTransportChannel
:
:
OnRoleConflict
)
;
+
port
-
>
SignalSentPacket
.
connect
(
this
&
P2PTransportChannel
:
:
OnSentPacket
)
;
/
/
Attempt
to
create
a
connection
from
this
new
port
to
all
of
the
remote
/
/
candidates
that
we
were
given
so
far
.
+
std
:
:
vector
<
RemoteCandidate
>
:
:
iterator
iter
;
for
(
iter
=
remote_candidates_
.
begin
(
)
;
iter
!
=
remote_candidates_
.
end
(
)
;
+
+
iter
)
{
-
1133
7
+
1133
7
void
P2PTransportChannel
:
:
OnCandidateFilterChanged
(
uint32_t
prev_filter
}
}
-
void
P2PTransportChannel
:
:
NotifyRoleConflict
(
)
{
+
void
P2PTransportChannel
:
:
OnRoleConflict
(
PortInterface
*
/
*
port
*
/
)
{
SignalRoleConflict
(
this
)
;
/
/
STUN
ping
will
be
sent
when
SetRole
is
called
/
/
from
Transport
.
}
diff
-
-
git
a
/
p2p
/
base
/
p2p_transport_channel
.
h
b
/
p2p
/
base
/
p2p_transport_channel
.
h
index
067d2dce52
.
.
738e48e26a
100644
-
-
-
a
/
p2p
/
base
/
p2p_transport_channel
.
h
+
+
+
b
/
p2p
/
base
/
p2p_transport_channel
.
h
-
364
7
+
364
7
class
RTC_EXPORT
P2PTransportChannel
:
public
IceTransportInternal
/
/
When
pruning
a
port
move
it
from
ports_
to
pruned_ports_
.
/
/
Returns
true
if
the
port
is
found
and
removed
from
ports_
.
bool
PrunePort
(
PortInterface
*
port
)
;
-
void
NotifyRoleConflict
(
)
;
+
void
OnRoleConflict
(
PortInterface
*
port
)
;
void
OnConnectionStateChange
(
Connection
*
connection
)
;
void
OnReadPacket
(
Connection
*
connection
const
ReceivedIpPacket
&
packet
)
;
diff
-
-
git
a
/
p2p
/
base
/
port
.
cc
b
/
p2p
/
base
/
port
.
cc
index
2bab064184
.
.
68fb212bf4
100644
-
-
-
a
/
p2p
/
base
/
port
.
cc
+
+
+
b
/
p2p
/
base
/
port
.
cc
-
682
7
+
682
7
bool
Port
:
:
MaybeIceRoleConflict
(
const
SocketAddress
&
addr
case
ICEROLE_CONTROLLING
:
if
(
ICEROLE_CONTROLLING
=
=
remote_ice_role
)
{
if
(
remote_tiebreaker
>
=
tiebreaker_
)
{
-
NotifyRoleConflict
(
)
;
+
SignalRoleConflict
(
this
)
;
}
else
{
/
/
Send
Role
Conflict
(
487
)
error
response
.
SendBindingErrorResponse
(
stun_msg
addr
STUN_ERROR_ROLE_CONFLICT
-
694
7
+
694
7
bool
Port
:
:
MaybeIceRoleConflict
(
const
SocketAddress
&
addr
case
ICEROLE_CONTROLLED
:
if
(
ICEROLE_CONTROLLED
=
=
remote_ice_role
)
{
if
(
remote_tiebreaker
<
tiebreaker_
)
{
-
NotifyRoleConflict
(
)
;
+
SignalRoleConflict
(
this
)
;
}
else
{
/
/
Send
Role
Conflict
(
487
)
error
response
.
SendBindingErrorResponse
(
stun_msg
addr
STUN_ERROR_ROLE_CONFLICT
-
1021
13
+
1021
4
void
Port
:
:
OnRequestLocalNetworkAccessPermission
(
std
:
:
move
(
callback
)
(
status
)
;
}
-
void
Port
:
:
SubscribeRoleConflict
(
-
std
:
:
function
<
void
(
PortInterface
*
/
*
unused
*
/
)
>
callback
)
{
-
role_conflict_callback_list_
.
AddReceiver
(
std
:
:
move
(
callback
)
)
;
-
}
-
-
void
Port
:
:
NotifyRoleConflict
(
)
{
-
role_conflict_callback_list_
.
Send
(
this
)
;
-
}
-
}
/
/
namespace
webrtc
diff
-
-
git
a
/
p2p
/
base
/
port
.
h
b
/
p2p
/
base
/
port
.
h
index
5ceddb477c
.
.
e25ec527a4
100644
-
-
-
a
/
p2p
/
base
/
port
.
h
+
+
+
b
/
p2p
/
base
/
port
.
h
-
383
11
+
383
6
class
RTC_EXPORT
Port
:
public
PortInterface
public
sigslot
:
:
has_slots
<
>
{
void
GetStunStats
(
std
:
:
optional
<
StunStats
>
*
/
*
stats
*
/
)
override
{
}
-
/
/
Signals
for
ICE
role
conflicts
.
-
void
SubscribeRoleConflict
(
-
std
:
:
function
<
void
(
PortInterface
*
)
>
callback
)
override
;
-
void
NotifyRoleConflict
(
)
override
;
-
protected
:
void
UpdateNetworkCost
(
)
override
;
-
557
8
+
552
6
class
RTC_EXPORT
Port
:
public
PortInterface
public
sigslot
:
:
has_slots
<
>
{
CallbackList
<
Port
*
const
IceCandidateErrorEvent
&
>
candidate_error_callback_list_
RTC_GUARDED_BY
(
thread_
)
;
-
CallbackList
<
PortInterface
*
>
role_conflict_callback_list_
;
-
/
/
Keep
as
the
last
member
variable
.
WeakPtrFactory
<
Port
>
weak_factory_
RTC_GUARDED_BY
(
thread_
)
;
}
;
diff
-
-
git
a
/
p2p
/
base
/
port_interface
.
h
b
/
p2p
/
base
/
port_interface
.
h
index
a25e6cd5c3
.
.
2335fc2434
100644
-
-
-
a
/
p2p
/
base
/
port_interface
.
h
+
+
+
b
/
p2p
/
base
/
port_interface
.
h
-
124
9
+
124
7
class
PortInterface
{
std
:
:
function
<
void
(
PortInterface
*
)
>
callback
)
=
0
;
/
/
Signaled
when
Port
discovers
ice
role
conflict
with
the
peer
.
-
virtual
void
SubscribeRoleConflict
(
-
std
:
:
function
<
void
(
PortInterface
*
)
>
callback
)
=
0
;
-
virtual
void
NotifyRoleConflict
(
)
=
0
;
+
sigslot
:
:
signal1
<
PortInterface
*
>
SignalRoleConflict
;
/
/
Normally
packets
arrive
through
a
connection
(
or
they
result
signaling
of
/
/
unknown
address
)
.
Calling
this
method
turns
off
delivery
of
packets
diff
-
-
git
a
/
p2p
/
base
/
port_unittest
.
cc
b
/
p2p
/
base
/
port_unittest
.
cc
index
f8cdc6efac
.
.
60aa47d0fb
100644
-
-
-
a
/
p2p
/
base
/
port_unittest
.
cc
+
+
+
b
/
p2p
/
base
/
port_unittest
.
cc
-
879
8
+
879
7
class
PortTest
:
public
:
:
testing
:
:
Test
public
sigslot
:
:
has_slots
<
>
{
.
ice_username_fragment
=
username
.
ice_password
=
password
}
;
auto
port
=
std
:
:
make_unique
<
TestPort
>
(
args
0
0
)
;
-
port
-
>
SubscribeRoleConflict
(
-
[
this
]
(
const
PortInterface
*
)
{
OnRoleConflict
(
)
;
}
)
;
+
port
-
>
SignalRoleConflict
.
connect
(
this
&
PortTest
:
:
OnRoleConflict
)
;
return
port
;
}
std
:
:
unique_ptr
<
TestPort
>
CreateTestPort
(
const
SocketAddress
&
addr
-
904
12
+
903
11
class
PortTest
:
public
:
:
testing
:
:
Test
public
sigslot
:
:
has_slots
<
>
{
.
ice_username_fragment
=
username
.
ice_password
=
password
}
;
auto
port
=
std
:
:
make_unique
<
TestPort
>
(
args
0
0
)
;
-
port
-
>
SubscribeRoleConflict
(
-
[
this
]
(
const
PortInterface
*
)
{
OnRoleConflict
(
)
;
}
)
;
+
port
-
>
SignalRoleConflict
.
connect
(
this
&
PortTest
:
:
OnRoleConflict
)
;
return
port
;
}
-
void
OnRoleConflict
(
)
{
role_conflict_
=
true
;
}
+
void
OnRoleConflict
(
PortInterface
*
port
)
{
role_conflict_
=
true
;
}
bool
role_conflict
(
)
const
{
return
role_conflict_
;
}
void
ConnectToSignalDestroyed
(
PortInterface
*
port
)
{
