From
:
Daniel
Baker
<
dbaker
mozilla
.
com
>
Date
:
Mon
1
Dec
2025
23
:
38
:
54
-
0700
Subject
:
(
tmp
-
cherry
-
pick
)
Revert
"
Define
a
movable
variant
of
SequenceChecker
"
(
fa7d10eb73
)
This
reverts
commit
797bd0afe38685b635179f0870fbc4b019d049b5
.
Reason
for
revert
:
A
lock
detector
downstream
didn
'
t
like
it
.
Original
change
'
s
description
:
>
Define
a
movable
variant
of
SequenceChecker
>
>
and
use
it
to
instrument
the
(
movable
/
copyable
)
IceCandidateCollection
>
>
Bug
:
None
>
Change
-
Id
:
I055b13d3c8c94eff5e045df691df5c0c523886ed
>
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
409546
>
Reviewed
-
by
:
Tomas
Gunnarsson
<
tommi
webrtc
.
org
>
>
Commit
-
Queue
:
Harald
Alvestrand
<
hta
webrtc
.
org
>
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
45716
}
Bug
:
None
No
-
Presubmit
:
true
No
-
Tree
-
Checks
:
true
No
-
Try
:
true
Change
-
Id
:
Ic29d440e65c34c7034d87c8da7f39126376cb306
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
411781
Bot
-
Commit
:
Rubber
Stamper
<
rubber
-
stamper
appspot
.
gserviceaccount
.
com
>
Commit
-
Queue
:
Rubber
Stamper
<
rubber
-
stamper
appspot
.
gserviceaccount
.
com
>
Auto
-
Submit
:
Harald
Alvestrand
<
hta
webrtc
.
org
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
45720
}
-
-
-
api
/
DEPS
|
1
-
api
/
jsep
.
h
|
43
+
+
+
-
-
-
-
api
/
jsep_ice_candidate
.
cc
|
15
+
-
-
api
/
sequence_checker
.
h
|
49
-
-
-
-
-
-
-
-
api
/
sequence_checker_unittest
.
cc
|
119
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
pc
/
BUILD
.
gn
|
1
-
pc
/
jsep_ice_candidate
.
cc
|
4
+
-
pc
/
jsep_session_description
.
cc
|
13
+
-
.
.
.
/
sequence_checker_internal
.
cc
|
28
-
-
-
-
-
.
.
.
/
sequence_checker_internal
.
h
|
62
-
-
-
-
-
-
-
-
-
10
files
changed
21
insertions
(
+
)
314
deletions
(
-
)
diff
-
-
git
a
/
api
/
DEPS
b
/
api
/
DEPS
index
3a5554e188
.
.
51421a4e23
100644
-
-
-
a
/
api
/
DEPS
+
+
+
b
/
api
/
DEPS
-
115
7
+
115
6
specific_include_rules
=
{
"
+
absl
/
strings
/
has_absl_stringify
.
h
"
"
+
absl
/
strings
/
str_format
.
h
"
"
+
rtc_base
/
system
/
no_unique_address
.
h
"
-
"
+
rtc_base
/
thread_annotations
.
h
"
]
"
local_network_access_permission
\
.
h
"
:
[
diff
-
-
git
a
/
api
/
jsep
.
h
b
/
api
/
jsep
.
h
index
9befa94cf3
.
.
408a92982b
100644
-
-
-
a
/
api
/
jsep
.
h
+
+
+
b
/
api
/
jsep
.
h
-
37
7
+
37
6
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
rtc_base
/
system
/
no_unique_address
.
h
"
#
include
"
rtc_base
/
system
/
rtc_export
.
h
"
-
#
include
"
rtc_base
/
thread_annotations
.
h
"
namespace
webrtc
{
-
147
14
+
146
8
class
IceCandidateCollection
final
{
IceCandidateCollection
(
const
IceCandidateCollection
&
)
=
delete
;
IceCandidateCollection
&
operator
=
(
const
IceCandidateCollection
&
)
=
delete
;
-
size_t
count
(
)
const
{
-
RTC_DCHECK_RUN_ON
(
&
sequence_checker_
)
;
-
return
candidates_
.
size
(
)
;
-
}
-
bool
empty
(
)
const
{
-
RTC_DCHECK_RUN_ON
(
&
sequence_checker_
)
;
-
return
candidates_
.
empty
(
)
;
-
}
+
size_t
count
(
)
const
{
return
candidates_
.
size
(
)
;
}
+
bool
empty
(
)
const
{
return
candidates_
.
empty
(
)
;
}
const
IceCandidate
*
at
(
size_t
index
)
const
;
/
/
Adds
and
takes
ownership
of
the
IceCandidate
.
-
178
12
+
171
9
class
IceCandidateCollection
final
{
bool
HasCandidate
(
const
IceCandidate
*
candidate
)
const
;
IceCandidateCollection
Clone
(
)
const
;
-
void
RelinquishThreadOwnership
(
)
;
private
:
-
RTC_NO_UNIQUE_ADDRESS
AutoDetachingSequenceChecker
sequence_checker_
;
-
std
:
:
vector
<
std
:
:
unique_ptr
<
IceCandidate
>
>
candidates_
-
RTC_GUARDED_BY
(
sequence_checker_
)
;
+
std
:
:
vector
<
std
:
:
unique_ptr
<
IceCandidate
>
>
candidates_
;
}
;
/
/
TODO
:
webrtc
:
406795492
-
Deprecate
.
-
240
6
+
230
12
class
SessionDescriptionInternal
{
~
SessionDescriptionInternal
(
)
;
+
/
/
Resets
the
internal
sequence_checker_
to
not
be
attached
to
a
particular
+
/
/
thread
.
Used
when
transfering
object
ownership
between
threads
.
Must
be
+
/
/
called
by
the
thread
that
currently
owns
the
object
before
transferring
the
+
/
/
ownership
.
+
void
RelinquishThreadOwnership
(
)
;
+
protected
:
/
/
Only
meant
for
the
SessionDescriptionInterface
implementation
.
SdpType
sdp_type
(
)
const
{
return
sdp_type_
;
}
-
249
8
+
245
15
class
SessionDescriptionInternal
{
SessionDescription
*
description
(
)
{
return
description_
.
get
(
)
;
}
size_t
mediasection_count
(
)
const
;
+
protected
:
+
/
/
This
method
is
necessarily
protected
and
not
private
while
+
/
/
the
SessionDescriptionInterface
implementation
is
being
consolidated
+
/
/
into
a
single
class
.
+
const
SequenceChecker
*
sequence_checker
(
)
const
{
return
&
sequence_checker_
;
}
private
:
+
RTC_NO_UNIQUE_ADDRESS
SequenceChecker
sequence_checker_
{
+
SequenceChecker
:
:
kDetached
}
;
const
SdpType
sdp_type_
;
const
std
:
:
string
id_
;
const
std
:
:
string
version_
;
-
353
12
+
356
6
class
RTC_EXPORT
SessionDescriptionInterface
sink
.
Append
(
"
-
-
-
END
SDP
-
-
-
\
n
"
)
;
}
-
/
/
Resets
the
internal
sequence_checker_
to
not
be
attached
to
a
particular
-
/
/
thread
.
Used
when
transfering
object
ownership
between
threads
.
Must
be
-
/
/
called
by
the
thread
that
currently
owns
the
object
before
transferring
the
-
/
/
ownership
.
-
void
RelinquishThreadOwnership
(
)
;
-
protected
:
explicit
SessionDescriptionInterface
(
SdpType
type
-
367
19
+
364
11
class
RTC_EXPORT
SessionDescriptionInterface
absl
:
:
string_view
version
std
:
:
vector
<
IceCandidateCollection
>
candidates
=
{
}
)
;
-
protected
:
-
/
/
This
method
is
necessarily
protected
and
not
private
while
-
/
/
the
SessionDescriptionInterface
implementation
is
being
consolidated
-
/
/
into
a
single
class
.
-
const
SequenceChecker
*
sequence_checker
(
)
const
{
return
&
sequence_checker_
;
}
-
private
:
bool
IsValidMLineIndex
(
int
index
)
const
;
bool
GetMediasectionIndex
(
const
IceCandidate
*
candidate
size_t
*
index
)
const
;
int
GetMediasectionIndex
(
absl
:
:
string_view
mid
)
const
;
-
RTC_NO_UNIQUE_ADDRESS
SequenceChecker
sequence_checker_
{
-
SequenceChecker
:
:
kDetached
}
;
std
:
:
vector
<
IceCandidateCollection
>
candidate_collection_
RTC_GUARDED_BY
(
sequence_checker
(
)
)
;
}
;
diff
-
-
git
a
/
api
/
jsep_ice_candidate
.
cc
b
/
api
/
jsep_ice_candidate
.
cc
index
9cc8b93b23
.
.
ce0304f599
100644
-
-
-
a
/
api
/
jsep_ice_candidate
.
cc
+
+
+
b
/
api
/
jsep_ice_candidate
.
cc
-
12
7
+
12
6
#
include
<
cstddef
>
#
include
<
cstdint
>
-
#
include
<
iterator
>
#
include
<
limits
>
#
include
<
memory
>
#
include
<
string
>
-
23
7
+
22
6
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
candidate
.
h
"
#
include
"
api
/
jsep
.
h
"
-
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
-
53
30
+
51
24
IceCandidate
:
:
IceCandidate
(
absl
:
:
string_view
sdp_mid
}
void
IceCandidateCollection
:
:
add
(
std
:
:
unique_ptr
<
IceCandidate
>
candidate
)
{
-
RTC_DCHECK_RUN_ON
(
&
sequence_checker_
)
;
candidates_
.
push_back
(
std
:
:
move
(
candidate
)
)
;
}
void
IceCandidateCollection
:
:
add
(
IceCandidate
*
candidate
)
{
-
RTC_DCHECK_RUN_ON
(
&
sequence_checker_
)
;
candidates_
.
push_back
(
absl
:
:
WrapUnique
(
candidate
)
)
;
}
void
IceCandidateCollection
:
:
Append
(
IceCandidateCollection
collection
)
{
-
RTC_DCHECK_RUN_ON
(
&
sequence_checker_
)
;
-
RTC_DCHECK_RUN_ON
(
&
collection
.
sequence_checker_
)
;
candidates_
.
insert
(
candidates_
.
end
(
)
std
:
:
make_move_iterator
(
collection
.
candidates_
.
begin
(
)
)
std
:
:
make_move_iterator
(
collection
.
candidates_
.
end
(
)
)
)
;
}
const
IceCandidate
*
IceCandidateCollection
:
:
at
(
size_t
index
)
const
{
-
RTC_DCHECK_RUN_ON
(
&
sequence_checker_
)
;
return
candidates_
[
index
]
.
get
(
)
;
}
bool
IceCandidateCollection
:
:
HasCandidate
(
const
IceCandidate
*
candidate
)
const
{
-
RTC_DCHECK_RUN_ON
(
&
sequence_checker_
)
;
const
auto
sdp_mid
=
candidate
-
>
sdp_mid
(
)
;
/
/
avoid
string
copy
per
entry
.
return
absl
:
:
c_any_of
(
candidates_
[
&
]
(
const
std
:
:
unique_ptr
<
IceCandidate
>
&
entry
)
{
-
92
8
+
84
7
bool
IceCandidateCollection
:
:
HasCandidate
(
const
IceCandidate
*
candidate
)
const
{
}
)
;
}
-
size_t
IceCandidateCollection
:
:
remove
(
const
IceCandidate
*
candidate
)
{
-
RTC_DCHECK_RUN_ON
(
&
sequence_checker_
)
;
+
size_t
JsepCandidateCollection
:
:
remove
(
const
IceCandidate
*
candidate
)
{
RTC_DCHECK
(
candidate
)
;
auto
iter
=
absl
:
:
c_find_if
(
candidates_
[
&
]
(
const
std
:
:
unique_ptr
<
IceCandidate
>
&
c
)
{
-
106
8
+
97
4
size_t
IceCandidateCollection
:
:
remove
(
const
IceCandidate
*
candidate
)
{
return
0u
;
}
-
void
IceCandidateCollection
:
:
RelinquishThreadOwnership
(
)
{
-
sequence_checker_
.
Detach
(
)
;
-
}
-
}
/
/
namespace
webrtc
diff
-
-
git
a
/
api
/
sequence_checker
.
h
b
/
api
/
sequence_checker
.
h
index
d05bb2da5e
.
.
0d2d83806a
100644
-
-
-
a
/
api
/
sequence_checker
.
h
+
+
+
b
/
api
/
sequence_checker
.
h
-
10
8
+
10
6
#
ifndef
API_SEQUENCE_CHECKER_H_
#
define
API_SEQUENCE_CHECKER_H_
-
#
include
<
utility
>
-
#
include
"
api
/
task_queue
/
task_queue_base
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
synchronization
/
sequence_checker_internal
.
h
"
-
74
53
+
72
6
class
RTC_LOCKABLE
SequenceChecker
void
Detach
(
)
{
Impl
:
:
Detach
(
)
;
}
}
;
-
/
/
A
variant
of
SequenceChecker
where
moving
and
copying
is
allowed
-
/
/
and
will
automatically
detach
from
the
current
thread
.
-
/
/
This
allows
a
SequenceChecker
to
be
used
in
objects
that
are
used
-
/
/
with
standard
classes
such
as
std
:
:
vector
.
-
/
/
-
/
/
The
behavior
of
AutoDetachingSequenceChecker
is
:
-
/
/
-
When
created
on
its
own
it
is
detached
.
-
/
/
-
When
created
using
the
copy
constructor
the
new
object
is
attached
-
/
/
to
the
same
thread
as
the
original
(
which
may
be
different
from
-
/
/
the
thread
that
invokes
the
copy
operator
)
.
-
/
/
-
When
copied
using
the
copy
operator
the
new
object
is
attached
-
/
/
to
the
same
thread
as
the
original
(
which
may
be
different
from
-
/
/
the
thread
that
invokes
the
copy
operator
)
.
-
/
/
-
When
created
using
the
move
constructor
it
is
detached
.
-
/
/
-
When
moved
using
the
move
operator
both
the
original
object
and
-
/
/
the
moved
-
into
object
will
be
detached
.
-
-
class
RTC_LOCKABLE
AutoDetachingSequenceChecker
-
#
if
RTC_DCHECK_IS_ON
-
:
public
webrtc_sequence_checker_internal
:
:
-
AutoDetachingSequenceCheckerImpl
{
-
using
Impl
=
-
webrtc_sequence_checker_internal
:
:
AutoDetachingSequenceCheckerImpl
;
-
#
else
-
:
public
webrtc_sequence_checker_internal
:
:
-
AutoDetachingSequenceCheckerDoNothing
{
-
using
Impl
=
-
webrtc_sequence_checker_internal
:
:
AutoDetachingSequenceCheckerDoNothing
;
-
#
endif
-
public
:
-
AutoDetachingSequenceChecker
(
)
:
Impl
(
)
{
}
-
AutoDetachingSequenceChecker
(
const
AutoDetachingSequenceChecker
&
o
)
-
:
Impl
(
o
)
{
}
-
AutoDetachingSequenceChecker
&
operator
=
(
-
const
AutoDetachingSequenceChecker
&
o
)
{
-
Impl
:
:
operator
=
(
o
)
;
-
return
*
this
;
-
}
-
-
AutoDetachingSequenceChecker
(
AutoDetachingSequenceChecker
&
&
o
)
-
:
Impl
(
std
:
:
move
(
o
)
)
{
}
-
AutoDetachingSequenceChecker
&
operator
=
(
AutoDetachingSequenceChecker
&
&
o
)
{
-
Impl
:
:
operator
=
(
std
:
:
move
(
o
)
)
;
-
return
*
this
;
-
}
-
}
;
-
}
/
/
namespace
webrtc
/
/
RTC_RUN_ON
/
RTC_GUARDED_BY
/
RTC_DCHECK_RUN_ON
macros
allows
to
annotate
diff
-
-
git
a
/
api
/
sequence_checker_unittest
.
cc
b
/
api
/
sequence_checker_unittest
.
cc
index
77ea3cf145
.
.
b6e432c2d3
100644
-
-
-
a
/
api
/
sequence_checker_unittest
.
cc
+
+
+
b
/
api
/
sequence_checker_unittest
.
cc
-
12
7
+
12
6
#
include
<
functional
>
#
include
<
memory
>
-
#
include
<
utility
>
#
include
"
absl
/
functional
/
any_invocable
.
h
"
#
include
"
api
/
function_view
.
h
"
-
26
7
+
25
6
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
-
using
testing
:
:
Eq
;
using
testing
:
:
HasSubstr
;
namespace
webrtc
{
-
234
121
+
232
4
TEST
(
SequenceCheckerTest
TestAnnotationsOnWrongQueueRelease
)
{
}
#
endif
#
endif
/
/
GTEST_HAS_DEATH_TEST
-
-
/
/
This
class
is
a
helper
for
verifying
that
AutoDetachingSequenceChecker
-
/
/
can
be
made
a
member
of
a
class
with
default
copy
and
move
operations
.
-
class
MovableObject
{
-
public
:
-
MovableObject
(
)
=
default
;
-
/
/
Copy
operators
-
MovableObject
(
const
MovableObject
&
o
)
=
default
;
-
MovableObject
&
operator
=
(
const
MovableObject
&
o
)
=
default
;
-
/
/
Move
operators
-
MovableObject
(
MovableObject
&
&
o
)
=
default
;
-
MovableObject
&
operator
=
(
MovableObject
&
&
o
)
=
default
;
-
-
int
any_member
RTC_GUARDED_BY
(
sequence_checker_
)
=
4711
;
-
AutoDetachingSequenceChecker
sequence_checker_
;
-
}
;
-
-
TEST
(
AutoDetachingSequenceCheckerTest
CanDeclareMovableObject
)
{
-
MovableObject
foo
;
-
RTC_DCHECK_RUN_ON
(
&
foo
.
sequence_checker_
)
;
-
EXPECT_THAT
(
foo
.
any_member
Eq
(
4711
)
)
;
-
}
-
-
TEST
(
AutoDetachingSequenceCheckerTest
CanCopyMovableObject
)
{
-
MovableObject
foo
;
-
RTC_DCHECK_RUN_ON
(
&
foo
.
sequence_checker_
)
;
-
foo
.
any_member
=
12
;
-
MovableObject
bar
=
foo
;
-
RTC_DCHECK_RUN_ON
(
&
bar
.
sequence_checker_
)
;
-
EXPECT_THAT
(
bar
.
any_member
Eq
(
12
)
)
;
-
}
-
-
#
if
RTC_DCHECK_IS_ON
-
/
/
The
tests
below
use
the
helper
functions
IsAttachedForTesting
and
-
/
/
HasSameAttachmentForTesting
which
are
only
present
on
the
-
/
/
AutoDetachingSequenceChecker
when
compiled
with
DCHECK
on
.
-
TEST
(
AutoDetachingSequenceCheckerTest
InitialStateIsDetached
)
{
-
AutoDetachingSequenceChecker
foo
;
-
EXPECT_FALSE
(
foo
.
IsAttachedForTesting
(
)
)
;
-
}
-
-
TEST
(
AutoDetachingSequenceCheckerTest
CopyConstructorKeepsAttachment
)
{
-
AutoDetachingSequenceChecker
foo
;
-
EXPECT_FALSE
(
foo
.
IsAttachedForTesting
(
)
)
;
-
AutoDetachingSequenceChecker
bar
(
foo
)
;
-
EXPECT_FALSE
(
bar
.
IsAttachedForTesting
(
)
)
;
-
RTC_DCHECK_RUN_ON
(
&
foo
)
;
-
EXPECT_TRUE
(
foo
.
IsAttachedForTesting
(
)
)
;
-
AutoDetachingSequenceChecker
baz
(
foo
)
;
-
EXPECT_TRUE
(
baz
.
IsAttachedForTesting
(
)
)
;
-
EXPECT_TRUE
(
baz
.
HasSameAttachmentForTesting
(
foo
)
)
;
-
}
-
-
TEST
(
AutoDetachingSequenceCheckerTest
MoveDetachesFromCurrentThread
)
{
-
TaskQueueForTest
queue
;
-
AutoDetachingSequenceChecker
foo
;
-
EXPECT_FALSE
(
foo
.
IsAttachedForTesting
(
)
)
;
-
RTC_DCHECK_RUN_ON
(
&
foo
)
;
-
EXPECT_TRUE
(
foo
.
IsAttachedForTesting
(
)
)
;
-
AutoDetachingSequenceChecker
bar
=
std
:
:
move
(
foo
)
;
-
EXPECT_FALSE
(
bar
.
IsAttachedForTesting
(
)
)
;
-
EXPECT_FALSE
(
foo
.
IsAttachedForTesting
(
)
)
;
-
}
-
-
TEST
(
AutoDetachingSequenceCheckerTest
MoveDetachesFromCurrentThreadInCapture
)
{
-
TaskQueueForTest
queue
;
-
AutoDetachingSequenceChecker
foo
;
-
RTC_DCHECK_RUN_ON
(
&
foo
)
;
-
queue
.
SendTask
(
[
bar
=
std
:
:
move
(
foo
)
]
(
)
{
-
EXPECT_FALSE
(
bar
.
IsAttachedForTesting
(
)
)
;
-
RTC_DCHECK_RUN_ON
(
&
bar
)
;
-
EXPECT_TRUE
(
bar
.
IsAttachedForTesting
(
)
)
;
-
}
)
;
-
EXPECT_FALSE
(
foo
.
IsAttachedForTesting
(
)
)
;
-
}
-
-
TEST
(
AutoDetachingSequenceCheckerTest
CopyOperatorKeepsOldThread
)
{
-
TaskQueueForTest
queue
;
-
AutoDetachingSequenceChecker
object1
;
-
AutoDetachingSequenceChecker
object2
;
-
/
/
Attach
object1
to
current
thread
.
-
RTC_DCHECK_RUN_ON
(
&
object1
)
;
-
queue
.
SendTask
(
[
&
]
(
)
{
-
/
/
Attach
object2
to
this
task
queue
-
RTC_DCHECK_RUN_ON
(
&
object2
)
;
-
/
/
Overwriting
will
attach
object2
to
object1
'
s
bound
thread
.
-
object2
=
object1
;
-
}
)
;
-
EXPECT_TRUE
(
object1
.
HasSameAttachmentForTesting
(
object2
)
)
;
-
}
-
#
endif
/
/
RTC_DCHECK_IS_ON
-
-
#
if
GTEST_HAS_DEATH_TEST
&
&
!
defined
(
WEBRTC_ANDROID
)
&
&
RTC_DCHECK_IS_ON
-
TEST
(
AutoDetachingSequenceCheckerDeathTest
NotMovingCrashes
)
{
-
TaskQueueForTest
queue
;
-
AutoDetachingSequenceChecker
unmoved_object
;
-
/
/
Attach
unmoved_object
to
the
queue
not
the
main
thread
-
queue
.
SendTask
(
[
&
unmoved_object
]
(
)
{
RTC_DCHECK_RUN_ON
(
&
unmoved_object
)
;
}
)
;
-
ASSERT_DEATH
(
{
RTC_DCHECK_RUN_ON
(
&
unmoved_object
)
}
"
IsCurrent
"
)
;
-
}
-
-
TEST
(
AutoDetachingSequenceCheckerDeathTest
-
CopyOperatorKeepsOldThreadAndCrashes
)
{
-
TaskQueueForTest
queue
;
-
AutoDetachingSequenceChecker
object1
;
-
AutoDetachingSequenceChecker
object2
;
-
/
/
Attach
object2
to
current
thread
.
-
RTC_DCHECK_RUN_ON
(
&
object2
)
;
-
queue
.
SendTask
(
[
&
]
(
)
{
-
RTC_DCHECK_RUN_ON
(
&
object1
)
;
-
object2
=
object1
;
/
/
This
assignment
overwrites
the
attachment
.
-
}
)
;
-
/
/
object2
is
now
attached
to
the
task
queue
.
-
ASSERT_DEATH
(
{
RTC_DCHECK_RUN_ON
(
&
object2
)
}
"
IsCurrent
"
)
;
-
}
-
-
#
endif
}
/
/
namespace
webrtc
diff
-
-
git
a
/
pc
/
BUILD
.
gn
b
/
pc
/
BUILD
.
gn
index
949b8ff106
.
.
139f78efe7
100644
-
-
-
a
/
pc
/
BUILD
.
gn
+
+
+
b
/
pc
/
BUILD
.
gn
-
1434
7
+
1434
6
rtc_library
(
"
webrtc_sdp
"
)
{
"
.
.
/
api
:
rtc_error
"
"
.
.
/
api
:
rtp_parameters
"
"
.
.
/
api
:
rtp_transceiver_direction
"
-
"
.
.
/
api
:
sequence_checker
"
"
.
.
/
api
/
audio
:
audio_frame_api
"
"
.
.
/
media
:
codec
"
"
.
.
/
media
:
media_constants
"
diff
-
-
git
a
/
pc
/
jsep_ice_candidate
.
cc
b
/
pc
/
jsep_ice_candidate
.
cc
index
e236eb52ed
.
.
710587a3ff
100644
-
-
-
a
/
pc
/
jsep_ice_candidate
.
cc
+
+
+
b
/
pc
/
jsep_ice_candidate
.
cc
-
10
6
+
10
7
#
include
"
api
/
jsep_ice_candidate
.
h
"
+
#
include
<
cstddef
>
#
include
<
memory
>
#
include
<
string
>
-
17
7
+
18
6
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
candidate
.
h
"
#
include
"
api
/
jsep
.
h
"
-
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
pc
/
webrtc_sdp
.
h
"
/
/
This
file
contains
IceCandidate
-
related
functions
that
are
not
-
60
8
+
60
6
std
:
:
unique_ptr
<
IceCandidate
>
IceCandidate
:
:
Create
(
absl
:
:
string_view
mid
IceCandidateCollection
IceCandidateCollection
:
:
Clone
(
)
const
{
IceCandidateCollection
new_collection
;
-
RTC_DCHECK_RUN_ON
(
&
sequence_checker_
)
;
-
RTC_DCHECK_RUN_ON
(
&
new_collection
.
sequence_checker_
)
;
new_collection
.
candidates_
.
reserve
(
candidates_
.
size
(
)
)
;
for
(
const
auto
&
candidate
:
candidates_
)
{
new_collection
.
candidates_
.
push_back
(
std
:
:
make_unique
<
IceCandidate
>
(
diff
-
-
git
a
/
pc
/
jsep_session_description
.
cc
b
/
pc
/
jsep_session_description
.
cc
index
fbd8bfacc0
.
.
d1f1dd006b
100644
-
-
-
a
/
pc
/
jsep_session_description
.
cc
+
+
+
b
/
pc
/
jsep_session_description
.
cc
-
14
6
+
14
7
#
include
<
cstddef
>
#
include
<
iterator
>
#
include
<
memory
>
+
#
include
<
optional
>
#
include
<
string
>
#
include
<
utility
>
#
include
<
vector
>
-
22
7
+
23
6
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
candidate
.
h
"
#
include
"
api
/
jsep
.
h
"
-
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
p2p
/
base
/
p2p_constants
.
h
"
#
include
"
p2p
/
base
/
transport_description
.
h
"
#
include
"
p2p
/
base
/
transport_info
.
h
"
-
31
6
+
31
7
#
include
"
pc
/
webrtc_sdp
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
ip_address
.
h
"
+
#
include
"
rtc_base
/
logging
.
h
"
#
include
"
rtc_base
/
net_helper
.
h
"
#
include
"
rtc_base
/
net_helpers
.
h
"
#
include
"
rtc_base
/
socket_address
.
h
"
-
180
7
+
181
7
size_t
SessionDescriptionInternal
:
:
mediasection_count
(
)
const
{
return
description_
?
description_
-
>
contents
(
)
.
size
(
)
:
0u
;
}
-
void
SessionDescriptionInterface
:
:
RelinquishThreadOwnership
(
)
{
+
void
SessionDescriptionInternal
:
:
RelinquishThreadOwnership
(
)
{
/
/
Ideally
we
should
require
that
the
method
can
only
be
called
from
the
/
/
thread
that
the
sequence
checker
is
currently
attached
to
.
However
that
'
s
/
/
not
compatible
with
some
cases
outside
of
webrtc
where
initializations
-
188
13
+
189
6
void
SessionDescriptionInterface
:
:
RelinquishThreadOwnership
(
)
{
/
/
signaling
)
where
a
call
is
made
into
webrtc
.
At
that
point
we
'
d
hit
a
/
/
dcheck
like
this
in
webrtc
:
RTC_DCHECK_RUN_ON
(
&
sequence_checker_
)
;
sequence_checker_
.
Detach
(
)
;
-
/
/
Tie
the
checker
to
the
current
thread
which
permits
iterating
-
/
/
candidate_collection_
-
RTC_DCHECK_RUN_ON
(
sequence_checker
(
)
)
;
-
for
(
IceCandidateCollection
&
collection
:
candidate_collection_
)
{
-
collection
.
RelinquishThreadOwnership
(
)
;
-
}
-
sequence_checker_
.
Detach
(
)
;
/
/
Unties
the
checker
from
the
current
thread
.
}
SessionDescriptionInterface
:
:
SessionDescriptionInterface
(
-
341
5
+
335
4
int
SessionDescriptionInterface
:
:
GetMediasectionIndex
(
[
&
]
(
const
auto
&
content
)
{
return
mid
=
=
content
.
mid
(
)
;
}
)
;
return
it
=
=
contents
.
end
(
)
?
-
1
:
std
:
:
distance
(
contents
.
begin
(
)
it
)
;
}
-
}
/
/
namespace
webrtc
diff
-
-
git
a
/
rtc_base
/
synchronization
/
sequence_checker_internal
.
cc
b
/
rtc_base
/
synchronization
/
sequence_checker_internal
.
cc
index
a6f9adb53d
.
.
3b0a0b123d
100644
-
-
-
a
/
rtc_base
/
synchronization
/
sequence_checker_internal
.
cc
+
+
+
b
/
rtc_base
/
synchronization
/
sequence_checker_internal
.
cc
-
54
14
+
54
6
void
SequenceCheckerImpl
:
:
Detach
(
)
{
}
#
if
RTC_DCHECK_IS_ON
-
void
SequenceCheckerImpl
:
:
AssignStateFrom
(
const
SequenceCheckerImpl
&
o
)
{
-
MutexLock
this_lock
(
&
lock_
)
;
-
MutexLock
that_lock
(
&
o
.
lock_
)
;
-
attached_
=
o
.
attached_
;
-
valid_thread_
=
o
.
valid_thread_
;
-
valid_queue_
=
o
.
valid_queue_
;
-
}
-
std
:
:
string
SequenceCheckerImpl
:
:
ExpectationToString
(
)
const
{
const
TaskQueueBase
*
const
current_queue
=
TaskQueueBase
:
:
Current
(
)
;
const
PlatformThreadRef
current_thread
=
CurrentThreadRef
(
)
;
-
91
26
+
83
6
std
:
:
string
SequenceCheckerImpl
:
:
ExpectationToString
(
)
const
{
return
message
.
Release
(
)
;
}
-
-
bool
SequenceCheckerImpl
:
:
IsAttachedForTesting
(
)
const
{
-
MutexLock
scoped_lock
(
&
lock_
)
;
-
return
attached_
;
-
}
-
-
bool
SequenceCheckerImpl
:
:
HasSameAttachmentForTesting
(
-
const
SequenceCheckerImpl
&
o
)
const
{
-
MutexLock
scoped_lock_1
(
&
lock_
)
;
-
MutexLock
scoped_lock_2
(
&
o
.
lock_
)
;
-
if
(
attached_
!
=
o
.
attached_
)
{
-
return
false
;
-
}
-
if
(
attached_
&
&
-
(
valid_queue_
!
=
o
.
valid_queue_
|
|
valid_thread_
!
=
o
.
valid_thread_
)
)
{
-
return
false
;
-
}
-
return
true
;
-
}
-
#
endif
/
/
RTC_DCHECK_IS_ON
}
/
/
namespace
webrtc_sequence_checker_internal
diff
-
-
git
a
/
rtc_base
/
synchronization
/
sequence_checker_internal
.
h
b
/
rtc_base
/
synchronization
/
sequence_checker_internal
.
h
index
8094e4445b
.
.
19370706ff
100644
-
-
-
a
/
rtc_base
/
synchronization
/
sequence_checker_internal
.
h
+
+
+
b
/
rtc_base
/
synchronization
/
sequence_checker_internal
.
h
-
41
24
+
41
11
class
RTC_EXPORT
SequenceCheckerImpl
{
/
/
used
exclusively
on
another
thread
.
void
Detach
(
)
;
-
/
/
Makes
the
task
queue
or
thread
that
is
checked
for
in
this
.
IsCurrent
(
)
-
/
/
be
the
same
as
in
o
.
IsCurrent
(
)
.
-
void
AssignStateFrom
(
const
SequenceCheckerImpl
&
o
)
;
-
/
/
Returns
a
string
that
is
formatted
to
match
with
the
error
string
printed
/
/
by
RTC_CHECK
(
)
when
a
condition
is
not
met
.
/
/
This
is
used
in
conjunction
with
the
RTC_DCHECK_RUN_ON
(
)
macro
.
std
:
:
string
ExpectationToString
(
)
const
;
-
/
/
Returns
whether
or
not
the
checker
is
attached
.
-
/
/
Exists
only
in
the
SequenceChecker
that
is
used
when
RTC_DCHECK_IS_ON
-
/
/
is
set
so
tests
using
it
must
check
that
flag
.
-
bool
IsAttachedForTesting
(
)
const
;
-
-
/
/
Returns
true
if
the
two
sequence
checkers
are
either
both
detached
-
/
/
or
attached
to
the
same
thread
.
-
bool
HasSameAttachmentForTesting
(
const
SequenceCheckerImpl
&
o
)
const
;
-
private
:
mutable
Mutex
lock_
;
/
/
These
are
mutable
so
that
IsCurrent
can
set
them
.
-
98
55
+
85
6
ExpectationToString
(
const
ThreadLikeObject
*
)
{
return
std
:
:
string
(
)
;
}
-
class
AutoDetachingSequenceCheckerImpl
:
public
SequenceCheckerImpl
{
-
public
:
-
enum
InitialState
:
bool
{
kDetached
=
false
kAttached
=
true
}
;
-
-
AutoDetachingSequenceCheckerImpl
(
)
:
SequenceCheckerImpl
(
kDetached
)
{
}
-
-
AutoDetachingSequenceCheckerImpl
(
const
AutoDetachingSequenceCheckerImpl
&
o
)
-
:
SequenceCheckerImpl
(
kDetached
)
{
-
AssignStateFrom
(
o
)
;
-
}
-
-
AutoDetachingSequenceCheckerImpl
&
operator
=
(
-
const
AutoDetachingSequenceCheckerImpl
&
o
)
{
-
AssignStateFrom
(
o
)
;
-
return
*
this
;
-
}
-
-
AutoDetachingSequenceCheckerImpl
(
AutoDetachingSequenceCheckerImpl
&
&
o
)
-
:
SequenceCheckerImpl
(
kDetached
)
{
-
o
.
Detach
(
)
;
-
}
-
-
AutoDetachingSequenceCheckerImpl
&
operator
=
(
-
AutoDetachingSequenceCheckerImpl
&
&
o
)
{
-
Detach
(
)
;
-
o
.
Detach
(
)
;
-
return
*
this
;
-
}
-
}
;
-
-
class
AutoDetachingSequenceCheckerDoNothing
{
-
public
:
-
AutoDetachingSequenceCheckerDoNothing
(
)
{
}
-
AutoDetachingSequenceCheckerDoNothing
(
-
const
AutoDetachingSequenceCheckerDoNothing
&
o
)
{
}
-
AutoDetachingSequenceCheckerDoNothing
&
operator
=
(
-
const
AutoDetachingSequenceCheckerDoNothing
&
o
)
{
-
return
*
this
;
-
}
-
AutoDetachingSequenceCheckerDoNothing
(
-
AutoDetachingSequenceCheckerDoNothing
&
&
o
)
{
}
-
AutoDetachingSequenceCheckerDoNothing
&
operator
=
(
-
AutoDetachingSequenceCheckerDoNothing
&
&
o
)
{
-
return
*
this
;
-
}
-
bool
IsCurrent
(
)
const
{
return
true
;
}
-
void
Detach
(
)
{
}
-
}
;
-
}
/
/
namespace
webrtc_sequence_checker_internal
}
/
/
namespace
webrtc
