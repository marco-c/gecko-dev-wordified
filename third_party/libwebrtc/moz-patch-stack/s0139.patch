From
:
Michael
Froman
<
mjfroman
mac
.
com
>
Date
:
Wed
24
Sep
2025
16
:
05
:
38
-
0500
Subject
:
Bug
1990526
-
Cherry
-
pick
upstream
libwebrtc
commit
94f131f284
r
?
ng
Upstream
commit
:
https
:
/
/
webrtc
.
googlesource
.
com
/
src
/
+
/
94f131f284744506d33439de01a3a903a8e31501
Revert
"
Add
test
for
transport
-
cc
messages
when
CCFB
is
in
use
"
This
reverts
commit
32e68fcc6f3752aa0ac3f42f2c2f3729f04529b0
.
Reason
for
revert
:
Reason
for
revert
:
Reverting
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
396640
to
investigate
a
downstream
issue
.
This
CL
depends
on
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
396640
so
to
have
a
clean
revert
let
'
s
revert
this
one
as
well
.
Bug
:
webrtc
:
383078466
Original
change
'
s
description
:
>
Add
test
for
transport
-
cc
messages
when
CCFB
is
in
use
>
>
This
verifies
that
earlier
changes
do
prevent
transport
-
cc
>
messages
from
being
generated
.
>
>
Bug
:
webrtc
:
383078466
>
Change
-
Id
:
I83dd306a8d656ec698d92f6d0a5e3bef7c161a3a
>
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
372220
>
Commit
-
Queue
:
Harald
Alvestrand
<
hta
webrtc
.
org
>
>
Reviewed
-
by
:
Per
Kjellander
<
perkj
webrtc
.
org
>
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
44952
}
Bug
:
webrtc
:
383078466
b
/
425662432
b
/
426394283
Change
-
Id
:
I52743f6015323207b2e0e2926050451cd64c13a5
Reviewed
-
on
:
https
:
/
/
webrtc
-
review
.
googlesource
.
com
/
c
/
src
/
+
/
397781
Reviewed
-
by
:
Per
Kjellander
<
perkj
webrtc
.
org
>
Owners
-
Override
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
Reviewed
-
by
:
Christoffer
Dewerin
<
jansson
webrtc
.
org
>
Bot
-
Commit
:
rubber
-
stamper
appspot
.
gserviceaccount
.
com
<
rubber
-
stamper
appspot
.
gserviceaccount
.
com
>
Commit
-
Queue
:
Mirko
Bonadei
<
mbonadei
webrtc
.
org
>
Cr
-
Commit
-
Position
:
refs
/
heads
/
main
{
#
45002
}
-
-
-
pc
/
congestion_control_integrationtest
.
cc
|
64
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
1
file
changed
64
deletions
(
-
)
diff
-
-
git
a
/
pc
/
congestion_control_integrationtest
.
cc
b
/
pc
/
congestion_control_integrationtest
.
cc
index
da5612d99e
.
.
e5ba493d1a
100644
-
-
-
a
/
pc
/
congestion_control_integrationtest
.
cc
+
+
+
b
/
pc
/
congestion_control_integrationtest
.
cc
-
27
13
+
27
11
namespace
webrtc
{
-
using
:
:
testing
:
:
Contains
;
using
:
:
testing
:
:
Eq
;
using
:
:
testing
:
:
Field
;
using
:
:
testing
:
:
Gt
;
using
:
:
testing
:
:
HasSubstr
;
using
:
:
testing
:
:
IsTrue
;
-
using
:
:
testing
:
:
Ne
;
using
:
:
testing
:
:
Not
;
class
PeerConnectionCongestionControlTest
-
180
66
+
178
4
TEST_F
(
PeerConnectionCongestionControlTest
TransportCcGetsUsed
)
{
EXPECT_THAT
(
pc_internal
-
>
FeedbackAccordingToRfc8888CountForTesting
(
)
Eq
(
0
)
)
;
}
-
TEST_F
(
PeerConnectionCongestionControlTest
CcfbGetsUsedCalleeToCaller
)
{
-
SetFieldTrials
(
"
WebRTC
-
RFC8888CongestionControlFeedback
/
Enabled
/
"
)
;
-
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
-
ConnectFakeSignaling
(
)
;
-
callee
(
)
-
>
AddVideoTrack
(
)
;
-
/
/
Add
transceivers
to
caller
in
order
to
accomodate
reception
-
caller
(
)
-
>
pc
(
)
-
>
AddTransceiver
(
MediaType
:
:
VIDEO
)
;
-
auto
parameters
=
caller
(
)
-
>
pc
(
)
-
>
GetSenders
(
)
[
0
]
-
>
GetParameters
(
)
;
-
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
-
ASSERT_THAT
(
WaitUntil
(
[
&
]
{
return
SignalingStateStable
(
)
;
}
IsTrue
(
)
)
-
IsRtcOk
(
)
)
;
-
-
std
:
:
vector
<
RtpHeaderExtensionCapability
>
negotiated_header_extensions
=
-
caller
(
)
-
>
pc
(
)
-
>
GetTransceivers
(
)
[
0
]
-
>
GetNegotiatedHeaderExtensions
(
)
;
-
EXPECT_THAT
(
-
negotiated_header_extensions
-
Not
(
Contains
(
-
AllOf
(
Field
(
"
uri
"
&
RtpHeaderExtensionCapability
:
:
uri
-
RtpExtension
:
:
kTransportSequenceNumberUri
)
-
Not
(
Field
(
"
direction
"
&
RtpHeaderExtensionCapability
:
:
direction
-
RtpTransceiverDirection
:
:
kStopped
)
)
)
)
)
)
-
<
<
"
in
caller
negotiated
header
extensions
"
;
-
-
parameters
=
caller
(
)
-
>
pc
(
)
-
>
GetSenders
(
)
[
0
]
-
>
GetParameters
(
)
;
-
EXPECT_THAT
(
parameters
.
header_extensions
-
Not
(
Contains
(
Field
(
"
uri
"
&
RtpExtension
:
:
uri
-
RtpExtension
:
:
kTransportSequenceNumberUri
)
)
)
)
-
<
<
"
in
caller
sender
parameters
"
;
-
parameters
=
caller
(
)
-
>
pc
(
)
-
>
GetReceivers
(
)
[
0
]
-
>
GetParameters
(
)
;
-
EXPECT_THAT
(
parameters
.
header_extensions
-
Not
(
Contains
(
Field
(
"
uri
"
&
RtpExtension
:
:
uri
-
RtpExtension
:
:
kTransportSequenceNumberUri
)
)
)
)
-
<
<
"
in
caller
receiver
parameters
"
;
-
-
parameters
=
callee
(
)
-
>
pc
(
)
-
>
GetSenders
(
)
[
0
]
-
>
GetParameters
(
)
;
-
EXPECT_THAT
(
parameters
.
header_extensions
-
Not
(
Contains
(
Field
(
"
uri
"
&
RtpExtension
:
:
uri
-
RtpExtension
:
:
kTransportSequenceNumberUri
)
)
)
)
-
<
<
"
in
callee
sender
parameters
"
;
-
-
parameters
=
callee
(
)
-
>
pc
(
)
-
>
GetReceivers
(
)
[
0
]
-
>
GetParameters
(
)
;
-
EXPECT_THAT
(
parameters
.
header_extensions
-
Not
(
Contains
(
Field
(
"
uri
"
&
RtpExtension
:
:
uri
-
RtpExtension
:
:
kTransportSequenceNumberUri
)
)
)
)
-
<
<
"
in
callee
receiver
parameters
"
;
-
-
MediaExpectations
media_expectations
;
-
media_expectations
.
CallerExpectsSomeVideo
(
)
;
-
ASSERT_TRUE
(
ExpectNewFrames
(
media_expectations
)
)
;
-
auto
pc_internal
=
callee
(
)
-
>
pc_internal
(
)
;
-
EXPECT_THAT
(
-
WaitUntil
(
-
[
&
]
{
-
return
pc_internal
-
>
FeedbackAccordingToRfc8888CountForTesting
(
)
>
2
;
-
}
-
IsTrue
(
)
)
-
IsRtcOk
(
)
)
;
-
/
/
There
should
be
no
transport
-
cc
generated
.
-
EXPECT_THAT
(
pc_internal
-
>
FeedbackAccordingToTransportCcCountForTesting
(
)
-
Eq
(
0
)
)
;
-
}
-
}
/
/
namespace
webrtc
